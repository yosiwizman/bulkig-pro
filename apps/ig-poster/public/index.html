<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BulkIG Pro</title>
  <link rel="icon" href="data:,">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      margin: 0; 
      background: #0b1220; 
      color: #e6e6e6;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    
    /* Main Layout Grid */
    .dashboard {
      display: grid;
      grid-template-rows: 60px 1fr;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 340px 1fr;
      grid-column-gap: 24px;
      padding: 20px;
      height: calc(100vh - 60px);
      overflow: hidden;
      position: relative;
    }
    
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: hidden;
      position: relative;
      z-index: 1;
      min-width: 340px;
    }
    
    .content-area {
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: hidden;
      position: relative;
      z-index: 0;
      contain: layout;
    }
    
    /* Modal System */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    }
    
    .modal-overlay.show {
      display: flex;
    }
    /* Ensure simple modals that use class="modal" become visible when .show is added */
    .modal.show {
      display: flex;
    }
    
    .modal-container {
      background: #121c30;
      border: 1px solid #1e2a44;
      border-radius: 12px;
      width: 90vw;
      height: 85vh;
      max-width: 1400px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #1e2a44;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .modal-close {
      background: #334155;
      color: #e6e6e6;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .modal-close:hover {
      background: #475569;
    }
    
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    
    .modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
    }
    
    /* Compact Cards */
    .compact-list {
      background: #121c30;
      border: 1px solid #1e2a44;
      border-radius: 8px;
      padding: 12px;
      height: fit-content;
      width: 100%;
      box-sizing: border-box;
    }
    
    .compact-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #1e2a44;
    }
    
    .view-all-btn {
      background: transparent;
      color: #93c5fd;
      border: 1px solid #1e2a44;
      padding: 4px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .view-all-btn:hover {
      background: #1e2a44;
      border-color: #2563eb;
    }
    
    .compact-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .compact-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px;
      background: #0f172a;
      border-radius: 6px;
      border: 1px solid #1e2a44;
      transition: all 0.2s;
    }
    
    .compact-item:hover {
      border-color: #334155;
      transform: translateX(2px);
    }
    
    .compact-thumb {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      flex-shrink: 0;
    }
    
    .compact-info {
      flex: 1;
      min-width: 0;
    }
    
    .compact-title {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .compact-meta {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 2px;
    }
    
    .kw-cat { background:#121c30; border:1px solid #1e2a44; border-radius:8px; padding:8px; margin-bottom:8px; }
    .kw-list { display:flex; flex-wrap:wrap; gap:6px; margin: 6px 0; }
    .kw-chip { display:inline-block; padding:4px 8px; border-radius:12px; background:#0f172a; border:1px solid #1e2a44; cursor:pointer; }
    .kw-chip.active { background:#1d4ed8; border-color:#2563eb; }

    /* Timeline & Log styles */
    .timeline { display:flex; gap:4px; padding:8px 4px; align-items:center; border:1px solid #1e2a44; background:#0f172a; border-radius:6px; overflow-x:auto; margin-bottom:8px; }
    .dotlog { width:8px; height:8px; border-radius:50%; display:inline-block; }
    .dotlog.ERROR { background:#ef4444; }
    .dotlog.SUCCESS { background:#22c55e; }
    .dotlog.WARNING { background:#f59e0b; }
    .dotlog.INFO { background:#38bdf8; }

    .loglist { border:1px solid #1e2a44; background:#0f172a; border-radius:6px; padding:8px; max-height:260px; overflow:auto; }
    .logrow { padding:6px 4px; border-bottom:1px dashed #1e2a44; }
    .logrow:last-child { border-bottom:none; }
    .badge { display:inline-block; padding:2px 6px; border-radius:4px; font-size:11px; margin-right:6px; }
    .badge.ERROR { background:#ef4444; color:#fff; }
    .badge.SUCCESS { background:#16a34a; color:#fff; }
    .badge.WARNING { background:#f59e0b; color:#111; }
    .badge.INFO { background:#38bdf8; color:#111; }

    .logstats { display:grid; grid-template-columns: repeat(4, minmax(140px, 1fr)); gap:8px; margin:8px 0; }
    .statcard { background:#121c30; border:1px solid #1e2a44; border-radius:8px; padding:8px; }
    .statlabel { color:#a0aec0; font-size:12px; }
    .statvalue { font-size:18px; font-weight:700; }

    /* Days checkboxes */
    #scDays { display:flex; gap:8px; flex-wrap:wrap; }
    .daybox { display:flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #1e2a44; border-radius:6px; background:#0f172a; }

    /* Health cards */
    .health-cards { display:grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap:8px; }
    .health-card { background:#121c30; border:1px solid #1e2a44; border-radius:8px; padding:8px; }
    .hlabel { color:#a0aec0; font-size:12px; }
    .hvalue { font-size:18px; font-weight:700; }
    .alert-list { display:flex; flex-direction:column; gap:6px; }
    .alert { padding:8px; border-radius:6px; border:1px solid #334155; }
    .alert.CRITICAL { background:#1f2937; border-color:#ef4444; }
    .alert.WARNING { background:#1f2937; border-color:#f59e0b; }

    header { 
      background: #111a2b; 
      padding: 16px 24px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      height: 60px;
      flex-shrink: 0;
      position: relative;
      z-index: 100;
    }
    h1 { margin: 0; font-size: 20px; }
    .cards { 
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
    }
    .card { 
      background: #121c30; 
      border: 1px solid #1e2a44; 
      border-radius: 6px; 
      padding: 8px 12px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      min-height: 36px;
    }
    .big { font-size: 18px; font-weight: 600; line-height: 1; }
    .muted { color: #a0aec0; font-size: 11px; }
    .row { display:flex; gap: 8px; align-items:center; }
    button { background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; }
    button.secondary { background: #334155; }
    button:disabled { opacity: .7; cursor: not-allowed; }
    .list { background:#121c30; border: 1px solid #1e2a44; border-radius:8px; padding:12px; }

    /* Icon-only button for header (settings) */
    .btn-icon {
      background: transparent;
      border: 1px solid #4a5568;
      color: #e2e8f0;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s;
    }
    .btn-icon:hover {
      background: #2d3748;
      border-color: #5a9fd4;
    }
    .item { display:flex; align-items:center; gap: 12px; padding: 8px 0; border-bottom: 1px dashed #1e2a44; }
    .item:last-child { border-bottom: none; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .dot.QUEUED { background:#94a3b8; }
    .dot.SCHEDULED { background:#38bdf8; }
    .dot.PUBLISHING { background:#f59e0b; }
    .dot.PUBLISHED { background:#22c55e; }
    .dot.ERROR { background:#ef4444; }
    img.thumb { width:40px; height:40px; object-fit:cover; border-radius:4px; border:1px solid #1f2937; background:#0f172a; }
    .toolbar { display:flex; gap:8px; }
    .dropzone { border:2px dashed #334155; padding:16px; text-align:center; border-radius:8px; background:#0f172a; color:#94a3b8; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; line-height:1.4; background:#0f172a; border-radius:6px; padding:8px; border:1px solid #1e2a44; }
    #toasts { position: fixed; top: 12px; right: 12px; display:flex; flex-direction:column; gap:8px; z-index: 20000; }
    .toast { padding:8px 12px; border-radius:6px; color:#fff; box-shadow:0 4px 10px rgba(0,0,0,.3); }
    .toast.success { background:#16a34a; }
    .toast.error { background:#dc2626; }
    a { color:#93c5fd; }

    /* Tab panels */
    .tab-panels {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
      position: relative;
    }
    
    .panel {
      display: none;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      padding-right: 10px;
    }
    
    .panel.active {
      display: flex;
    }
    
    .controls {
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      padding-right: 10px;
    }

    /* Calendar styles */
    .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
.cal-day { 
      background:#0f172a; 
      border:1px solid #1e2a44; 
      border-radius:6px; 
      padding:6px; 
      cursor:pointer; 
      min-height:0; 
      height: 100%;
      display:flex; 
      flex-direction:column; 
      position: relative;
      overflow: hidden;
    }
    .cal-outside { opacity: 0.5; background: #0b1220; }
    .cal-day:hover { border-color:#2563eb; }
    .cal-day:hover .cal-hover-overlay { opacity: 1; }
    .cal-day .cal-date { font-size:11px; color:#a0aec0; display:flex; justify-content:space-between; align-items:center; }
    .cal-day .cal-badges { display:flex; gap:4px; flex-wrap:wrap; }
    .cal-badge { background:#334155; color:#e6e6e6; border-radius:10px; padding:1px 6px; font-size:11px; }
    .cal-badge-scheduled { background:#3b82f6; color:#fff; }
    .cal-badge-published { background:#22c55e; color:#fff; }
    .cal-today { outline: 1px solid #2563eb; }
    .cal-items { display:flex; flex-direction:column; gap:4px; margin-top:6px; }
    .cal-item { display:flex; align-items:center; gap:6px; font-size:11px; color:#e6e6e6; }
    .cal-item img { width:16px; height:16px; border-radius:3px; object-fit:cover; border:1px solid #334155; }
    .cal-time { color:#94a3b8; font-size:10px; }
    .st-dot { width:6px; height:6px; border-radius:50%; display:inline-block; }
    .st-scheduled { background:#3b82f6; }
    .st-published { background:#22c55e; }
    .st-publishing { background:#f59e0b; }
    .st-queued { background:#94a3b8; }
    .st-error { background:#ef4444; }
    .cal-more { color:#94a3b8; font-size:10px; }
    .cal-hover-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .cal-add-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #2563eb;
      color: white;
      border: none;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cal-add-btn:hover {
      background: #3b82f6;
    }
.modal { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:12000; }
    .modal-content { background:#121c30; border:1px solid #1e2a44; border-radius:8px; padding:12px; max-width:420px; width:90%; color:#e6e6e6; }
    .modal-content h4 { margin:0 0 8px 0; font-size:16px; }
    .modal-content .times { max-height:240px; overflow:auto; }

    @media (max-width: 980px) {
      .cal-grid { grid-template-columns: repeat(7, minmax(40px, 1fr)); }
      .main-content {
        grid-template-columns: 300px 1fr;
        grid-column-gap: 16px;
        padding: 12px;
      }
      .sidebar {
        min-width: 300px;
      }
    }
    
    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      .sidebar {
        min-width: unset;
        max-height: 40vh;
        overflow-y: auto;
      }
    }
    </style>
    <style>
      /* Reset & layout fixes */
      * { box-sizing: border-box; }
      body { margin: 0; padding: 0; overflow: hidden; }

      /* Header layout */
      .dashboard-header {
        display: flex; align-items: center; gap: 10px;
        padding: 10px 20px; background: #1a1f2e;
        position: fixed; top: 0; left: 0; right: 0; height: 60px; z-index: 1000;
      }
.header-buttons { display: flex; gap: 10px; margin-left: auto; flex-wrap: wrap; align-items: center; transform: translateY(12px); }

      /* Wrapper and sections */
      .dashboard-wrapper { display: flex; height: 100vh; padding-top: 60px; }
      .sidebar { width: 280px; background: #1e2432; overflow-y: auto; padding: 20px; flex-shrink: 0; }
      .main-content { flex: 1; overflow-y: auto; padding: 20px; background: #0f1419; }

      /* Warning below header */
      .low-caption-warning { position: fixed; top: 70px; right: 20px; z-index: 999; background: #ef4444; color: #fff; padding: 10px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); animation: captionWarnIn 220ms ease-out; }
      .low-caption-warning a { color: #fff; text-decoration: underline; }
      .low-caption-close { margin-left: 10px; background: transparent; color: #fff; border: none; cursor: pointer; width: 22px; height: 22px; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; }
      .low-caption-close:hover { background: rgba(255,255,255,0.15); }
      .warning-close { background: none; border: none; color: white; font-size: 20px; cursor: pointer; margin-left: 15px; padding: 0 5px; }
      @keyframes captionWarnIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes captionWarnOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-8px); } }
      .low-caption-warning.fade-out { animation: captionWarnOut 180ms ease-in forwards; }
      
      /* Spinner animation */
      .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid #1e2a44;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        flex-shrink: 0;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Pulse animation for analyze button */
      .analyzing {
        animation: pulse 1.5s ease-in-out infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }

      /* Calendar responsiveness */
      .calendar { max-width: 100%; overflow: hidden; }
      #calGrid { 
        grid-template-columns: repeat(7, minmax(100px, 1fr));
        grid-template-rows: repeat(6, 1fr);
        height: clamp(360px, 48vh, 540px);
      }

      /* Modal sizing */
      .modal-container, .modal-content { max-width: 90vw; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>
  <div class="dashboard">
<header class="dashboard-header">
      <h1 class="dashboard-title">BulkIG Pro</h1>
<div class="toolbar header-buttons">
        <button id="btnAutorun">Autorun: ...</button>
        <button id="btnPlan" class="secondary">Force Plan</button>
        <button id="btnAutopilot" style="background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer;">🚀 Autopilot Settings</button>
        <button id="activityLogBtn" class="secondary">📊 Activity Log</button>
        <button id="btnGenerateDrafts" class="secondary">📝 Generate Caption Drafts</button>
        <button id="btnViewDrafts" class="secondary">📄 View Generated Posts (<span id="draftCount">0</span>)</button>
        <button id="btnRefresh" class="secondary">Refresh</button>
        <button id="settingsBtn" class="btn-icon" onclick="openSettings()" title="Settings">⚙️</button>
        <label class="row"><input id="chkAuto" type="checkbox" style="transform: scale(1.2); margin-right:6px;"> Auto-refresh</label>
      </div>
    </header>
    
    <div class="dashboard-wrapper">
      <!-- Sidebar -->
      <aside class="sidebar">
        <!-- Autopilot Status -->
        <div style="padding: 12px; background: #121c30; border: 2px solid #1e2a44; border-radius: 8px; margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                <span id="autopilotIndicator" style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%; display: inline-block;"></span>
                <span id="autopilotStatus">Autopilot OFF</span>
              </div>
              <div id="autopilotInfo" style="color: #94a3b8; font-size: 12px; margin-top: 4px;">Manual mode</div>
            </div>
            <div style="text-align: right;">
              <div id="autopilotSlots" style="color: #e6e6e6; font-size: 13px; font-weight: 500;">0 slots</div>
              <div id="autopilotCaptions" style="color: #94a3b8; font-size: 11px;">0 captions</div>
            </div>
          </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="cards">
          <div class="card"><span class="muted">Autorun</span><span class="big" id="valAutorun">...</span></div>
          <div class="card"><span class="muted">Queued</span><span class="big" id="valQueued">0</span></div>
          <div class="card"><span class="muted">Scheduled</span><span class="big" id="valScheduled">0</span></div>
          <div class="card"><span class="muted">Publishing</span><span class="big" id="valPublishing">0</span></div>
          <div class="card"><span class="muted">Published</span><span class="big" id="valPublished">0</span></div>
        </div>
        
        <!-- Scheduled Posts (Compact) -->
        <div class="compact-list">
          <div class="compact-header">
            <div style="font-size: 14px; font-weight: 500;">Scheduled Posts</div>
            <button class="view-all-btn" id="btnViewAllScheduled">View All (<span id="scheduledCount">0</span>)</button>
          </div>
          <div class="compact-items" id="scheduledCompact"></div>
        </div>
        
        <!-- Saved Media Link -->
        <div style="margin-top: 12px; padding: 12px; background: #121c30; border: 1px solid #1e2a44; border-radius: 8px;">
          <button id="btnSavedMedia" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 18px;">📁</span>
            <span>Saved Media Library</span>
          </button>
          <button id="btnPostLibrary" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <span style="font-size: 18px;">📚</span>
            <span>Post Library</span>
          </button>
        </div>
        
      </aside>
      <!-- Content Area -->
      <main class="main-content content-area">
        <div class="muted" style="margin-bottom: 8px;">Last plan run: <span id="valLastPlan">-</span></div>
        
        <!-- Tab Navigation -->
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <button id="tabSchedule" class="secondary">⏰ Custom Scheduling</button>
          <button id="tabKeywords" class="secondary">🏷️ Keywords</button>
          <button id="tabHistory" class="secondary">📜 History</button>
          <button id="tabHealth" class="secondary">🩺 Health</button>
        </div>
        
        <!-- Tab Panels -->
        <div class="tab-panels">
          <div class="panel active" id="schedPanel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 0 0 12px 0;">
              <h3 style="margin: 0;">📅 Schedule</h3>
              <div style="display:flex; gap:8px;">
                <button id="btnOpenSchedSettings" class="secondary">⚙️ Schedule Settings</button>
                <button id="btnCreatePost" class="secondary" style="background: #2563eb; border-color: #2563eb;">✨ Create Post</button>
              </div>
            </div>
            <div class="calendar" id="calWrap">
              <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:6px;">
                <div class="row" style="gap:6px;">
                  <button id="btnCalPrev" class="secondary">◀ Prev</button>
                  <button id="btnCalToday" class="secondary">Today</button>
                  <button id="btnCalNext" class="secondary">Next ▶</button>
                </div>
                <div id="calMonth" class="muted">Month YYYY</div>
              </div>
              <div id="calGrid" class="cal-grid"></div>
              <div class="muted" style="margin-top:6px">Click a day to view scheduled/sent posts</div>
            </div>
          </div>

        <div class="panel" id="kwPanel" style="display:none;">
          <h3>🏷️ Keywords & Caption Generator</h3>
          <div id="kwCategories"></div>
          <div style="margin-top:12px;">
            <div class="muted" style="margin-bottom:4px;">Caption Preview</div>
            <div class="row" style="gap:12px; flex-wrap:wrap;">
              <input id="cpFilename" type="text" placeholder="example.mp4 or image.jpg" style="min-width:220px;" />
              <select id="cpMediaType">
                <option value="image">Image</option>
                <option value="video">Video</option>
              </select>
              <button id="btnGenerate" class="secondary">Generate</button>
            </div>
            <div class="muted" style="margin-top:8px">Select keywords from categories below; they will be used in the caption.</div>
            <textarea id="cpOutput" rows="5" style="width:100%; margin-top:8px; background:#0f172a; color:#e6e6e6; border:1px solid #1e2a44; border-radius:6px;"></textarea>
          </div>
        </div>

          <div class="dropzone" id="dropzone" style="margin-top: 12px; position: relative; padding: 20px; text-align: center;">Drag & Drop images here (png, jpg, jpeg, webp, gif, mp4, mov, avi) or click to select</div>
          <input type="file" id="fileInput" accept="image/*,video/*" multiple style="display:none" />

        <div class="panel" id="histPanel" style="display:none; margin-top:16px;">
          <h3>📜 History</h3>
          <div id="histList"></div>
          <div class="row" style="gap:8px; margin-top:8px;">
            <button id="btnHistPrev" class="secondary">Prev</button>
            <span class="muted" id="histPage">Page 1</span>
            <button id="btnHistNext" class="secondary">Next</button>
          </div>
        </div>

        <div class="panel" id="healthPanel" style="display:none; margin-top:16px;">
          <h3>🩺 System Health</h3>
          <div class="row" style="gap:8px; align-items:center; margin-bottom:8px;">
            <button id="btnEnableAlerts" class="secondary">Enable Alerts</button>
            <label class="row"><input id="chkProbeIG" type="checkbox" style="transform: scale(1.2); margin-right:6px;"> Probe IG Connectivity</label>
          </div>
          <div id="healthCards" class="health-cards"></div>
          <div class="list" style="margin-top:8px;">
            <div class="muted" style="margin-bottom:6px;">Alerts</div>
            <div id="healthAlerts" class="alert-list"></div>
          </div>
        </div>

        </div>
      </main>
    </div>
  </div>
  
<!-- Modal Overlays -->
  <!-- Drafts Generation Modal -->
  <div id="draftsModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 520px; width: 90%; height: auto;">
      <div class="modal-header">
        <h2 class="modal-title">📝 Generate Caption Drafts</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; gap: 12px;">
          <div style="background:#0f172a; border:1px solid #1e2a44; border-radius:8px; padding:16px;">
            <h4 style="margin:0 0 12px 0; color:#e6e6e6; font-size:14px; font-weight:500; display:flex; align-items:center; gap:8px;">🌐 Website Analysis</h4>
            <div style="display:flex; gap:8px; margin-bottom:8px;">
              <input type="url" id="referenceUrl" placeholder="https://example.com or any website" style="flex:1; padding: 10px; background: #121c30; color: #e6e6e6; border: 1px solid #334155; border-radius: 6px;">
              <button id="btnAnalyzeUrl" class="secondary" style="white-space:nowrap; min-width:100px;">🔍 Analyze</button>
            </div>
            <div id="analyzeResults" style="display:none; margin-top:12px; padding:12px; background:#121c30; border:1px solid #334155; border-radius:6px;">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                <span id="analyzeSpinner" class="spinner" style="display:none;"></span>
                <span id="analyzeText" style="color:#94a3b8; font-size:13px;"></span>
              </div>
              <div id="analysisDetails" style="display:none;">
                <div style="color:#e6e6e6; font-size:13px; font-weight:500; margin-bottom:4px;">Extracted Content:</div>
                <div id="extractedContent" style="color:#94a3b8; font-size:12px; line-height:1.4;"></div>
              </div>
            </div>
            <div style="color:#64748b; font-size:11px; margin-top:8px;">💡 Analyze any website to extract products, services, and features for better captions</div>
          </div>
          <div>
            <label style=\"display:block; color:#94a3b8; font-size:13px; margin-bottom:6px;\">Keywords (comma-separated)</label>
            <textarea id="draftGenKeywords" placeholder="dogs, cats, pets (comma-separated)" style="width: 100%; min-height: 70px; padding: 10px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;"></textarea>
          </div>
          <div>
            <label style="display:block; color:#94a3b8; font-size:13px; margin-bottom:6px;">Number of captions</label>
            <select id="draftGenCount" style="width: 100%; padding: 10px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
              <option value="5">5 captions</option>
              <option value="10" selected>10 captions</option>
              <option value="20">20 captions</option>
              <option value="50">50 captions</option>
              <option value="100">100 captions</option>
            </select>
          </div>
          <div>
            <label style="display:block; color:#94a3b8; font-size:13px; margin-bottom:6px;">Style</label>
            <select id="draftGenStyle" style="width: 100%; padding: 10px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
              <option value="short">Short</option>
              <option value="medium" selected>Medium</option>
              <option value="long">Long</option>
            </select>
          </div>
          <div style="display:flex; gap:8px;">
            <button id="btnDoGenerateDrafts" style="flex:1; padding: 10px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">Generate</button>
            <button class="secondary" id="btnDraftsCancel" style="flex:1;">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Drafts Manager Modal -->
  <div id="draftsManager" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">📄 Generated Caption Drafts</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="draft-filters" style="display:flex; gap:8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
          <div style="display:flex; gap:8px;">
            <button class="draft-filter-btn active" data-filter="all" style="background:#2563eb; color:white; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">All</button>
            <button class="draft-filter-btn" data-filter="draft" style="background:transparent; color:#94a3b8; border:1px solid #1e2a44; border-radius:6px; padding:6px 10px; cursor:pointer;">Available</button>
            <button class="draft-filter-btn" data-filter="assigned" style="background:transparent; color:#94a3b8; border:1px solid #1e2a44; border-radius:6px; padding:6px 10px; cursor:pointer;">Assigned</button>
            <button class="draft-filter-btn" data-filter="used" style="background:transparent; color:#94a3b8; border:1px solid #1e2a44; border-radius:6px; padding:6px 10px; cursor:pointer;">Used</button>
          </div>
          <div style="margin-left: auto; display:flex; gap:12px; align-items:center;">
            <label class="row" style="gap:6px; align-items:center;">
              <input id="chkDraftsSelectAll" type="checkbox"> Select All
            </label>
            <span class="muted" id="draftsSelectedInfo">0 selected</span>
            <button id="btnDraftsDeleteSel" class="secondary" disabled>Delete Selected</button>
            <span style="color:#94a3b8; font-size:13px;">Created:</span>
            <select id="dateFilter" style="background:#0f172a; color:#e6e6e6; border:1px solid #1e2a44; border-radius:4px; padding:4px 8px; font-size:12px;">
              <option value="all">All time</option>
              <option value="today">Today</option>
              <option value="yesterday">Yesterday</option>
              <option value="week">Last 7 days</option>
              <option value="month">Last 30 days</option>
            </select>
          </div>
        </div>
        <div id="draftsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;"></div>
      </div>
    </div>
  </div>

  <!-- Modal Overlays -->
  <div id="scheduledModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">All Scheduled Posts</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:12px;">
          <label class="row" style="gap:6px;"><input id="chkUpcSelectAll" type="checkbox"> Select All</label>
          <div class="row" style="gap:8px; align-items:center;">
            <span class="muted" id="upcSelectedInfo">0 selected</span>
            <button id="btnUpcRemoveSel" class="secondary" disabled>Remove Selected</button>
          </div>
        </div>
        <div id="upcoming" class="modal-grid"></div>
      </div>
    </div>
  </div>
  
  <div id="logsModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">Activity Log</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:12px;">
          <input id="logSearch" type="text" placeholder="Search logs" style="padding:6px; background:#0f172a; color:#e6e6e6; border:1px solid #1e2a44; border-radius:6px;">
          <div class="row" style="gap:8px;">
            <button id="btnCopyLog" class="secondary">📋 Copy</button>
            <button id="btnDownloadLog" class="secondary">⬇️ JSON</button>
            <button id="btnClearLog" class="secondary">🗑️ Clear</button>
            <select id="logFilter">
              <option value="all">All Events</option>
              <option value="success">Successes Only</option>
              <option value="error">Errors Only</option>
              <option value="warning">Warnings Only</option>
              <option value="info">Info Only</option>
            </select>
          </div>
        </div>
        <div id="logStats" class="logstats"></div>
        <div id="timeline" class="timeline"></div>
        <div id="log" class="loglist"></div>
      </div>
    </div>
  </div>
  
  <!-- Autopilot Settings Modal -->
  <div id="autopilotModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 600px; width: 90%; height: auto;">
      <div class="modal-header">
        <h2 class="modal-title">🚀 Autopilot Settings</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Autopilot Status -->
        <div style="padding: 16px; background: #0f172a; border: 2px solid #1e2a44; border-radius: 8px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">Autopilot Status</div>
              <div id="autopilotStatusText" style="color: #94a3b8; font-size: 14px;">OFF - Manual mode</div>
            </div>
            <button id="btnToggleAutopilot" style="padding: 10px 20px; background: #22c55e; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
              Turn ON
            </button>
          </div>
        </div>
        
        <!-- Posts Per Day -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 8px;">Posts per day</label>
          <select id="autopilotPostsPerDay" style="width: 100%; padding: 10px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
            <option value="1">1 post per day</option>
            <option value="2">2 posts per day</option>
            <option value="3" selected>3 posts per day</option>
            <option value="4">4 posts per day</option>
            <option value="5">5 posts per day</option>
            <option value="6">6 posts per day</option>
            <option value="8">8 posts per day</option>
            <option value="10">10 posts per day</option>
          </select>
        </div>
        
        <!-- Posting Times -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 8px;">Posting times</label>
          <div id="autopilotTimes" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
            <input type="time" value="10:00" class="autopilot-time" style="padding: 8px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
            <input type="time" value="14:00" class="autopilot-time" style="padding: 8px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
            <input type="time" value="18:00" class="autopilot-time" style="padding: 8px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
          </div>
          <button id="btnAddAutopilotTime" style="padding: 6px 12px; background: #1e2a44; color: #94a3b8; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">+ Add Time</button>
        </div>
        
        <!-- Active Days -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 8px;">Active days</label>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: #0f172a; border: 1px solid #1e2a44; border-radius: 6px;">
              <input type="checkbox" class="autopilot-day" data-day="0" checked> Sun
            </label>
            <label style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: #0f172a; border: 1px solid #1e2a44; border-radius: 6px;">
              <input type="checkbox" class="autopilot-day" data-day="1" checked> Mon
            </label>
            <label style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: #0f172a; border: 1px solid #1e2a44; border-radius: 6px;">
              <input type="checkbox" class="autopilot-day" data-day="2" checked> Tue
            </label>
            <label style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: #0f172a; border: 1px solid #1e2a44; border-radius: 6px;">
              <input type="checkbox" class="autopilot-day" data-day="3" checked> Wed
            </label>
            <label style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: #0f172a; border: 1px solid #1e2a44; border-radius: 6px;">
              <input type="checkbox" class="autopilot-day" data-day="4" checked> Thu
            </label>
            <label style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: #0f172a; border: 1px solid #1e2a44; border-radius: 6px;">
              <input type="checkbox" class="autopilot-day" data-day="5" checked> Fri
            </label>
            <label style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: #0f172a; border: 1px solid #1e2a44; border-radius: 6px;">
              <input type="checkbox" class="autopilot-day" data-day="6" checked> Sat
            </label>
          </div>
        </div>
        
        <!-- Caption Settings -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 8px;">Caption style</label>
          <select id="autopilotCaptionStyle" style="width: 100%; padding: 10px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
            <option value="short">Short & Sweet (< 100 chars)</option>
            <option value="medium" selected>Medium (100-200 chars)</option>
            <option value="long">Long & Detailed (200+ chars)</option>
          </select>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 8px;">Generate captions count</label>
          <select id="autopilotCaptionCount" style="width: 100%; padding: 10px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
            <option value="50">50 captions</option>
            <option value="100" selected>100 captions</option>
            <option value="200">200 captions</option>
          </select>
        </div>
        
        <!-- Caption Pool Status -->
        <div style="padding: 12px; background: #121c30; border: 1px solid #1e2a44; border-radius: 6px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="color: #94a3b8; font-size: 13px;">Caption Pool</div>
              <div id="captionPoolStatus" style="color: #e6e6e6; font-weight: 500; margin-top: 4px;">0 / 0 captions available</div>
            </div>
            <button id="btnGenerateCaptions" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
              Generate Captions
            </button>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="display: flex; gap: 12px;">
          <button id="btnSaveAutopilot" style="flex: 1; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">Save Settings</button>
          <button id="btnAutopilotCancel" style="flex: 1; padding: 12px; background: transparent; color: #94a3b8; border: 1px solid #1e2a44; border-radius: 6px; font-weight: 500; cursor: pointer;">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Schedule Modal -->
  <div id="scheduleModal" class="modal">
    <div class="modal-content" style="max-width: 500px; width: 90%;">
      <div class="modal-header">
        <h2 style="margin: 0; font-size: 20px;">⏰ Schedule Post</h2>
        <button class="modal-close" style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer;">&times;</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 8px;">Select Date</label>
          <input type="date" id="scheduleDate" style="width: 100%; padding: 10px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 8px;">Select Time</label>
          <input type="time" id="scheduleTime" style="width: 100%; padding: 10px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
        </div>
        
        <div id="schedulePreview" style="padding: 12px; background: #121c30; border: 1px solid #1e2a44; border-radius: 6px; margin-bottom: 12px;">
          <div style="color: #94a3b8; font-size: 13px;">Scheduled for:</div>
          <div id="schedulePreviewText" style="color: #e6e6e6; font-weight: 500; margin-top: 4px;">--</div>
        </div>

        <!-- Last posted indicator (shown for quick-schedule from library) -->
        <div id="scheduleLastPosted" style="padding: 12px; background: #0b1220; border: 1px dashed #1e2a44; border-radius: 6px; margin-bottom: 20px; display: none;">
          <div style="color: #94a3b8; font-size: 13px;">Last posted:</div>
          <div id="scheduleLastPostedText" style="color: #e6e6e6; font-weight: 500; margin-top: 4px;">Never</div>
        </div>
        
        <div style="display: flex; gap: 12px;">
          <button id="btnConfirmSchedule" style="flex: 1; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">Schedule Post</button>
          <button id="btnScheduleCancel" style="flex: 1; padding: 12px; background: transparent; color: #94a3b8; border: 1px solid #1e2a44; border-radius: 6px; font-weight: 500; cursor: pointer;">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Schedule Settings Modal -->
  <div id="schedSettingsModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 700px; width: 95%;">
      <div class="modal-header">
        <h2 class="modal-title">⚙️ Schedule Settings</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="row" style="margin-bottom:8px; align-items:center; gap:8px;">
          <label class="muted">Mode</label>
          <select id="scMode">
            <option value="times">Specific Times</option>
            <option value="interval">Every N hours</option>
          </select>
        </div>
        <div id="scTimesWrap" style="margin-bottom:12px;">
          <div class="muted" style="margin-bottom:4px">Posting Times</div>
          <div id="scTimes" class="time-slots"></div>
          <button id="btnAddTime" class="secondary">+ Add Time</button>
        </div>
        <div id="scIntervalWrap" style="display:none; margin-bottom:12px;">
          <label class="muted">Interval hours</label>
          <input id="scInterval" type="number" min="1" step="1" value="4" style="width:90px" />
        </div>
        <div style="margin-bottom:12px;">
          <div class="muted" style="margin-bottom:4px">Days to post</div>
          <div id="scDays" class="days"></div>
        </div>
        <div class="row" style="gap:12px; align-items:center; margin-bottom:12px;">
          <label class="row"><input id="scAutoRepost" type="checkbox" style="transform: scale(1.2); margin-right:6px;"> Auto-Repost (after 60 days, max 3)</label>
        </div>
        <div class="row">
          <button id="btnSaveSchedule">Save</button>
          <button id="btnPlanNow" class="secondary">Plan Now</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Video Player Modal -->
  <div id="videoPlayerModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 90%; width: 90%; height: 90vh; background: #000; border-radius: 8px; overflow: hidden;">
      <div class="modal-header" style="background: rgba(0,0,0,0.9); border-bottom: 1px solid #333; padding: 16px; display: flex; justify-content: space-between; align-items: center;">
        <h2 class="modal-title" id="videoPlayerTitle" style="color: white; margin: 0; font-size: 18px;">Video Preview</h2>
        <button class="modal-close" onclick="closeVideoPlayer()" style="color: white; font-size: 24px; background: none; border: none; cursor: pointer; padding: 4px;">&times;</button>
      </div>
      <div class="modal-body" style="padding: 0; height: calc(100% - 60px); display: flex; align-items: center; justify-content: center; background: #000;">
        <video id="videoPlayerElement" controls autoplay style="max-width: 100%; max-height: 100%; width: auto; height: auto;">
          Your browser does not support the video tag.
        </video>
      </div>
    </div>
  </div>
  
  <!-- Image Selector Modal for assigning draft to image -->
  <div id="imageSelectorModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 1000px; width: 95%;">
      <div class="modal-header">
        <h2 class="modal-title">📸 Select Image for Caption</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="imageSelectorGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; max-height: 450px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>

  <!-- Media Picker Modal -->
  <div id="mediaPickerModal" class="modal-overlay" style="z-index: 10500;">
    <div class="modal-container" style="max-width: 1000px; width: 95%;">
      <div class="modal-header">
        <h2 class="modal-title">📁 Choose from Library</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 16px;">
          <input id="mediaPickerSearch" type="text" placeholder="Search media files..." 
                 style="width: 100%; padding: 10px; background: #121c30; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
        </div>
        <div id="mediaPickerGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto; padding: 4px;">
          <!-- Media items for selection will be rendered here -->
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
          <div id="mediaPickerInfo" style="color: #94a3b8; font-size: 13px;">Select a media file</div>
          <div style="display: flex; gap: 8px;">
            <button id="btnMediaPickerCancel" class="secondary">Cancel</button>
            <button id="btnSelectMedia" disabled style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">Select</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Draft Selector Modal (for pairing caption to media) -->
  <div id="draftSelectorModal" class="modal-overlay" style="z-index: 10600;">
    <div class="modal-container" style="max-width: 900px; width: 95%; height: 80vh;">
      <div class="modal-header">
        <h2 class="modal-title">📝 Choose Caption for <span id="draftSelectFilename"></span></h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body" style="display: flex; flex-direction: column; gap: 12px;">
        <input id="draftSearch" type="text" placeholder="Search drafts..." style="padding: 10px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
        <div id="draftSelectGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; overflow-y: auto; flex: 1;"></div>
      </div>
    </div>
  </div>
  
  <!-- Post Preview Modal -->
  <div id="postPreviewModal" class="modal-overlay" style="z-index: 13000;">
    <div class="modal-container" style="max-width: 420px; width: 95%;">
      <div class="modal-header">
        <h2 class="modal-title">👁 Post Preview</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body" style="display:flex; flex-direction:column; gap:16px;">
        <!-- Post Info Section -->
        <div id="postPreviewInfo" style="padding: 12px; background: #0f172a; border: 1px solid #1e2a44; border-radius: 8px;"></div>
        
        <!-- Phone Preview -->
        <div style="display:flex; justify-content:center;">
          <div id="postPreviewPhone" style="background: #000; border-radius: 20px; padding: 20px 16px; max-width: 320px; margin: 0 auto; width:100%;">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
              <div style="width: 32px; height: 32px; background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%); border-radius: 50%;"></div>
              <div>
                <div style="color: white; font-weight: 500; font-size: 14px;">yourbrand</div>
                <div style="color: #8e8e8e; font-size: 12px;">Your Brand</div>
              </div>
            </div>
            <div id="postPreviewMedia" style="background:#1a1a1a; border-radius:4px; aspect-ratio: 1; display:flex; align-items:center; justify-content:center; margin-bottom:12px; color:#555; overflow:hidden;">Media</div>
            <div id="postPreviewCaption" style="color: white; font-size: 13px; line-height: 1.4; max-height: 160px; overflow-y: auto; word-break: break-word;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Post Library Modal -->
  <div id="postLibraryModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 1200px; width: 95%;">
      <div class="modal-header">
        <h2 class="modal-title">📚 Autopilot Post Library</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Filter Buttons -->
        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
          <button class="post-filter-btn active" data-filter="all" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
            All Posts
          </button>
          <button class="post-filter-btn" data-filter="scheduled" style="padding: 8px 16px; background: transparent; color: #94a3b8; border: 1px solid #1e2a44; border-radius: 6px; cursor: pointer;">
            Scheduled
          </button>
          <button class="post-filter-btn" data-filter="published" style="padding: 8px 16px; background: transparent; color: #94a3b8; border: 1px solid #1e2a44; border-radius: 6px; cursor: pointer;">
            Published
          </button>
          <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
            <span id="postLibraryCount" style="color: #94a3b8; font-size: 14px;">0 autopilot posts</span>
            <button id="btnRefreshPostLibrary" style="padding: 6px 12px; background: #1e2a44; color: #94a3b8; border: none; border-radius: 4px; cursor: pointer;">
              🔄 Refresh
            </button>
          </div>
        </div>
        
        <!-- Posts Grid -->
        <div id="postLibraryGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; max-height: 500px; overflow-y: auto; padding: 4px;">
          <!-- Autopilot posts will be rendered here -->
        </div>
        
        <!-- Empty State -->
        <div id="postLibraryEmpty" style="display: none; text-align: center; padding: 60px 20px; color: #94a3b8;">
          <div style="font-size: 48px; margin-bottom: 16px;">📦</div>
          <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">No autopilot posts yet</div>
          <div style="font-size: 14px;">Posts created through autopilot will appear here</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Activity Log Modal (Recent) -->
  <div id="activityLogModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 800px; width: 95%;">
      <div class="modal-header">
        <h2 class="modal-title">📊 Activity Log</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="activityLogContent" class="activity-log-content" style="display:flex; flex-direction:column; gap:8px;"></div>
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
          <button class="secondary" id="btnActivityViewAll">View All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Assign Modal -->
  <div id="bulkAssignModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 1100px; width: 95%;">
      <div class="modal-header">
        <h2 class="modal-title">🗂 Bulk Assign</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="bulkAssignPreview" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; max-height: 500px; overflow-y: auto;"></div>
        <div style="display:flex; justify-content: space-between; align-items:center; margin-top:12px;">
          <div id="bulkAssignInfo" style="color:#94a3b8; font-size:12px;">Mapping selected images to first available drafts...</div>
          <div style="display:flex; gap:8px;">
            <button class="secondary" id="btnReloadBulkMapping">↻ Refresh Mapping</button>
            <button id="btnBulkAssignDo" style="padding:8px 16px; background:#22c55e; color:white; border:none; border-radius:6px; font-weight:500; cursor:pointer;">Assign All</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Saved Media Modal -->
  <div id="savedMediaModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 1200px; width: 95%;">
      <div class="modal-header">
        <h2 class="modal-title">📁 Saved Media Library</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div id="savedMediaInfo" style="color: #94a3b8; font-size: 14px;">Loading...</div>
            <button id="btnUploadToLibrary" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
              📤 Upload New Media
            </button>
            <button id="btnBulkAssignSelected" class="secondary" disabled>🗂 Bulk Assign</button>
          </div>
          <div style="display: flex; gap: 8px;">
            <button id="btnSavedPrev" class="secondary" disabled>Previous</button>
            <span id="savedPageInfo" style="padding: 8px 12px; color: #e6e6e6;">Page 1</span>
            <button id="btnSavedNext" class="secondary">Next</button>
          </div>
        </div>
        
        <!-- Upload drop zone (initially hidden) -->
        <div id="libraryUploadZone" style="display: none; border: 2px dashed #2563eb; border-radius: 8px; padding: 40px; text-align: center; margin-bottom: 20px; background: rgba(37, 99, 235, 0.05); cursor: pointer;">
          <div style="font-size: 48px; margin-bottom: 12px;">📁</div>
          <div style="color: #e6e6e6; font-weight: 500; margin-bottom: 8px;">Drag & Drop files here</div>
          <div style="color: #94a3b8; font-size: 13px;">or click to browse</div>
          <div style="color: #64748b; font-size: 12px; margin-top: 12px;">Supports: JPG, PNG, MP4, MOV (max 100MB each)</div>
          <div id="uploadProgress" style="margin-top: 16px; display: none;">
            <div style="color: #94a3b8; font-size: 13px; margin-bottom: 8px;">Uploading...</div>
            <div style="width: 100%; height: 4px; background: #1e2a44; border-radius: 2px; overflow: hidden;">
              <div id="uploadProgressBar" style="width: 0%; height: 100%; background: #2563eb; transition: width 0.3s;"></div>
            </div>
          </div>
        </div>
        <input type="file" id="libraryFileInput" accept="image/*,video/*" multiple style="display: none;" />
        
        <div id="savedMediaGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; max-height: 500px; overflow-y: auto; padding: 4px;">
          <!-- Media items will be rendered here -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Create Post Modal (3 Panel) -->
  <div id="createPostModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 1400px; width: 95%; height: 90vh;">
      <div class="modal-header">
        <h2 class="modal-title">Create New Post</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body" style="padding: 0; height: calc(100% - 60px); overflow-y: auto; overflow-x: hidden;">
        <div style="display: grid; grid-template-columns: 350px 1fr 380px; height: auto; min-height: 100%;">
          
          <!-- LEFT: Magic Writer -->
          <div style="background: #0f172a; border-right: 1px solid #1e2a44; padding: 24px; overflow: hidden;">
            <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 24px;">✨</span>
              <span>Magic Writer</span>
            </h3>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 13px;">Describe your post</label>
              <textarea id="magicDescription" placeholder="e.g. Reformer machine for professional studios with advanced features..." 
                style="width: 100%; min-height: 120px; padding: 10px; background: #121c30; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px; resize: vertical;"></textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 13px;">Tone & Length</label>
              <select id="magicTone" style="width: 100%; padding: 10px; background: #121c30; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
                <option value="short">Short & Sweet (< 100 chars)</option>
                <option value="medium" selected>Medium (100-200 chars)</option>
                <option value="long">Long & Detailed (200+ chars)</option>
              </select>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 13px;">Additional Keywords (optional)</label>
              <input id="magicKeywords" type="text" placeholder="fitness, wellness, studio" 
                style="width: 100%; padding: 10px; background: #121c30; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;">
            </div>
            
            <button id="btnGenerateMagic" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
              ✨ Generate Caption
            </button>
            
            <div id="magicStats" style="margin-top: 16px; padding: 12px; background: #121c30; border-radius: 6px; display: none;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #94a3b8; font-size: 12px;">Characters:</span>
                <span id="magicCharCount" style="color: #e6e6e6; font-size: 12px;">0</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #94a3b8; font-size: 12px;">Hashtags:</span>
                <span id="magicHashCount" style="color: #e6e6e6; font-size: 12px;">0</span>
              </div>
            </div>
          </div>
          
          <!-- CENTER: Post Editor -->
          <div style="background: #121c30; padding: 16px 20px; overflow: visible; min-height: 0;">
            <!-- Post Type Tabs -->
            <div style="display: flex; gap: 12px; margin-bottom: 20px; border-bottom: 1px solid #1e2a44; padding-bottom: 12px;">
              <button class="post-type-tab active" data-type="post" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">📷 Post</button>
              <button class="post-type-tab" data-type="story" style="padding: 8px 16px; background: transparent; color: #94a3b8; border: 1px solid #1e2a44; border-radius: 4px; cursor: pointer;">📱 Story</button>
              <button class="post-type-tab" data-type="reel" style="padding: 8px 16px; background: transparent; color: #94a3b8; border: 1px solid #1e2a44; border-radius: 4px; cursor: pointer;">🎬 Reel</button>
            </div>
            
            <!-- Caption Editor -->
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label style="color: #94a3b8; font-size: 13px;">Caption</label>
                <span id="captionCounter" style="color: #94a3b8; font-size: 12px;">0 / 2200</span>
              </div>
              <textarea id="postCaption" placeholder="Write your caption here..." 
                style="width: 100%; min-height: 200px; padding: 12px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px; resize: vertical; font-size: 14px; line-height: 1.5;"></textarea>
            </div>

            <!-- Platform Selector -->
            <div class="platform-selector" style="margin-bottom: 16px; padding: 12px; background: #0f172a; border: 1px solid #1e2a44; border-radius: 6px;">
              <h4 style="margin: 0 0 8px 0;">Post to:</h4>
              <div class="platform-options" style="display:flex; gap:16px; align-items:center;">
                <label style="display:flex; align-items:center; gap:6px;">
                  <input type="checkbox" id="postToInstagram" checked>
                  <span>📷 Instagram</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px;">
                  <input type="checkbox" id="postToFacebook">
                  <span>📘 Facebook</span>
                </label>
              </div>
              <div id="facebookPageSelector" style="display:none; margin-top: 8px;">
                <select id="facebookPageSelect" style="background:#0f172a; color:#e6e6e6; border:1px solid #1e2a44; border-radius:6px; padding:6px; min-width: 260px;">
                  <option value="">Select Facebook Page</option>
                </select>
              </div>
            </div>
            <div class="row" style="gap:8px; margin: 8px 0 12px 0; flex-wrap: wrap;">
              <button id="btnClearCaption" class="secondary">🧹 Clear</button>
              <button id="btnQuickRegen" class="secondary">♻ Regenerate</button>
            </div>
            
            <!-- Emoji & Hashtag Toolbar -->
            <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
              <button class="emoji-btn" data-emoji="😍" style="padding: 6px 10px; background: #1e2a44; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">😍</button>
              <button class="emoji-btn" data-emoji="🔥" style="padding: 6px 10px; background: #1e2a44; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">🔥</button>
              <button class="emoji-btn" data-emoji="💪" style="padding: 6px 10px; background: #1e2a44; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">💪</button>
              <button class="emoji-btn" data-emoji="🌟" style="padding: 6px 10px; background: #1e2a44; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">🌟</button>
              <button class="emoji-btn" data-emoji="✨" style="padding: 6px 10px; background: #1e2a44; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">✨</button>
              <button class="emoji-btn" data-emoji="🎯" style="padding: 6px 10px; background: #1e2a44; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">🎯</button>
              <button class="emoji-btn" data-emoji="🚀" style="padding: 6px 10px; background: #1e2a44; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">🚀</button>
              <span style="width: 1px; background: #1e2a44; margin: 0 8px;"></span>
              <button id="btnAddHashtag" style="padding: 6px 12px; background: #1e2a44; color: #94a3b8; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;"># Add Hashtag</button>
              <button id="btnUseDraftInEditor" class="secondary" style="padding: 6px 12px;">📝 Use Draft Caption</button>
            </div>
            
            <!-- Media Upload Zone -->
            <div id="postDropzone" style="border: 2px dashed #1e2a44; border-radius: 8px; padding: clamp(16px, 3vh, 28px); min-height: clamp(160px, 24vh, 280px); text-align: center; cursor: pointer; transition: all 0.3s;">
              <div id="dropzoneContent">
                <div style="font-size: 48px; margin-bottom: 12px;">📸</div>
                <div style="color: #e6e6e6; font-weight: 500; margin-bottom: 8px;">Drag & Drop your media here</div>
                <div style="color: #94a3b8; font-size: 13px; margin-bottom: 8px;">or click to browse</div>
                <button id="btnChooseFromLibrary" type="button" style="margin-top: 12px; padding: 8px 20px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                  📁 Choose from Library
                </button>
                <div style="color: #64748b; font-size: 12px; margin-top: 12px;">Supports: JPG, PNG, MP4, MOV (max 100MB)</div>
              </div>
              <div id="uploadedMedia" style="display: none;">
                <img id="previewImage" style="max-width: 100%; max-height: clamp(220px, 32vh, 400px); border-radius: 6px;" />
                <div style="margin-top: 12px;">
                  <button id="btnRemoveMedia" style="padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
                </div>
              </div>
            </div>
            <input type="file" id="postFileInput" accept="image/*,video/*" style="display: none;" />
          </div>
          
          <!-- RIGHT: Preview -->
          <div style="background: #0f172a; border-left: 1px solid #1e2a44; padding: 20px 24px; overflow: visible;">
            <h3 style="margin: 0 0 20px 0; color: #e6e6e6; font-size: 16px;">Preview</h3>
            
            <!-- Phone Mockup -->
            <div style="background: #000; border-radius: 20px; padding: 20px 16px; max-width: 320px; margin: 0 auto;">
              <!-- Profile Header -->
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 32px; height: 32px; background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%); border-radius: 50%;"></div>
                <div>
                  <div style="color: white; font-weight: 500; font-size: 14px;">yourbrand</div>
                  <div style="color: #8e8e8e; font-size: 12px;">Your Brand</div>
                </div>
              </div>
              
              <!-- Media Preview -->
              <div id="phoneMediaPreview" style="background: #1a1a1a; border-radius: 4px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                <div style="color: #4a4a4a; text-align: center;">
                  <div style="font-size: 48px; margin-bottom: 8px;">📷</div>
                  <div style="font-size: 12px;">No media uploaded</div>
                </div>
              </div>
              
              <!-- Reaction Icons -->
              <div style="display: flex; gap: 16px; margin-bottom: 12px;">
                <span style="color: white; font-size: 20px;">🤍</span>
                <span style="color: white; font-size: 20px;">💬</span>
                <span style="color: white; font-size: 20px;">📤</span>
                <span style="color: white; font-size: 20px; margin-left: auto;">🔖</span>
              </div>
              
              <!-- Caption Preview -->
              <div id="phoneCaptionPreview" style="color: white; font-size: 13px; line-height: 1.4; white-space: pre-wrap;">
                <span style="font-weight: 500;">livepilatesusa</span> Your caption will appear here...
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="position: sticky; bottom: 0; background: #0f172a; padding-top: 12px; margin-top: 16px; display: flex; flex-direction: column; gap: 12px; box-shadow: 0 -8px 12px rgba(0,0,0,0.3);">
              <button id="btnPostNow" style="width: 100%; padding: 14px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 15px;">
                🚀 Post Now
              </button>
              <button id="btnSchedulePost" style="width: 100%; padding: 14px; background: transparent; color: #94a3b8; border: 1px solid #1e2a44; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 15px;">
                ⏰ Schedule for Later
              </button>
            </div>
            
            <div id="postStatus" style="margin-top: 16px; padding: 12px; background: #121c30; border-radius: 6px; display: none;">
              <div id="postStatusMessage" style="color: #94a3b8; font-size: 13px; text-align: center;"></div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
  
  <div id="toasts"></div>

  <!-- License Activation Modal -->
  <div id="licenseModal" class="modal-overlay" style="z-index:20000;">
    <div class="modal-container" style="max-width: 420px; width: 92%;">
      <div class="modal-header">
        <h2 class="modal-title">🔐 Activate BulkIG Pro</h2>
      </div>
      <div class="modal-body">
        <div class="muted" style="margin-bottom:8px;">Enter your email and license key to continue.</div>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <input id="licEmail" type="email" placeholder="you@example.com" style="padding:10px; background:#0f172a; color:#e6e6e6; border:1px solid #1e2a44; border-radius:6px;">
          <input id="licKey" type="text" placeholder="XXXX-XXXX-XXXX-XXXX" style="padding:10px; background:#0f172a; color:#e6e6e6; border:1px solid #1e2a44; border-radius:6px; text-transform:uppercase;">
          <div id="licError" class="muted" style="color:#ef4444; min-height:18px;"></div>
          <button id="btnActivate" style="padding:10px; background:#22c55e; color:#fff; border:none; border-radius:6px; cursor:pointer;">Activate</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay" style="z-index:20010; display:none;">
    <div class="modal-container" style="max-width: 560px; width: 92%;">
      <div class="modal-header">
        <h2 class="modal-title">⚙️ Settings</h2>
        <button class="modal-close" onclick="closeSettings()">×</button>
      </div>
      <div class="modal-body">
        <div class="settings-section" style="margin-bottom:16px;">
          <h3>Instagram Configuration</h3>
          <label>Business Account ID:</label>
          <input type="text" id="igUserId" placeholder="17841465376124483" style="width:100%; padding:8px; background:#0f172a; color:#e6e6e6; border:1px solid #1e2a44; border-radius:6px;">
<label style="margin-top:8px; display:block;">Page Access Token (works for both Instagram & Facebook):</label>
          <div style="position:relative;">
            <textarea id="fbToken" rows="3" placeholder="Paste your Meta token here (or leave empty to keep existing)" style="width:100%; padding:8px; background:#0f172a; color:#e6e6e6; border:1px solid #1e2a44; border-radius:6px;"></textarea>
            <div id="fbTokenStatus" style="position:absolute; top:8px; right:8px; padding:4px 8px; background:#22c55e; color:white; border-radius:4px; font-size:11px; font-weight:500; display:none; pointer-events:none; user-select:none;">✓ Saved</div>
          </div>
          <div id="fbTokenHint" class="muted" style="font-size:11px; margin-top:4px;"></div>
        </div>
        <div class="settings-section" style="margin-bottom:16px;">
          <h3>AI Configuration</h3>
<label>OpenAI API Key:</label>
          <div style="position:relative;">
            <div style="display:flex; gap:8px; align-items:center;">
              <input type="password" id="openaiKey" placeholder="Paste your OpenAI key here (or leave empty to keep existing)" style="flex:1; padding:8px; background:#0f172a; color:#e6e6e6; border:1px solid #1e2a44; border-radius:6px;">
              <button id="btnVerifyOpenAI" class="secondary" title="Verify API key by calling OpenAI">Verify</button>
            </div>
            <div id="openaiKeyStatus" style="position:absolute; top:8px; right:100px; padding:4px 8px; background:#22c55e; color:white; border-radius:4px; font-size:11px; font-weight:500; display:none; pointer-events:none; user-select:none;">✓ Saved</div>
          </div>
          <div id="openaiKeyHint" class="muted" style="font-size:11px; margin-top:4px;"></div>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button class="secondary" onclick="closeSettings()">Cancel</button>
          <button onclick="saveSettings()" style="background:#22c55e; color:#fff; border:none; border-radius:6px; padding:8px 12px;">Save Settings</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Settings helpers
    function openSettings(){ try { (async ()=>{ console.log('[UI][SETTINGS] opening...'); const r = await fetch('/settings?t=' + Date.now(), { cache:'no-store' }); const s = await r.json(); console.log('[UI][SETTINGS] loaded', s); const m = document.getElementById('settingsModal'); const ig = document.getElementById('igUserId'); const fb = document.getElementById('fbToken'); const ai = document.getElementById('openaiKey'); 
      // Set IG User ID (not masked)
      if (ig) ig.value = s.igUserId || ''; 
      // DON'T set masked values in the input fields - keep them empty so user can type new values
      // The fields will only show placeholders, not the masked values
      if (fb) { 
        // Check if it's a masked value (starts with ***)
        if (s.fbToken && s.fbToken.startsWith('***')) {
          // Show asterisks to indicate a saved token exists
          fb.value = '********************************'; 
          fb.placeholder = 'Enter new token to replace existing';
          // Store that this is a placeholder value
          fb.dataset.isPlaceholder = 'true';
        } else if (s.fbToken) {
          fb.value = s.fbToken; // Only set if it's NOT masked
          fb.dataset.isPlaceholder = 'false';
        } else {
          fb.value = '';
          fb.placeholder = 'Paste your Meta token here';
          fb.dataset.isPlaceholder = 'false';
        }
      } 
      if (ai) { 
        // Check if it's a masked value (starts with ***)
        if (s.openaiKey && s.openaiKey.startsWith('***')) {
          // Show asterisks to indicate a saved key exists
          ai.value = '********************************';
          ai.placeholder = 'Enter new key to replace existing';
          // Store that this is a placeholder value
          ai.dataset.isPlaceholder = 'true';
        } else if (s.openaiKey) {
          ai.value = s.openaiKey; // Only set if it's NOT masked
          ai.dataset.isPlaceholder = 'false';
        } else {
          ai.value = '';
          ai.placeholder = 'Paste your OpenAI key here (sk-...)';
          ai.dataset.isPlaceholder = 'false';
        }
      }
      // Show the hints with last 4 digits
      const fbHint = document.getElementById('fbTokenHint'); 
      const aiHint = document.getElementById('openaiKeyHint');
      const fbStatus = document.getElementById('fbTokenStatus');
      const aiStatus = document.getElementById('openaiKeyStatus');
      
      if (fbHint && s && s.meta && s.meta.fbLast4) {
        fbHint.innerHTML = '<span style="color:#22c55e;">✅ Token is saved and active</span> • Ending in <strong>••••' + s.meta.fbLast4 + '</strong>' + (s.meta.fbSource ? ` (from ${s.meta.fbSource})` : '');
        if (fbStatus) { fbStatus.style.display = 'block'; fbStatus.textContent = '✓ Saved'; }
      } else if (fbHint) {
        fbHint.innerHTML = '<span style="color:#ef4444;">⚠️ No token saved yet</span> • Please enter your Meta access token';
        if (fbStatus) fbStatus.style.display = 'none';
      }
      
      if (aiHint && s && s.meta && s.meta.aiLast4) {
        aiHint.innerHTML = '<span style="color:#22c55e;">✅ API key is saved and active</span> • Ending in <strong>••••' + s.meta.aiLast4 + '</strong>' + (s.meta.aiSource ? ` (from ${s.meta.aiSource})` : '');
        if (aiStatus) { aiStatus.style.display = 'block'; aiStatus.textContent = '✓ Saved'; }
      } else if (aiHint) {
        aiHint.innerHTML = '<span style="color:#ef4444;">⚠️ No API key saved yet</span> • Please enter your OpenAI key';
        if (aiStatus) aiStatus.style.display = 'none';
      }
      // Add event handlers to clear asterisks when user clicks to type
      if (fb) {
        fb.addEventListener('focus', function() {
          if (this.dataset.isPlaceholder === 'true') {
            this.value = '';
            this.dataset.isPlaceholder = 'false';
            this.placeholder = 'Paste your new Meta token here';
          }
        });
        fb.addEventListener('blur', function() {
          // If user didn't enter anything, restore the asterisks
          if (this.value === '' && document.getElementById('fbTokenHint')?.textContent?.includes('Token is saved')) {
            this.value = '********************************';
            this.dataset.isPlaceholder = 'true';
            this.placeholder = 'Enter new token to replace existing';
          }
        });
      }
      if (ai) {
        ai.addEventListener('focus', function() {
          if (this.dataset.isPlaceholder === 'true') {
            this.value = '';
            this.dataset.isPlaceholder = 'false';
            this.placeholder = 'Paste your new OpenAI key here';
          }
        });
        ai.addEventListener('blur', function() {
          // If user didn't enter anything, restore the asterisks
          if (this.value === '' && document.getElementById('openaiKeyHint')?.textContent?.includes('API key is saved')) {
            this.value = '********************************';
            this.dataset.isPlaceholder = 'true';
            this.placeholder = 'Enter new key to replace existing';
          }
        });
      }
      if (m) m.style.display='flex'; })(); } catch (e) { console.warn('[UI][SETTINGS] open failed', e); } }
    function closeSettings(){ const m = document.getElementById('settingsModal'); if (m) m.style.display='none'; }
    async function saveSettings(){ try { 
      const igUserId = (document.getElementById('igUserId')||{}).value||''; 
      const fbEl = (document.getElementById('fbToken')||{}); 
      const aiEl = (document.getElementById('openaiKey')||{}); 
      const fbTokenRaw = fbEl.value||''; 
      const openaiKeyRaw = aiEl.value||''; 
      const payload = { igUserId };
      // Only include tokens if user actually entered NEW values
      // Check if the field contains our placeholder asterisks or real new data
      const fbIsPlaceholder = fbEl.dataset?.isPlaceholder === 'true' || /^\*{10,}$/.test(fbTokenRaw);
      const aiIsPlaceholder = aiEl.dataset?.isPlaceholder === 'true' || /^\*{10,}$/.test(openaiKeyRaw);
      
      if (fbTokenRaw && fbTokenRaw.trim() && !fbIsPlaceholder) {
        payload.fbToken = fbTokenRaw.trim();
        console.log('[UI][SETTINGS] Updating FB token (new value entered)');
      } else if (fbIsPlaceholder || !fbTokenRaw || !fbTokenRaw.trim()) {
        console.log('[UI][SETTINGS] FB token field has placeholder or empty - keeping existing');
      }
      
      if (openaiKeyRaw && openaiKeyRaw.trim() && !aiIsPlaceholder) {
        payload.openaiKey = openaiKeyRaw.trim();
        console.log('[UI][SETTINGS] Updating OpenAI key (new value entered)');
      } else if (aiIsPlaceholder || !openaiKeyRaw || !openaiKeyRaw.trim()) {
        console.log('[UI][SETTINGS] OpenAI key field has placeholder or empty - keeping existing');
      }
      console.log('[UI][SETTINGS] saving', { hasIg: !!igUserId, hasFb: !!payload.fbToken, hasAi: !!payload.openaiKey });
      const saveResp = await fetch('/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (!saveResp.ok) throw new Error('Save failed');
      // Refresh hints immediately from server so user sees the new last4
      try { 
        const r2 = await fetch('/settings?t=' + Date.now(), { cache:'no-store' }); 
        const s2 = await r2.json(); 
        const fbHint = document.getElementById('fbTokenHint'); 
        const aiHint = document.getElementById('openaiKeyHint');
        const fbStatus = document.getElementById('fbTokenStatus');
        const aiStatus = document.getElementById('openaiKeyStatus');
        
        if (fbHint) {
          if (s2 && s2.meta && s2.meta.fbLast4) {
            fbHint.innerHTML = '<span style="color:#22c55e;">✅ Token is saved and active</span> • Ending in <strong>••••' + s2.meta.fbLast4 + '</strong>' + (s2.meta.fbSource ? ` (from ${s2.meta.fbSource})` : '');
            if (fbStatus) { fbStatus.style.display = 'block'; fbStatus.textContent = '✓ Saved'; }
          } else {
            fbHint.innerHTML = '<span style="color:#ef4444;">⚠️ No token saved yet</span> • Please enter your Meta access token';
            if (fbStatus) fbStatus.style.display = 'none';
          }
        }
        if (aiHint) {
          if (s2 && s2.meta && s2.meta.aiLast4) {
            aiHint.innerHTML = '<span style="color:#22c55e;">✅ API key is saved and active</span> • Ending in <strong>••••' + s2.meta.aiLast4 + '</strong>' + (s2.meta.aiSource ? ` (from ${s2.meta.aiSource})` : '');
            if (aiStatus) { aiStatus.style.display = 'block'; aiStatus.textContent = '✓ Saved'; }
          } else {
            aiHint.innerHTML = '<span style="color:#ef4444;">⚠️ No API key saved yet</span> • Please enter your OpenAI key';
            if (aiStatus) aiStatus.style.display = 'none';
          }
        }
      } catch {}
      // Clear the input fields after successful save to show they've been processed
      if (payload.fbToken) {
        const fbEl = document.getElementById('fbToken');
        if (fbEl) {
          fbEl.value = '';
          fbEl.placeholder = 'Token saved! Leave empty to keep existing or paste new token to update';
          fbEl.style.borderColor = '#22c55e';
          setTimeout(() => { fbEl.style.borderColor = '#1e2a44'; }, 2000);
        }
      }
      if (payload.openaiKey) {
        const aiEl = document.getElementById('openaiKey');
        if (aiEl) {
          aiEl.value = '';
          aiEl.placeholder = 'Key saved! Leave empty to keep existing or paste new key to update';
          aiEl.style.borderColor = '#22c55e';
          setTimeout(() => { aiEl.style.borderColor = '#1e2a44'; }, 2000);
        }
      }
      
      showToast('success','✅ Settings saved successfully!'); 
      
      // Keep the dialog open for a moment so user can see the success status
      setTimeout(() => { closeSettings(); }, 1500);
    } catch(e){ 
      console.error('[UI][SETTINGS] save failed', e); 
      showToast('error','Save failed: ' + (e && e.message || '')); 
    } }

    // Verify OpenAI key
    async function verifyOpenAI(){
      const btn = document.getElementById('btnVerifyOpenAI');
      const key = (document.getElementById('openaiKey')||{}).value||'';
      if (btn) { btn.disabled = true; btn.textContent = 'Verifying...'; }
      try {
        const r = await fetch('/verify-openai', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ key }) });
        if (!r.ok) {
          const t = await r.json().catch(()=>({error:'failed'}));
          showToast('error', 'OpenAI verify: ' + (t.error || 'failed'));
        } else {
          showToast('success', 'OpenAI key verified');
        }
      } catch(e){ showToast('error','Network error verifying key'); }
      finally { if (btn) { btn.disabled = false; btn.textContent = 'Verify'; } }
    }

    // Modal functions
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('show');
      }
    }
    
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('show');
        
        // Special handling for video player modal to stop audio
        if (modalId === 'videoPlayerModal') {
          const video = document.getElementById('videoPlayerElement');
          if (video) {
            video.pause();
            video.currentTime = 0;
            video.src = '';
            video.load(); // Completely reset the video element
          }
        }
      }
    }
    
    window.openModal = openModal;
    window.closeModal = closeModal;
    
    async function ensureLicense() {
      try {
        const r = await fetch('/license/status');
        const j = await r.json();
        if (!j || j.valid !== true) {
          const modal = document.getElementById('licenseModal');
          if (modal) modal.classList.add('show');
          const btn = document.getElementById('btnActivate');
          const email = document.getElementById('licEmail');
          const key = document.getElementById('licKey');
          const err = document.getElementById('licError');
          if (btn) btn.addEventListener('click', async () => {
            try {
              btn.disabled = true; btn.textContent = '⏳ Verifying...';
              const body = { email: email.value || '', key: key.value || '' };
              const r2 = await fetch('/license/activate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
              if (!r2.ok) {
                const t = await r2.json().catch(()=>({error:'invalid'}));
                if (err) err.textContent = t && t.error ? String(t.error) : 'Activation failed';
              } else {
                if (err) err.textContent = '';
                const modal2 = document.getElementById('licenseModal');
                if (modal2) modal2.classList.remove('show');
                showToast('success', 'License activated');
              }
            } catch (e) {
              if (err) err.textContent = 'Activation error';
            } finally {
              btn.disabled = false; btn.textContent = 'Activate';
            }
          });
        }
      } catch {}
    }

    const els = {
      autorunBtn: document.getElementById('btnAutorun'),
      planBtn: document.getElementById('btnPlan'),
      refreshBtn: document.getElementById('btnRefresh'),
      autorunVal: document.getElementById('valAutorun'),
      queued: document.getElementById('valQueued'),
      scheduled: document.getElementById('valScheduled'),
      publishing: document.getElementById('valPublishing'),
      published: document.getElementById('valPublished'),
      lastPlan: document.getElementById('valLastPlan'),
      upcoming: document.getElementById('upcoming'),
      log: document.getElementById('log'),
      toasts: document.getElementById('toasts'),
      chkAuto: document.getElementById('chkAuto'),
      dropzone: document.getElementById('dropzone'),
      fileInput: document.getElementById('fileInput'),
      scheduledCompact: document.getElementById('scheduledCompact'),
      logCompact: document.getElementById('logCompact'),
      scheduledCount: document.getElementById('scheduledCount'),
      btnViewAllScheduled: document.getElementById('btnViewAllScheduled'),
      btnViewAllLogs: document.getElementById('btnViewAllLogs'),
      // Scheduler + Log UI elements
      scMode: document.getElementById('scMode'),
      scTimesWrap: document.getElementById('scTimesWrap'),
      scTimes: document.getElementById('scTimes'),
      scIntervalWrap: document.getElementById('scIntervalWrap'),
      scInterval: document.getElementById('scInterval'),
      scDays: document.getElementById('scDays'),
      btnAddTime: document.getElementById('btnAddTime'),
      btnSaveSchedule: document.getElementById('btnSaveSchedule'),
      btnPlanNow: document.getElementById('btnPlanNow'),
      scPreview: document.getElementById('scPreview'),
      btnCopyLog: document.getElementById('btnCopyLog'),
      btnClearLog: document.getElementById('btnClearLog'),
      logFilter: document.getElementById('logFilter'),
      timeline: document.getElementById('timeline'),
      scPreviewCount: document.getElementById('scPreviewCount'),
      // Keywords UI
      tabSchedule: document.getElementById('tabSchedule'),
      tabKeywords: document.getElementById('tabKeywords'),
      kwPanel: document.getElementById('kwPanel'),
      kwCategories: document.getElementById('kwCategories'),
      cpFilename: document.getElementById('cpFilename'),
      cpMediaType: document.getElementById('cpMediaType'),
      btnGenerate: document.getElementById('btnGenerate'),
      cpOutput: document.getElementById('cpOutput'),
      // History UI
      tabHistory: document.getElementById('tabHistory'),
      histPanel: document.getElementById('histPanel'),
      histList: document.getElementById('histList'),
      btnHistPrev: document.getElementById('btnHistPrev'),
      btnHistNext: document.getElementById('btnHistNext'),
      histPage: document.getElementById('histPage'),
      scAutoRepost: document.getElementById('scAutoRepost'),
      // Health UI
      tabHealth: document.getElementById('tabHealth'),
      healthPanel: document.getElementById('healthPanel'),
      healthCards: document.getElementById('healthCards'),
      healthAlerts: document.getElementById('healthAlerts'),
      btnEnableAlerts: document.getElementById('btnEnableAlerts'),
      chkProbeIG: document.getElementById('chkProbeIG'),
    };

    function safeVal(el, def='') { try { return (el && typeof el.value !== 'undefined') ? el.value : def; } catch (e) { return def; } }

    async function fetchJSON(url, opts) {
      const r = await fetch(url, opts);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function fmtTime(s) { try { return new Date(s).toLocaleString(); } catch { return s; } }

    function sanitizeCaption(text) {
      try {
        if (!text) return '';
        let out = String(text);
        const patterns = [
          /\b(?:img|vid|pxl|mvimg|dsc|screenshot|photo)\b/gi,
          /\b(?:img|vid|pxl|mvimg|dsc)[-_]?\d+\b/gi,
          /\bwa\d+\b/gi,
          /\b20\d{6,8}\b/gi
        ];
        for (const re of patterns) {
          out = out.replace(re, ' ').replace(/\s{2,}/g, ' ');
        }
        out = out.replace(/\s+,/g, ',').replace(/,\s*,/g, ', ').replace(/\s{2,}/g, ' ');
        return out.trim();
      } catch {
        return text;
      }
    }

    let draftCache = [];
    let draftFilter = 'all';

    async function loadDrafts(status='draft') {
      try {
        const data = await fetchJSON(`/ig/caption-drafts?status=${encodeURIComponent(status)}&t=${Date.now()}`);
        draftCache = data.drafts || [];
        updateDraftCount();
      } catch (e) {
        draftCache = [];
      }
    }

    function updateDraftCount() {
      const available = (draftCache || []).filter(d => d.status === 'draft').length;
      const el = document.getElementById('draftCount');
      if (el) el.textContent = String(available);
      if (available < 5) {
        showLowCaptionWarning();
      }
    }

    async function loadStatus() {
      try {
        const s = await fetchJSON('/ig/status?t=' + Date.now(), { cache: 'no-store' });
        els.autorunVal.textContent = s.autorun ? 'ON' : 'OFF';
        els.autorunBtn.textContent = 'Autorun: ' + (s.autorun ? 'ON' : 'OFF');
        els.queued.textContent = s.counts.QUEUED;
        els.scheduled.textContent = s.counts.SCHEDULED;
        els.publishing.textContent = s.counts.PUBLISHING;
        els.published.textContent = s.counts.PUBLISHED;
        els.lastPlan.textContent = s.lastPlanRun ? fmtTime(s.lastPlanRun) : '-';

        // update upcoming source
        upcAll = (s.next || []);
        renderCompactScheduled();
        renderUpcoming();
        
        // Update count in button
        if (els.scheduledCount) {
          els.scheduledCount.textContent = upcAll.length;
        }
      } catch (e) {
        console.warn('loadStatus failed', e);
      }
    }

    let lastLogTs = '';
    let logsCache = [];
    let upcAll = [];
    let upcPage = 1;
    let upcPageSize = 10;
    let upcSelected = new Set();
    
    // Add references to missing elements
    const btnUpcPrev = document.getElementById('btnUpcPrev');
    const btnUpcNext = document.getElementById('btnUpcNext');
    const upcCounter = document.getElementById('upcCounter');
    
    // Render compact scheduled posts (6 items)
    function renderCompactScheduled() {
      if (!els.scheduledCompact) return;
      els.scheduledCompact.innerHTML = '';
      
      const items = upcAll.slice(0, 6);
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'compact-item';
        
        const img = document.createElement('img');
        img.className = 'compact-thumb';
        img.src = '/media/' + encodeURIComponent(item.filename) + '?t=' + Date.now();
        img.onerror = function() { this.style.display = 'none'; };
        
        const info = document.createElement('div');
        info.className = 'compact-info';
        info.innerHTML = `
          <div class="compact-title">${item.filename}</div>
          <div class="compact-meta">${fmtTime(item.scheduled_at)}</div>
        `;
        
        div.appendChild(img);
        div.appendChild(info);
        els.scheduledCompact.appendChild(div);
      });
      
      if (items.length === 0) {
        els.scheduledCompact.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">No scheduled posts</div>';
      }
    }
    
    // Render compact activity log (3 items)
    function renderCompactLog() {
      if (!els.logCompact) return;
      els.logCompact.innerHTML = '';
      
      const items = logsCache.slice(-3).reverse();
      items.forEach(log => {
        const div = document.createElement('div');
        div.className = 'compact-item';
        
        const cat = (log.category || 'INFO').toUpperCase();
        const badge = document.createElement('span');
        badge.className = `badge ${cat}`;
        badge.textContent = cat[0];
        badge.style.width = '20px';
        badge.style.height = '20px';
        badge.style.borderRadius = '50%';
        badge.style.display = 'flex';
        badge.style.alignItems = 'center';
        badge.style.justifyContent = 'center';
        badge.style.fontSize = '10px';
        badge.style.flexShrink = '0';
        
        const info = document.createElement('div');
        info.className = 'compact-info';
        info.innerHTML = `
          <div class="compact-title">${log.message}</div>
          <div class="compact-meta">${fmtTime(log.ts)}</div>
        `;
        
        div.appendChild(badge);
        div.appendChild(info);
        els.logCompact.appendChild(div);
      });
      
      if (items.length === 0) {
        els.logCompact.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">No activity yet</div>';
      }
    }
    function updateUpcSelectedInfo(total){
      var info = document.getElementById('upcSelectedInfo'); 
      if (info) info.textContent = upcSelected.size + ' selected';
      var btn = document.getElementById('btnUpcRemoveSel'); 
      if (btn) btn.disabled = !(upcSelected && upcSelected.size > 0);
      var selAll = document.getElementById('chkUpcSelectAll'); 
      if (selAll && total){ 
        var grid = document.getElementById('upcoming'); 
        var pageBoxes = grid ? grid.querySelectorAll('input[type="checkbox"].upc-sel') : []; 
        var allChecked = pageBoxes.length > 0;
        pageBoxes.forEach(function(b){ if(!b.checked) allChecked = false; }); 
        selAll.checked = allChecked; 
      }
    }
    
    function renderUpcoming(){
      const total = (upcAll && upcAll.length) ? upcAll.length : 0;
      const pages = total ? Math.ceil(total / upcPageSize) : 1;
      if (upcPage < 1) upcPage = 1; 
      if (upcPage > pages) upcPage = pages;
      const startIdx = (upcPage - 1) * upcPageSize;
      const endIdx = Math.min(total, startIdx + upcPageSize);
      
      // Update pagination controls if they exist
      if (upcCounter) upcCounter.textContent = 'Showing ' + (total ? (startIdx + 1) : 0) + '-' + endIdx + ' of ' + total + ' items';
      if (btnUpcPrev) btnUpcPrev.disabled = (upcPage <= 1);
      if (btnUpcNext) btnUpcNext.disabled = (upcPage >= pages);
      
      els.upcoming.innerHTML = '';
      
      // Render only the current page of items
      (upcAll || []).slice(startIdx, endIdx).forEach(function(item){
        const card = document.createElement('div');
        card.style.background = '#121c30';
        card.style.border = '1px solid #1e2a44';
        card.style.borderRadius = '8px';
        card.style.padding = '12px';
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.gap = '8px';
        
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.alignItems = 'center';
        header.style.gap = '8px';
        
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'upc-sel';
        var key = item.id ? String(item.id) : ('fn:' + item.filename);
        cb.checked = upcSelected.has(key);
        cb.addEventListener('change', function(){
          if (cb.checked) upcSelected.add(key);
          else upcSelected.delete(key);
          updateUpcSelectedInfo(total);
        });
        
        const img = document.createElement('img');
        img.style.width = '100%';
        img.style.height = '150px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '6px';
        img.src = '/media/' + encodeURIComponent(item.filename) + '?t=' + Date.now();
        img.onerror = function() { 
          this.style.display = 'none'; 
          console.warn('Image 404:', this.src); 
        };
        
        const info = document.createElement('div');
        info.innerHTML = `
          <div style="font-weight: 500; font-size: 13px; margin-bottom: 4px;">${item.filename}</div>
          <div class="muted">${fmtTime(item.scheduled_at)}</div>
          <div class="muted"><span class="dot ${item.status}"></span> ${item.status}</div>
        `;
        
        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '6px';
        actions.style.marginTop = '4px';
        
        const btn = document.createElement('button');
        btn.textContent = 'Post Now';
        btn.className = 'secondary';
        btn.style.flex = '1';
        btn.style.padding = '6px';
        btn.style.fontSize = '12px';
        btn.addEventListener('click', async function(){
          try {
            await fetchJSON('/ig/post-now', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ filename: item.filename })
            });
            await loadStatus();
            await loadLogs();
            showToast('success', 'Queued: ' + item.filename);
          } catch(e) {
            showToast('error', 'Failed: ' + e.message);
          }
        });
        
        const rbtn = document.createElement('button');
        rbtn.textContent = 'Remove';
        rbtn.className = 'secondary';
        rbtn.style.flex = '1';
        rbtn.style.padding = '6px';
        rbtn.style.fontSize = '12px';
        rbtn.addEventListener('click', async function(){
          try {
            if (!confirm('Delete ' + item.filename + '?')) return;
            if (!item.id) {
              showToast('error', 'Missing post id');
              return;
            }
            await fetchJSON('/ig/posts/' + encodeURIComponent(item.id), {
              method: 'DELETE'
            });
            await loadStatus();
            await loadLogs();
            showToast('success', 'Removed: ' + item.filename);
          } catch(e) {
            showToast('error', 'Remove failed: ' + e.message);
          }
        });
        
        header.appendChild(cb);
        header.appendChild(info);
        
        actions.appendChild(btn);
        actions.appendChild(rbtn);
        
        card.appendChild(header);
        card.appendChild(img);
        card.appendChild(actions);
        
        els.upcoming.appendChild(card);
      });
      updateUpcSelectedInfo(total);
    }

    function renderTimeline(list) {
      const el = document.getElementById('timeline'); if (!el) return; el.innerHTML='';
      const recent = list.slice(-200);
      recent.forEach(l => {
        const cat = l.category || (l.level==='error'?'ERROR':l.level==='warn'?'WARNING':'INFO');
        const d = document.createElement('span'); d.className = 'dotlog ' + cat;
        d.title = `${fmtTime(l.ts)} ${cat}`;
        el.appendChild(d);
      });
    }

    function renderLogs() {
      const filter = els.logFilter ? els.logFilter.value : 'all';
      const q = (els.logSearch && els.logSearch.value || '').toLowerCase();
      let list = logsCache;
      
      // Filter by category
      if (filter === 'success') list = list.filter(l => (l.category||'').toUpperCase()==='SUCCESS');
      if (filter === 'error') list = list.filter(l => (l.category||'').toUpperCase()==='ERROR');
      if (filter === 'warning') list = list.filter(l => (l.category||'').toUpperCase()==='WARNING');
      if (filter === 'info') list = list.filter(l => (l.category||'').toUpperCase()==='INFO');
      
      // Search
      if (q) list = list.filter(l => (l.message||'').toLowerCase().includes(q) || JSON.stringify(l.data||{}).toLowerCase().includes(q));

      // Grouping: Today, Yesterday, This Week, Older
      let groups = { Today: [], Yesterday: [], 'This Week': [], Older: [] };
      const now = new Date();
      const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const startOfYesterday = new Date(startOfToday.getTime() - 24*3600*1000);
      const startOfWeek = new Date(startOfToday.getTime() - (startOfToday.getDay())*24*3600*1000);

      list.forEach(l => {
        const dt = new Date(l.ts);
        if (dt >= startOfToday) groups.Today.push(l);
        else if (dt >= startOfYesterday) groups.Yesterday.push(l);
        else if (dt >= startOfWeek) groups['This Week'].push(l);
        else groups.Older.push(l);
      });

      if (els.log) {
        els.log.innerHTML = '';
        Object.keys(groups).forEach(label => {
          const arr = groups[label]; 
          if (!arr.length) return;
          const h = document.createElement('div'); 
          h.className = 'muted'; 
          h.style.margin = '6px 0'; 
          h.textContent = label;
          els.log.appendChild(h);
          arr.forEach(l => {
            const row = document.createElement('div'); 
            row.className = 'logrow';
            const cat = (l.category || 'INFO').toUpperCase();
            const head = document.createElement('div');
            head.innerHTML = `<span class="badge ${cat}">${cat}</span> [${fmtTime(l.ts)}] ${l.message}`;
            const details = document.createElement('pre'); 
            details.style.display = 'none'; 
            details.textContent = l.data ? JSON.stringify(l.data, null, 2) : '';
            row.appendChild(head); 
            row.appendChild(details);
            row.addEventListener('click', () => { 
              details.style.display = (details.style.display === 'none' ? 'block' : 'none'); 
            });
            els.log.appendChild(row);
          });
        });
      }
      renderTimeline(list);
      renderStats(list);
      renderCompactLog();
    }

    async function loadLogs() {
      try {
        const logs = await fetchJSON('/ig/logs?limit=500&t=' + Date.now(), { cache: 'no-store' });
        const newest = logs[logs.length - 1]?.ts || '';
        const recent = lastLogTs ? logs.filter(l => l.ts > lastLogTs) : logs;
        recent.forEach(l => {
          const cat = (l.category||'').toUpperCase();
          if (cat === 'SUCCESS') showToast('success', l.message);
          if (cat === 'ERROR') showToast('error', l.message);
        });
        lastLogTs = newest;
        logsCache = logs;
        renderLogs();
      } catch (e) {
        console.warn('loadLogs failed', e);
      }
    }

    els.autorunBtn.addEventListener('click', async () => {
      try {
        els.autorunBtn.disabled = true;
        const s = await fetchJSON('/ig/status');
        const next = !s.autorun;
        await fetchJSON('/ig/autorun', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ enabled: next }) });
        await loadStatus(); await loadLogs();
      } catch (e) { alert('Failed: ' + e.message); } finally { els.autorunBtn.disabled = false; }
    });

    els.planBtn.addEventListener('click', async () => {
      try {
        els.planBtn.disabled = true;
        await fetchJSON('/ig/plan', { method:'POST' });
        await loadStatus(); await loadLogs();
      } catch (e) { alert('Failed: ' + e.message); } finally { els.planBtn.disabled = false; }
    });

    els.refreshBtn.addEventListener('click', async () => { try { calMonthStart = startOfMonth(new Date()); await loadStatus(); await loadLogs(); await loadDrafts(); await loadCalendar(); showToast('success','Refreshed'); } catch(e){ showToast('error','Refresh failed: ' + e.message); } });

    // Log tools
    document.getElementById('btnCopyLog').addEventListener('click', async () => {
      const text = (logsCache || []).map(l => `[${fmtTime(l.ts)}] [${(l.category||l.level).toString().toUpperCase()}] ${l.message}${l.data? ' '+JSON.stringify(l.data):''}`).join('\n');
      try { await navigator.clipboard.writeText(text); showToast('success','Log copied'); } catch(e){ showToast('error','Copy failed'); }
    });
    document.getElementById('btnDownloadLog').addEventListener('click', async () => {
      try {
        const r = await fetch('/ig/logs/export');
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'activity.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showToast('success','Downloaded');
      } catch (e){ showToast('error','Download failed'); }
    });
    document.getElementById('btnClearLog').addEventListener('click', async () => {
      try { await fetchJSON('/ig/logs/clear', { method:'POST' }); logsCache = []; renderLogs(); showToast('success','Log cleared'); } catch(e){ showToast('error','Clear failed: ' + e.message); }
    });
    document.getElementById('logFilter').addEventListener('change', () => renderLogs());
    document.getElementById('logSearch').addEventListener('input', () => renderLogs());
    
    // Modal event listeners
    if (els.btnViewAllScheduled) {
      els.btnViewAllScheduled.addEventListener('click', () => {
        openModal('scheduledModal');
      });
    }

    // Drafts UI listeners
    const btnGenerateDrafts = document.getElementById('btnGenerateDrafts');
    if (btnGenerateDrafts) btnGenerateDrafts.addEventListener('click', async () => { openModal('draftsModal'); });

    const btnDoGenerateDrafts = document.getElementById('btnDoGenerateDrafts');
    if (btnDoGenerateDrafts) btnDoGenerateDrafts.addEventListener('click', async () => {
      try {
        btnDoGenerateDrafts.disabled = true;
        btnDoGenerateDrafts.textContent = '⏳ Generating...';
        const count = Number(document.getElementById('draftGenCount')?.value || 10);
        const style = String(document.getElementById('draftGenStyle')?.value || 'medium');
        const keywords = String(document.getElementById('draftGenKeywords')?.value || '')
          .split(',').map(s => s.trim()).filter(Boolean);
        const url = String(document.getElementById('referenceUrl')?.value || '').trim();
        let urlData = null;
        if (url) {
          try { const r = await fetchJSON('/ig/scrape-url', { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ url }) }); urlData = r || null; } catch {}
        }
        await fetchJSON('/ig/generate-drafts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ count, style, keywords, urlData, products: (window.extractedProducts||{}) })
        });
        await loadDrafts('all');
        closeModal('draftsModal');
        // Jump straight to drafts manager
        draftFilter = 'all';
        renderDraftsGrid();
        setupDraftFilterButtons();
        openModal('draftsManager');
        showToast('success', `Generated ${count} drafts`);
      } catch (e) {
        showToast('error', 'Failed to generate drafts: ' + e.message);
      } finally {
        btnDoGenerateDrafts.disabled = false;
        btnDoGenerateDrafts.textContent = 'Generate';
      }
    });

    // Analyze URL helper/button
    async function analyzeUrl(){
      const referenceUrlInput = document.getElementById('referenceUrl');
      const url = String(referenceUrlInput?.value || '').trim();
      const btn = document.getElementById('btnAnalyzeUrl');
      const resultsEl = document.getElementById('analyzeResults');
      const spinnerEl = document.getElementById('analyzeSpinner');
      const textEl = document.getElementById('analyzeText');
      const detailsEl = document.getElementById('analysisDetails');
      const contentEl = document.getElementById('extractedContent');
      
      if (!url) { 
        showToast('error','Please paste a URL first'); 
        return; 
      }
      
      // Start loading state with animations
      if (btn) { 
        btn.disabled = true; 
        btn.textContent = '🔍 Analyzing...'; 
        btn.classList.add('analyzing');
      }
      if (resultsEl && textEl && spinnerEl) { 
        resultsEl.style.display = 'block';
        spinnerEl.style.display = 'block';
        textEl.textContent = 'Analyzing website content...';
        if (detailsEl) detailsEl.style.display = 'none';
      }
      
      try {
        const data = await fetchJSON('/ig/scrape-url', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ url }) });
        const parsed = (data && data.content) || {};
        window.extractedProducts = parsed;
        const found = [];
        if (Array.isArray(parsed.products) && parsed.products.length) found.push(parsed.products.length + ' products');
        if (Array.isArray(parsed.features) && parsed.features.length) found.push(parsed.features.length + ' features');
        if (Array.isArray(parsed.prices) && parsed.prices.length) found.push(parsed.prices.length + ' prices');
        if (parsed.title) found.push('title');
        
        // Display detailed results
        const details = [];
        if (parsed.title) details.push(`<strong>Title:</strong> ${parsed.title}`);
        if (Array.isArray(parsed.products) && parsed.products.length) {
          details.push(`<strong>Products:</strong> ${parsed.products.slice(0,5).join(', ')}${parsed.products.length > 5 ? '...' : ''}`);
        }
        if (Array.isArray(parsed.features) && parsed.features.length) {
          details.push(`<strong>Features:</strong> ${parsed.features.slice(0,8).join(', ')}${parsed.features.length > 8 ? '...' : ''}`);
        }
        if (Array.isArray(parsed.prices) && parsed.prices.length) {
          details.push(`<strong>Pricing:</strong> ${parsed.prices.slice(0,3).join(', ')}`);
        }
        
        if (contentEl) contentEl.innerHTML = details.join('<br>') || 'No structured content found';
        if (detailsEl) detailsEl.style.display = details.length ? 'block' : 'none';
        
        // Suggest keywords from products
        let addedKeywords = 0;
        try {
          const kwEl = document.getElementById('draftGenKeywords');
          if (kwEl) {
            const existing = kwEl.value ? kwEl.value + ', ' : '';
            const tags = (parsed.products||[]).slice(0,5)
              .map(p => String(p).replace(/[^a-z0-9 ]/gi,'').trim())
              .filter(Boolean)
              .map(p => p.split(/\s+/).slice(0,2).join('').toLowerCase())
              .filter(t => t.length >= 3);
            if (tags.length > 0) {
              kwEl.value = existing + tags.join(', ');
              addedKeywords = tags.length;
              // Brief flash to show keywords were added
              kwEl.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
              setTimeout(() => { kwEl.style.backgroundColor = '#0f172a'; }, 1000);
            }
          }
        } catch {}
        
        const msg = `✅ Found: ${found.join(', ') || 'no structured content'}${addedKeywords ? ` • Added ${addedKeywords} keywords` : ''}`;
        if (textEl) textEl.textContent = msg;
        if (spinnerEl) spinnerEl.style.display = 'none';
        showToast('success', msg.replace('✅ ', ''));
      } catch (e) { 
        const emsg = '❌ Analysis failed' + (e && e.message ? ': ' + e.message : '');
        if (textEl) textEl.textContent = emsg;
        if (spinnerEl) spinnerEl.style.display = 'none';
        if (detailsEl) detailsEl.style.display = 'none';
        showToast('error', emsg.replace('❌ ', ''));
      } finally {
        if (btn) { 
          btn.disabled = false; 
          btn.textContent = '🔍 Analyze'; 
          btn.classList.remove('analyzing');
        }
      }
    }
    
    // Attach analyze button event listener
    document.getElementById('btnAnalyzeUrl')?.addEventListener('click', analyzeUrl);
    document.getElementById('btnVerifyOpenAI')?.addEventListener('click', verifyOpenAI);
    
    const btnViewDrafts = document.getElementById('btnViewDrafts');
    if (btnViewDrafts) btnViewDrafts.addEventListener('click', async () => {
      await loadDrafts('all');
      draftFilter = 'all';
      renderDraftsGrid();
      setupDraftFilterButtons();
      openModal('draftsManager');
    });

    let selectedDraftsSet = new Set();
    let lastRenderedDraftIds = [];

    function renderDraftsGrid() {
      const root = document.getElementById('draftsGrid'); if (!root) return; root.innerHTML = '';
      
      // Apply status filter
      let list = (draftCache || []).filter(d => draftFilter === 'all' ? true : d.status === draftFilter);
      
      // Apply date filter
      const dateFilter = document.getElementById('dateFilter')?.value || 'all';
      if (dateFilter !== 'all') {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today.getTime() - 24*60*60*1000);
        const weekAgo = new Date(today.getTime() - 7*24*60*60*1000);
        const monthAgo = new Date(today.getTime() - 30*24*60*60*1000);
        
        list = list.filter(d => {
          const createdAt = new Date(d.createdAt);
          switch(dateFilter) {
            case 'today': return createdAt >= today;
            case 'yesterday': return createdAt >= yesterday && createdAt < today;
            case 'week': return createdAt >= weekAgo;
            case 'month': return createdAt >= monthAgo;
            default: return true;
          }
        });
      }
      
      if (!list || list.length === 0) {
        const label = draftFilter === 'draft' ? 'available' : draftFilter;
        const dateLabel = dateFilter !== 'all' ? ` from ${dateFilter === 'today' ? 'today' : dateFilter === 'yesterday' ? 'yesterday' : dateFilter === 'week' ? 'last 7 days' : dateFilter === 'month' ? 'last 30 days' : dateFilter}` : '';
        root.innerHTML = `<div class="muted" style="text-align:center; padding: 20px;">No ${label} drafts${dateLabel}.</div>`;
        return;
      }
      lastRenderedDraftIds = list.map(d => d.id);
      list.forEach((draft, index) => {
        const card = document.createElement('div');
        card.style.cssText = 'background:#121c30; border:1px solid #1e2a44; border-radius:8px; padding:12px; display:flex; flex-direction:column; gap:8px;';
        card.dataset.id = draft.id;
        card.innerHTML = `
          <div style=\"display:flex; justify-content:space-between; align-items:center;\">
            <label style=\"display:flex; align-items:center; gap:6px;\"><input type=\"checkbox\" class=\"chkDraftSel\" data-id=\"${draft.id}\" ${selectedDraftsSet.has(draft.id)?'checked':''}> <span class=\"muted\" style=\"font-size:12px;\">Select</span></label>
            <div class=\"draft-number\" style=\"color:#94a3b8; font-size:12px;\">#${index + 1} · <span style=\"text-transform:capitalize\">${draft.style}</span> · <span class=\"badge ${draft.status.toUpperCase()}\">${draft.status}</span></div>
            <div class=\"muted\" style=\"font-size:11px;\">${new Date(draft.createdAt).toLocaleString()}</div>
          </div>
          <textarea class=\"draft-text\" style=\"width:100%; min-height:140px; padding:8px; background:#0f172a; color:#e6e6e6; border:1px solid #1e2a44; border-radius:6px; resize:vertical;\">${draft.text}</textarea>
          <div class=\"draft-actions\" style=\"display:flex; gap:8px; flex-wrap: wrap;\">
            <button class=\"btnSaveDraft\" data-id=\"${draft.id}\" style=\"flex:1;\">💾 Save</button>
            <button class=\"btnAssignDraft secondary\" data-id=\"${draft.id}\" style=\"flex:1;\" title=\"${draft.status!=='draft' ? 'Currently assigned — click to reassign' : ''}\">📸 Assign to Image</button>
            <button class=\"btnPreviewDraft secondary\" data-id=\"${draft.id}\" style=\"flex:1;\">👁 Preview</button>
            <button class=\"btnDeleteDraft secondary\" data-id=\"${draft.id}\" style=\"flex:1;\">🗑️ Delete</button>
            <button class=\"btnOpenPreview secondary\" data-id=\"${draft.id}\" style=\"flex:1;\">📱 Open Preview</button>
          </div>
        `;
        root.appendChild(card);
      });

      // Wire up actions
      root.querySelectorAll('.btnSaveDraft').forEach(btn => {
        btn.addEventListener('click', async () => {
          try {
            const id = btn.getAttribute('data-id');
            const card = btn.closest('[data-id]');
            const text = card.querySelector('.draft-text').value;
            await fetchJSON('/ig/caption-drafts/' + encodeURIComponent(id), {
              method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text })
            });
            showToast('success', 'Draft saved');
            await loadDrafts('all');
            renderDraftsGrid();
          } catch (e) { showToast('error', 'Save failed: ' + e.message); }
        });
      });

      root.querySelectorAll('.btnAssignDraft').forEach(btn => {
        btn.addEventListener('click', async () => {
          try {
            const draftId = btn.getAttribute('data-id');
            // Open selector directly. Server will validate availability.
            openImageSelectorForDraft(draftId);
          } catch (e) { showToast('error', 'Open image selector failed: ' + e.message); }
        });
      });

      root.querySelectorAll('.btnPreviewDraft').forEach(btn => {
        btn.addEventListener('click', () => {
          try {
            const id = btn.getAttribute('data-id') || '';
            const card = btn.closest('[data-id]');
            const ta = card ? card.querySelector('.draft-text') : null;
            const text = ta && 'value' in ta ? ta.value : ((draftCache || []).find(d => d.id === id)?.text || '');
            openPostPreview('', text);
          } catch(e){ showToast('error','Preview failed: '+e.message); }
        });
      });

      // Open phone-style preview alongside drafts modal
      root.querySelectorAll('.btnOpenPreview').forEach(btn => {
        btn.addEventListener('click', () => {
          try {
            const id = btn.getAttribute('data-id') || '';
            const card = btn.closest('[data-id]');
            const ta = card ? card.querySelector('.draft-text') : null;
            const text = ta && 'value' in ta ? ta.value : ((draftCache || []).find(d => d.id === id)?.text || '');
            openPostPreview('', text);
          } catch(e){ showToast('error','Preview failed: '+e.message); }
        });
      });

      root.querySelectorAll('.chkDraftSel').forEach(chk => {
        chk.addEventListener('change', () => {
          const id = chk.getAttribute('data-id');
          if (chk.checked) selectedDraftsSet.add(id); else selectedDraftsSet.delete(id);
          updateDraftsBulkUI();
        });
      });

      root.querySelectorAll('.btnDeleteDraft').forEach(btn => {
        btn.addEventListener('click', async () => {
          try {
            const id = btn.getAttribute('data-id');
            if (!confirm('Delete this draft?')) return;
            await fetchJSON('/ig/caption-drafts/' + encodeURIComponent(id), { method: 'DELETE' });
            showToast('success', 'Draft deleted');
            await loadDrafts('all');
            renderDraftsGrid();
          } catch (e) { showToast('error', 'Delete failed: ' + e.message); }
        });
      });
    }

    function setupDraftFilterButtons() {
      const buttons = document.querySelectorAll('.draft-filter-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = btn.getAttribute('data-filter');
          draftFilter = filter || 'all';
          // Toggle active styles
          buttons.forEach(function(b){
            b.classList.remove('active');
            if (b && b.style) {
              b.style.background = 'transparent';
              b.style.color = '#94a3b8';
              b.style.border = '1px solid #1e2a44';
            }
          });
          btn.classList.add('active');
          if (btn && btn.style) {
            btn.style.background = '#2563eb';
            btn.style.color = 'white';
            btn.style.border = 'none';
          }
          renderDraftsGrid();
        });
      });
      
      // Date filter listener
      const dateFilterEl = document.getElementById('dateFilter');
      if (dateFilterEl) {
        dateFilterEl.addEventListener('change', renderDraftsGrid);
      }
    }

    
    // Select all checkbox handler
    const chkSelectAll = document.getElementById('chkUpcSelectAll');
    if (chkSelectAll) {
      chkSelectAll.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#upcoming .upc-sel');
        checkboxes.forEach(cb => {
          cb.checked = chkSelectAll.checked;
          // The key is already stored when the checkbox was created
          // We'll trigger the onchange event to handle selection
          cb.dispatchEvent(new Event('change'));
        });
        updateUpcSelectedInfo(upcAll.length);
      });
    }

    function updateDraftsBulkUI(){
      const info = document.getElementById('draftsSelectedInfo');
      const btn = document.getElementById('btnDraftsDeleteSel');
      const chkAll = document.getElementById('chkDraftsSelectAll');
      if (info) info.textContent = `${selectedDraftsSet.size} selected`;
      if (btn) btn.disabled = selectedDraftsSet.size === 0;
      if (chkAll) {
        // Set checked if all currently rendered are selected
        const allSelected = lastRenderedDraftIds.length > 0 && lastRenderedDraftIds.every(id => selectedDraftsSet.has(id));
        chkAll.checked = allSelected;
      }
    }

    document.getElementById('chkDraftsSelectAll')?.addEventListener('change', (e) => {
      const checked = e.target.checked;
      if (checked) lastRenderedDraftIds.forEach(id => selectedDraftsSet.add(id));
      else lastRenderedDraftIds.forEach(id => selectedDraftsSet.delete(id));
      // Re-render to reflect checkbox states
      renderDraftsGrid();
      updateDraftsBulkUI();
    });

    document.getElementById('btnDraftsDeleteSel')?.addEventListener('click', async () => {
      try {
        if (selectedDraftsSet.size === 0) return;
        if (!confirm(`Delete ${selectedDraftsSet.size} selected drafts?`)) return;
        const ids = Array.from(selectedDraftsSet);
        await fetchJSON('/ig/caption-drafts/bulk-delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids }) });
        selectedDraftsSet.clear();
        await loadDrafts('all');
        renderDraftsGrid();
        updateDraftsBulkUI();
        showToast('success', 'Deleted selected drafts');
      } catch(e){ showToast('error', 'Bulk delete failed: ' + e.message); }
    });
    
    // Remove selected handler
    const btnRemoveSel = document.getElementById('btnUpcRemoveSel');
    if (btnRemoveSel) {
      btnRemoveSel.addEventListener('click', async () => {
        if (upcSelected.size === 0) return;
        if (!confirm(`Remove ${upcSelected.size} selected items?`)) return;
        
        try {
          for (const key of upcSelected) {
            const id = key.startsWith('fn:') ? null : key;
            if (id) {
              await fetchJSON('/ig/posts/' + encodeURIComponent(id), { method: 'DELETE' });
            }
          }
          upcSelected.clear();
          await loadStatus();
          await loadLogs();
          showToast('success', 'Removed selected items');
        } catch(e) {
          showToast('error', 'Failed to remove: ' + e.message);
        }
      });
    }

    let timer = setInterval(async () => {
      if (els.chkAuto && els.chkAuto.checked) {
        try {
          await loadStatus();
          await loadLogs();
          await loadHealth();
          await loadDrafts();
        } catch (e) {
          console.warn('Auto-refresh error', e);
        }
      }
    }, 30000);

    // Scheduler UI
    function setModeUI(mode){
      if (els.scMode) els.scMode.value = mode;
      document.getElementById('scTimesWrap').style.display = (mode === 'times') ? 'block' : 'none';
      document.getElementById('scIntervalWrap').style.display = (mode === 'interval') ? 'block' : 'none';
    }

    function addTimeSlot(value){
      const row = document.createElement('div'); row.className = 'time-row';
      const input = document.createElement('input'); input.type='time'; input.value = value || '09:00';
      const del = document.createElement('button'); del.className='secondary'; del.textContent='×'; del.addEventListener('click', ()=> row.remove());
      row.appendChild(input); row.appendChild(del); document.getElementById('scTimes').appendChild(row);
    }

    function renderTimeSlots(times){
      document.getElementById('scTimes').innerHTML = '';
      (times && times.length ? times : []).forEach((t)=> addTimeSlot(t));
      if (!times || !times.length) addTimeSlot('09:00');
    }

    function renderDays(days){
      var cont = document.getElementById('scDays'); if (!cont) return; cont.innerHTML = '';
      var labels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      var ids = ['sun','mon','tue','wed','thu','fri','sat'];
      for (var i=0;i<7;i++){
        var lab = document.createElement('label'); lab.className = 'daybox';
        var cb = document.createElement('input'); cb.type = 'checkbox'; cb.id = 'day-' + ids[i]; cb.dataset.idx = String(i);
        // default all checked if days not provided; otherwise check if present
        cb.checked = !days || days.indexOf(i) >= 0;
        var txt = document.createElement('span'); txt.textContent = labels[i];
        lab.appendChild(cb); lab.appendChild(txt);
        cont.appendChild(lab);
      }
    }

    function collectConfig(){
      const mode = els.scMode ? els.scMode.value : 'times';
      var daysNodes = (document.getElementById('scDays')||document.body).querySelectorAll('input[type="checkbox"][data-idx]');
      const days = Array.from(daysNodes).filter(function(el){ return !!el.checked; }).map(function(el){ return Number(el.dataset.idx); });
      const times = Array.from((document.getElementById('scTimes')||document.body).querySelectorAll('input[type=\"time\"]')).map(function(i){ return i.value; }).filter(Boolean);
      const intEl = document.getElementById('scInterval');
      const intervalHours = Number((intEl && intEl.value) ? intEl.value : 4);
      const autoRepostEnabled = !!(els.scAutoRepost && els.scAutoRepost.checked);
      return { mode, days, times, intervalHours, autoRepostEnabled };
    }

    async function loadSchedule(){
      const cfg = await fetchJSON('/ig/schedule-config');
      setModeUI((cfg && cfg.mode) ? cfg.mode : 'times');
      var intEl2 = document.getElementById('scInterval'); if (intEl2) intEl2.value = String((cfg && cfg.intervalHours) ? cfg.intervalHours : 4);
      renderTimeSlots(cfg.times||[]);
      renderDays(cfg.days||[0,1,2,3,4,5,6]);
      if (els.scAutoRepost) els.scAutoRepost.checked = !!(cfg && cfg.autoRepostEnabled);
      await loadCalendar();
    }

    async function saveSchedule(){
      const payload = collectConfig();
      await fetchJSON('/ig/schedule-config', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      showToast('success','Schedule saved');
      await loadCalendar();
    }

    // Calendar preview (month view)
    let calMonthStart = null; // First day of the visible month
    let calTimes = [];
    let calRenderVersion = 0; // guard to avoid duplicate rendering
    let isLoadingCalendar = false;

    function startOfWeek(d){ var x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); x.setHours(0,0,0,0); var day=x.getDay(); x.setDate(x.getDate()-day); return x; }
    function startOfMonth(d){ var x=new Date(d.getFullYear(), d.getMonth(), 1); x.setHours(0,0,0,0); return x; }
    function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

    async function loadCalendar(){
      if (isLoadingCalendar) return; // debounce overlapping loads
      isLoadingCalendar = true;
      try {
        var data = await fetchJSON('/ig/schedule-preview?count=90&t='+Date.now(), { cache:'no-store' });
        calTimes = (data||[]).map(function(s){ return new Date(s); });
        if (!calMonthStart) calMonthStart = startOfMonth(new Date());
        // Load all posts to get thumbnails/state (optional for other views)
        try {
          const state = await fetchJSON('/ig/status');
          calendarPosts = state.posts || [];
        } catch(e) {
          calendarPosts = [];
        }
        
        await renderCalendar();
      } finally {
        isLoadingCalendar = false;
      }
    }
    
    let calendarPosts = [];

    async function renderCalendar(){
      const myVer = ++calRenderVersion; // version for this render
      var monthLbl = document.getElementById('calMonth');
      var grid = document.getElementById('calGrid'); if (!grid) return;
      // Calculate dates to render: 6 weeks grid for the current month
      if (!calMonthStart) calMonthStart = startOfMonth(new Date());
      var firstCell = startOfWeek(calMonthStart);
      var dates = [];
      for (var i=0;i<42;i++){ var d=new Date(firstCell.getTime()); d.setDate(d.getDate()+i); dates.push(d); }
      var mid = new Date(calMonthStart.getFullYear(), calMonthStart.getMonth(), 15);
      if (monthLbl) monthLbl.textContent = mid.toLocaleString(undefined, { month:'long', year:'numeric' });

      // Helper: format date as local YYYY-MM-DD (avoid UTC offset issues)
      const localDateStr = (dd) => {
        const y = dd.getFullYear();
        const m = String(dd.getMonth() + 1).padStart(2, '0');
        const d2 = String(dd.getDate()).padStart(2, '0');
        return `${y}-${m}-${d2}`;
      };
      // Fetch all 42 days concurrently
      const results = await Promise.all(dates.map(async (d)=>{
        const dayStr = localDateStr(d);
        try {
          const r = await fetchJSON(`/ig/posts/by-day/${dayStr}`);
          return (r && r.posts) ? r.posts : [];
        } catch {
          return [];
        }
      }));

      if (myVer !== calRenderVersion) return; // abort outdated renders

      var today = new Date(); today.setHours(0,0,0,0);
      const frag = document.createDocumentFragment();

      dates.forEach((d, idx) => {
        const dayPosts = results[idx] || [];
        var cell = document.createElement('div');
        cell.className = 'cal-day' + (d.getMonth() !== calMonthStart.getMonth() ? ' cal-outside' : '');
        if (sameDay(d,today)) cell.classList.add('cal-today');
        
        // Date header
        var top = document.createElement('div');
        top.className='cal-date';
        var dateNum = d.getDate();
        top.innerHTML = '<span></span><span>'+dateNum+'</span>';
        
        // Badges for scheduled and published
        var badges = document.createElement('div');
        badges.className='cal-badges';
        const scheduledCount = dayPosts.filter(p => (p.status||'').toUpperCase()==='SCHEDULED').length;
        const publishedCount = dayPosts.filter(p => (p.status||'').toUpperCase()==='PUBLISHED').length;
        if (scheduledCount>0){ const b=document.createElement('span'); b.className='cal-badge cal-badge-scheduled'; b.textContent='S '+scheduledCount; badges.appendChild(b); }
        if (publishedCount>0){ const b=document.createElement('span'); b.className='cal-badge cal-badge-published'; b.textContent='P '+publishedCount; badges.appendChild(b); }

        // Items list
        const list = document.createElement('div');
        list.className = 'cal-items';
        
        // Sort by time of scheduled or published
        const postsSorted = [...dayPosts].sort((a,b)=>{
          const aTs = Date.parse(a.published_at||a.scheduled_at||'')||0;
          const bTs = Date.parse(b.published_at||b.scheduled_at||'')||0;
          return aTs - bTs;
        });
        const maxItems = 7;
        postsSorted.slice(0,maxItems).forEach(p=>{
          const row = document.createElement('div'); row.className='cal-item';
          const img = document.createElement('img'); img.src=`/media/${encodeURIComponent(p.filename||'')}`; img.onerror=function(){ this.style.display='none'; };
          const time = document.createElement('span'); time.className='cal-time';
          const ts = new Date(p.published_at||p.scheduled_at||d); time.textContent = ts.toTimeString().slice(0,5);
          const dot = document.createElement('span'); dot.className='st-dot ' + (String(p.status||'').toUpperCase()==='PUBLISHED' ? 'st-published' : String(p.status||'').toUpperCase()==='SCHEDULED' ? 'st-scheduled' : String(p.status||'').toUpperCase()==='PUBLISHING' ? 'st-publishing' : String(p.status||'').toUpperCase()==='QUEUED' ? 'st-queued' : 'st-error');
          row.appendChild(img); row.appendChild(time); row.appendChild(dot);
          list.appendChild(row);
        });
        if (postsSorted.length>maxItems){ const more=document.createElement('div'); more.className='cal-more'; more.textContent = '+'+(postsSorted.length-maxItems)+' more'; list.appendChild(more); }

        // Hover overlay with + button
        var overlay = document.createElement('div');
        overlay.className = 'cal-hover-overlay';
        var addBtn = document.createElement('button');
        addBtn.className = 'cal-add-btn';
        addBtn.innerHTML = '+';
        addBtn.addEventListener('click', function(e){ e.stopPropagation(); openCreatePostWithDate(d); });
        overlay.appendChild(addBtn);

        cell.appendChild(top);
        if (badges.childNodes.length) cell.appendChild(badges);
        cell.appendChild(list);
        cell.appendChild(overlay);
        cell.addEventListener('click', function(){ openDayPopup(d, dayPosts); });
        frag.appendChild(cell);
      });

      if (myVer !== calRenderVersion) return; // ensure newest
      grid.replaceChildren(frag);
    }
    
    function openCreatePostWithDate(date) {
      // Store the selected date (local yyyy-mm-dd)
      const local = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
      window.preselectedDate = local;
      
      // Open Create Post modal
      openModal('createPostModal');
      
      // Update schedule button to use this date
      const btnSchedulePost = document.getElementById('btnSchedulePost');
      if (btnSchedulePost) {
        btnSchedulePost.textContent = `⏰ Schedule for ${date.toLocaleDateString()}`;
      }
    }

    async function openDayPopup(day, events){
      // Fetch actual posts for this day (local yyyy-mm-dd)
      const dayStr = `${day.getFullYear()}-${String(day.getMonth()+1).padStart(2,'0')}-${String(day.getDate()).padStart(2,'0')}`;
      let dayPosts = [];
      try {
        const response = await fetchJSON(`/ig/posts/by-day/${dayStr}`);
        dayPosts = response.posts || [];
      } catch (e) {
        console.error('Failed to load day posts:', e);
      }
      
      var modal = document.getElementById('calModal');
      if (!modal){
        modal = document.createElement('div'); 
        modal.id='calModal'; 
        modal.className='modal';
        document.body.appendChild(modal);
        modal.addEventListener('click', function(e){ 
          if (e.target===modal) modal.style.display='none'; 
        });
      }
      
      // Build modal content with enhanced UI
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; width: 90%;">
          <h4 id="calModalTitle" style="margin-bottom: 16px;">${day.toLocaleDateString(undefined, { weekday:'long', month:'long', day:'numeric', year:'numeric' })}</h4>
          <div id="calModalPosts" style="max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
            ${dayPosts.length === 0 ? '<div class="muted" style="text-align: center; padding: 20px;">No scheduled posts for this day</div>' : ''}
          </div>
          <div class="row" style="justify-content:space-between; margin-top:8px;">
            <button id="btnCalUpdate" class="primary" style="display: ${dayPosts.length > 0 ? 'block' : 'none'};">Update Schedule</button>
            <button id="btnCalClose" class="secondary">Close</button>
          </div>
        </div>
      `;
      
      const postsContainer = document.getElementById('calModalPosts');
      const pendingUpdates = new Map();
      
      // Clear container and add section headers
      if (postsContainer) postsContainer.innerHTML = '';
      const schedHeader = document.createElement('div'); schedHeader.className='muted'; schedHeader.style.margin='0 0 6px 0'; schedHeader.textContent = 'Scheduled Posts';
      const pubHeader = document.createElement('div'); pubHeader.className='muted'; pubHeader.style.margin='10px 0 6px 0'; pubHeader.textContent = 'Published (read-only)';
      if (postsContainer) postsContainer.appendChild(schedHeader);
      
      // Render each post with inline controls (SCHEDULED only)
      const editablePosts = (dayPosts || []).filter(p => String(p.status||'').toUpperCase() === 'SCHEDULED');
      editablePosts.forEach(post => {
        const postTime = new Date(post.scheduled_at);
        const timeStr = postTime.toTimeString().slice(0, 5); // HH:MM format
        
        const postRow = document.createElement('div');
        postRow.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 8px; background: #121c30; border: 1px solid #1e2a44; border-radius: 6px; margin-bottom: 8px;';
        postRow.dataset.postId = post.id;
        
        // Thumbnail
        const thumb = document.createElement('img');
        thumb.src = `/media/${encodeURIComponent(post.filename)}?t=${Date.now()}`;
        thumb.style.cssText = 'width: 40px; height: 40px; object-fit: cover; border-radius: 4px;';
        thumb.onerror = function() { 
          this.style.display = 'none'; 
        };
        
        // Info
        const info = document.createElement('div');
        info.style.cssText = 'flex: 1; min-width: 0;';
        info.innerHTML = `
          <div style="font-weight: 500; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${post.filename}</div>
          <div class="muted" style="font-size: 12px;">${post.is_repost ? '🔁 Repost' : ''} ${post.repost_count > 0 ? `(${post.repost_count} reposts)` : ''}</div>
        `;
        
        // Time editor
        const timeInput = document.createElement('input');
        timeInput.type = 'time';
        timeInput.value = timeStr;
        timeInput.style.cssText = 'padding: 4px 8px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 4px;';
        timeInput.onchange = function() {
          const [hours, minutes] = this.value.split(':').map(Number);
          const newDate = new Date(day);
          newDate.setHours(hours, minutes, 0, 0);
          pendingUpdates.set(post.id, newDate.toISOString());
        };

        // Preview button
        const previewBtn = document.createElement('button');
        previewBtn.textContent = 'Preview';
        previewBtn.className = 'secondary';
        previewBtn.style.cssText = 'padding: 4px 8px;';
        previewBtn.addEventListener('click', async function(){
          const cap = await fetchCaptionForFile(post.filename);
          openPostPreview(post.filename, cap);
        });
        
        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.textContent = '×';
        removeBtn.className = 'secondary';
        removeBtn.style.cssText = 'padding: 4px 8px; min-width: 30px;';
        removeBtn.addEventListener('click', async function(){
          if (!confirm(`Remove ${post.filename} from schedule?`)) return;
          try {
            await fetchJSON(`/ig/posts/${encodeURIComponent(post.id)}`, { method: 'DELETE' });
            postRow.remove();
            showToast('success', 'Post removed');
            await loadStatus();
            await loadCalendar();
          } catch (e) {
            showToast('error', 'Failed to remove: ' + e.message);
          }
        });
        
        postRow.appendChild(thumb);
        postRow.appendChild(info);
        postRow.appendChild(timeInput);
        postRow.appendChild(previewBtn);
        postRow.appendChild(removeBtn);
        postsContainer.appendChild(postRow);
      });
      
      // Published read-only list with thumbnails
      const publishedPosts = (dayPosts || []).filter(p => String(p.status||'').toUpperCase() === 'PUBLISHED');
      if (postsContainer) postsContainer.appendChild(pubHeader);
      publishedPosts.forEach(post => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex; align-items:center; gap:12px; padding:8px; background:#0f172a; border:1px solid #1e2a44; border-radius:6px; margin-bottom:8px; opacity:.9;';
        const thumb = document.createElement('img');
        thumb.src = `/media/${encodeURIComponent(post.filename)}?t=${Date.now()}`;
        thumb.style.cssText = 'width: 40px; height: 40px; object-fit: cover; border-radius: 4px;';
        thumb.onerror = function(){ this.style.display='none'; };
        const info = document.createElement('div');
        info.style.cssText = 'flex:1; min-width:0;';
        const ts = post.published_at ? new Date(post.published_at) : (post.scheduled_at ? new Date(post.scheduled_at) : new Date());
        info.innerHTML = `<div style=\"font-weight: 500; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\">${post.filename}</div><div class=\"muted\" style=\"font-size: 12px;\">${ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
        // Preview button
        const previewBtn = document.createElement('button');
        previewBtn.textContent = 'Preview';
        previewBtn.className = 'secondary';
        previewBtn.style.cssText = 'padding: 4px 8px;';
        previewBtn.addEventListener('click', async function(){
          const cap = await fetchCaptionForFile(post.filename);
          openPostPreview(post.filename, cap);
        });
        row.appendChild(thumb);
        row.appendChild(info);
        row.appendChild(previewBtn);
        if (postsContainer) postsContainer.appendChild(row);
      });
      
      // Update button handler
      const updateBtn = document.getElementById('btnCalUpdate');
        if (updateBtn) {
          // Hide button if no scheduled items on this day
          if (!editablePosts.length) updateBtn.style.display = 'none';
          updateBtn.addEventListener('click', async function(){
            if (pendingUpdates.size === 0) {
              showToast('info', 'No changes to save');
              return;
            }
            const updates = Array.from(pendingUpdates.entries()).map(([id, scheduled_at]) => ({ id, scheduled_at }));
            try {
              await fetchJSON('/ig/posts/batch-reschedule', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ updates }) });
              showToast('success', `Updated ${updates.length} posts`);
              modal.style.display = 'none';
              await loadStatus();
              await loadCalendar();
            } catch (e) {
              showToast('error', 'Failed to update: ' + e.message);
            }
          });
        }
      
      // Close button
      const closeBtn = document.getElementById('btnCalClose');
      if (closeBtn) {
        closeBtn.addEventListener('click', function(){ modal.style.display = 'none'; });
      }
      
      modal.style.display = 'flex';
    }

    var scModeEl = document.getElementById('scMode'); if (scModeEl) scModeEl.addEventListener('change', ()=> setModeUI(els.scMode && els.scMode.value || 'times'));
    document.getElementById('btnAddTime').addEventListener('click', ()=> addTimeSlot('13:00'));
    document.getElementById('btnSaveSchedule').addEventListener('click', ()=> saveSchedule().catch(e=> showToast('error','Save failed: '+e.message)));
    document.getElementById('btnPlanNow').addEventListener('click', async ()=> { try { await fetchJSON('/ig/plan', { method:'POST' }); await loadStatus(); await loadLogs(); showToast('success','Planned'); } catch(e){ showToast('error','Plan failed: '+e.message); } });
    // Calendar controls
  var btnCalPrev = document.getElementById('btnCalPrev'); if (btnCalPrev) btnCalPrev.addEventListener('click', function(){ if (!calMonthStart) calMonthStart=startOfMonth(new Date()); calMonthStart.setMonth(calMonthStart.getMonth()-1); renderCalendar(); });
  var btnCalNext = document.getElementById('btnCalNext'); if (btnCalNext) btnCalNext.addEventListener('click', function(){ if (!calMonthStart) calMonthStart=startOfMonth(new Date()); calMonthStart.setMonth(calMonthStart.getMonth()+1); renderCalendar(); });
  var btnCalToday = document.getElementById('btnCalToday'); if (btnCalToday) btnCalToday.addEventListener('click', function(){ calMonthStart=startOfMonth(new Date()); renderCalendar(); });
    if (btnUpcPrev) btnUpcPrev.addEventListener('click', function(){ upcPage = Math.max(1, upcPage-1); renderUpcoming(); });
    if (btnUpcNext) btnUpcNext.addEventListener('click', function(){ upcPage = upcPage+1; renderUpcoming(); });
    var btnUpcRemoveSel = document.getElementById('btnUpcRemoveSel'); if (btnUpcRemoveSel) btnUpcRemoveSel.addEventListener('click', async function(){
      var total = upcSelected ? upcSelected.size : 0; if (!total) return;
      if (!confirm('Remove '+ total +' selected item(s)? This cannot be undone.')) return;
      // Map keys back to ids
      const all = upcAll || [];
      for (const k of Array.from(upcSelected)){
        let id = null;
        if (String(k).startsWith('fn:')){ const fn = String(k).slice(3); const hit = all.find(function(it){ return it.filename===fn; }); id = hit && hit.id; }
        else { id = k; }
        if (id){ try { await fetchJSON('/ig/posts/'+encodeURIComponent(String(id)), { method:'DELETE' }); } catch(e){} }
      }
      upcSelected.clear();
      await loadStatus(); await loadLogs();
      updateUpcSelectedInfo((upcAll && upcAll.length)||0);
    });
    var chkUpcSelectAll = document.getElementById('chkUpcSelectAll'); if (chkUpcSelectAll) chkUpcSelectAll.addEventListener('change', function(){
      var grid = document.getElementById('upcoming'); var pageBoxes = grid ? grid.querySelectorAll('input[type="checkbox"].upc-sel') : [];
      var total = (upcAll && upcAll.length) || 0;
      pageBoxes.forEach(function(b){ var keyEl = (b.parentElement && b.parentElement.querySelector('img.thumb')) ? b.parentElement.querySelector('img.thumb') : null; var fn = keyEl ? keyEl.getAttribute('src') : null; });
      pageBoxes.forEach(function(b){ var row = b.parentElement; var fnameEl = row ? row.querySelector('div > strong') : null; var fname = fnameEl ? fnameEl.textContent : null; var key = null; var entry = (upcAll||[]).find(function(it){ return it.filename===fname; }); key = entry && entry.id ? String(entry.id) : ('fn:'+fname); if (chkUpcSelectAll.checked){ b.checked=true; if (key) upcSelected.add(key); } else { b.checked=false; if (key) upcSelected.delete(key); } });
      updateUpcSelectedInfo(total);
    });

    // Health
    function renderHealth(h){
      const c = els.healthCards; if (!c) return; c.innerHTML='';
      const cards = [];
      cards.push({ label:'Uptime', value: (h.server && h.server.uptimeSec!=null) ? (Math.floor(h.server.uptimeSec/3600)+'h '+Math.floor((h.server.uptimeSec%3600)/60)+'m') : '-' });
      cards.push({ label:'Queue depth', value: (h.scheduler && h.scheduler.counts) ? String(h.scheduler.counts.QUEUED) : '-' });
      cards.push({ label:'Posts/hr (24h)', value: (h.logs && h.logs.postsPerHour != null ? String(h.logs.postsPerHour) : '-') });
      cards.push({ label:'Success rate (24h)', value: (h.logs && h.logs.successRate24h != null ? (h.logs.successRate24h+'%') : '-') });
      cards.push({ label:'Memory (heap used)', value: (h.memory ? (h.memory.heapUsedMB+' MB') : '-') });
      cards.push({ label:'Disk free', value: (h.fs && h.fs.disk && h.fs.disk.freeMB != null ? (h.fs.disk.freeMB+' MB') : '-') });
      cards.push({ label:'IG API', value: ((h.ig_api && h.ig_api.status) || '-') });
      cards.forEach(function(k){ var d=document.createElement('div'); d.className='health-card'; d.innerHTML='<div class=\'hlabel\'>'+k.label+'</div><div class=\'hvalue\'>'+k.value+'</div>'; c.appendChild(d); });
      const a = els.healthAlerts; if (a) { a.innerHTML=''; (h.alerts||[]).forEach((al)=>{ const d=document.createElement('div'); d.className='alert '+al.severity; d.textContent = `[${al.severity}] ${al.message}`; a.appendChild(d); if (al.severity==='CRITICAL') notifyCritical(al.message); }); }
    }

    async function loadHealth(){
      try {
        const probe = (els.chkProbeIG && els.chkProbeIG.checked) ? '1' : '0';
        const h = await fetchJSON('/ig/health/detailed?probe='+probe+'&t='+Date.now(), { cache:'no-store' });
        renderHealth(h);
      } catch(e){ /* silent */ }
    }

    function notifyCritical(msg){
      try {
        if (!('Notification' in window)) return;
        if (Notification.permission === 'granted') new Notification('BulkIG Critical Alert', { body: msg });
      } catch {}
    }

    if (els.btnEnableAlerts) els.btnEnableAlerts.addEventListener('click', ()=>{ try { if ('Notification' in window) Notification.requestPermission(); } catch {} });
    
    // Tab switching
    function switchTab(panelId) {
      ['schedPanel', 'kwPanel', 'histPanel', 'healthPanel'].forEach(id => {
        const panel = document.getElementById(id);
        if (panel) {
          panel.classList.remove('active');
        }
      });
      const activePanel = document.getElementById(panelId);
      if (activePanel) {
        activePanel.classList.add('active');
      }
    }
    
    if (els.tabSchedule) els.tabSchedule.onclick = () => switchTab('schedPanel');
    if (els.tabKeywords) els.tabKeywords.onclick = () => switchTab('kwPanel');
    if (els.tabHistory) els.tabHistory.onclick = () => { 
      switchTab('histPanel');
      loadHistory(); 
    };
    if (els.tabHealth) els.tabHealth.onclick = () => { 
      switchTab('healthPanel');
      loadHealth(); 
    };

    function renderStats(list){
      const el = document.getElementById('logStats'); if (!el) return;
      // compute last 24h successes and errors
      const now = Date.now();
      const dayAgo = now - 24*3600*1000;
      let succ=0, err=0;
      const perHour = Array(24).fill(0);
      list.forEach(l => {
        const t = Date.parse(l.ts); if (isNaN(t) || t < dayAgo) return;
        const cat = (l.category||'').toUpperCase();
        if (cat==='SUCCESS') { succ++; const h = new Date(t).getHours(); perHour[h] = (perHour[h]||0)+1; }
        if (cat==='ERROR') err++;
      });
      const total = succ + err;
      const rate = total ? Math.round((succ/total)*100) : 0;
      // simple sparkline-like string for error trend across last 7 days
      const days = Array(7).fill(0);
      list.forEach(l => {
        const dt = new Date(l.ts);
        const dIdx = Math.floor((now - dt.getTime())/(24*3600*1000));
        if (dIdx>=0 && dIdx<7 && (l.category||'').toUpperCase()==='ERROR') days[6-dIdx]++;
      });
      const bars = days.map(n => '▮'.repeat(Math.min(5, n)) || '·').join(' ');
      const pph = Math.round((succ)/24 * 10)/10;
      el.innerHTML = '';
      const cards = [];
      cards.push({ label:'Posts/hr (24h)', value: String(pph) });
      cards.push({ label:'Success rate (24h)', value: rate + '%' });
      cards.push({ label:'Success (24h)', value: String(succ) });
      cards.push({ label:'Errors (24h)', value: String(err) });
      cards.forEach(function(c){
        const d = document.createElement('div'); d.className='statcard';
        d.innerHTML = '<div class=\'statlabel\'>'+c.label+'</div><div class=\'statvalue\'>'+c.value+'</div>';
        el.appendChild(d);
      });
      // error trend row
      const trend = document.createElement('div'); trend.className='statcard'; trend.style.gridColumn = '1 / -1';
      trend.innerHTML = `<div class='statlabel'>Error trend (7d)</div><div class='statvalue'>${bars}</div>`;
      el.appendChild(trend);
    }

    function uploadFiles(files) {
      (async () => {
        for (const f of files) {
          const fd = new FormData(); 
          fd.append('file', f, f.name);
          const response = await fetchJSON('/ig/upload', { method: 'POST', body: fd });
          
          if (response.autoScheduled) {
            showToast('success', `🚀 Auto-scheduled: ${f.name} for ${new Date(response.scheduledFor).toLocaleString()}`);
          } else {
            showToast('success', `Uploaded: ${f.name}`);
          }
        }
        await loadStatus(); 
        await loadLogs();
        await loadCalendar();
      })().catch(e => showToast('error', 'Upload failed: ' + e.message));
    }

    els.dropzone.addEventListener('click', () => els.fileInput.click());
    els.fileInput.addEventListener('change', (e) => uploadFiles(e.target.files));

    els.dropzone.addEventListener('dragover', (e) => { e.preventDefault(); els.dropzone.style.borderColor = '#60a5fa'; });
    els.dropzone.addEventListener('dragleave', (e) => { e.preventDefault(); els.dropzone.style.borderColor = '#334155'; });
    els.dropzone.addEventListener('drop', (e) => {
      e.preventDefault(); els.dropzone.style.borderColor = '#334155';
      const files = e.dataTransfer.files; if (files && files.length) uploadFiles(files);
    });

    // Keywords logic
    let kwState = { categories: {} };

    function renderKeywords() {
      const root = els.kwCategories; if (!root) return;
      root.innerHTML = '';
      const cats = kwState.categories || {};
      Object.keys(cats).forEach(cat => {
        const wrap = document.createElement('div');
        wrap.className = 'kw-cat';
        const title = document.createElement('div');
        title.innerHTML = `<strong>${cat}</strong>`;
        const list = document.createElement('div');
        list.className = 'kw-list';
        (cats[cat] || []).forEach(k => {
          const chip = document.createElement('span');
          chip.className = 'kw-chip';
          chip.textContent = k;
          chip.title = 'Click to select/deselect';
          chip.dataset.keyword = k;
          chip.dataset.category = cat;
          chip.addEventListener('click', () => chip.classList.toggle('active'));
          // removable X
          const x = document.createElement('button');
          x.textContent = '×'; x.className='secondary'; x.style.marginLeft='6px'; x.addEventListener('click', async (e)=>{
            e.stopPropagation();
            try {
              await fetchJSON('/ig/keywords', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ category: cat, action:'remove', keyword:k }) });
              await loadKeywords();
            } catch (e){ showToast('error','Remove failed'); }
          });
          const chipWrap = document.createElement('span'); chipWrap.appendChild(chip); chipWrap.appendChild(x); chipWrap.style.marginRight='6px';
          list.appendChild(chipWrap);
        });
        const addRow = document.createElement('div');
        addRow.className = 'row';
        const inp = document.createElement('input'); inp.placeholder = 'Add keyword (with or without #)';
        const btn = document.createElement('button'); btn.textContent = '+ Add'; btn.className='secondary';
        btn.addEventListener('click', async () => {
          const v = String(inp.value || '').trim(); if (!v) return; inp.disabled=true; btn.disabled=true;
          try { await fetchJSON('/ig/keywords', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ category: cat, action:'add', keyword: v }) }); inp.value=''; await loadKeywords(); }
          catch(e){ showToast('error','Add failed: ' + e.message); }
          finally { inp.disabled=false; btn.disabled=false; }
        });
        addRow.appendChild(inp); addRow.appendChild(btn);
        wrap.appendChild(title); wrap.appendChild(list); wrap.appendChild(addRow);
        root.appendChild(wrap);
      });
    }

    async function loadKeywords() {
      kwState = await fetchJSON('/ig/keywords?t=' + Date.now(), { cache:'no-store' });
      renderKeywords();
    }

    function selectedKeywordsFromUI(){
      const chips = (els.kwCategories || document.body).querySelectorAll('.kw-chip.active');
      return Array.from(chips).map(function(c){ return String((c && c.dataset && c.dataset.keyword) || ''); }).filter(Boolean);
    }

    if (els.btnGenerate) els.btnGenerate.addEventListener('click', async ()=>{
      try {
        const filename = (els.cpFilename && els.cpFilename.value) ? els.cpFilename.value : 'sample.jpg';
        const mediaType = (els.cpMediaType && els.cpMediaType.value) ? els.cpMediaType.value : 'image';
        const keywords = selectedKeywordsFromUI();
        const out = await fetchJSON('/ig/caption', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename, mediaType, keywords }) });
        if (els.cpOutput) els.cpOutput.value = out.caption || '';
        showToast('success','Caption generated');
      } catch(e){ showToast('error','Generate failed: '+ e.message); }
    });

    // History UI
    let histPageNum = 1;
    async function loadHistory(page){
      histPageNum = Math.max(1, page||1);
      const data = await fetchJSON(`/ig/history?page=${histPageNum}&limit=10&t=${Date.now()}`, { cache:'no-store' });
      if (els.histPage) els.histPage.textContent = `Page ${histPageNum}`;
      const root = els.histList; if (!root) return; root.innerHTML='';
      (data.items||[]).forEach(item => {
        const row = document.createElement('div'); row.className='item';
        const img = document.createElement('img'); img.className='thumb'; img.src = item.thumbnail_url + `?t=${Date.now()}`;
        const info = document.createElement('div');
        const icon = item.is_repost ? ' 🔁' : '';
        info.innerHTML = `<div><strong>${item.filename}${icon}</strong></div><div class='muted'>${fmtTime(item.published_at)}</div>`;
        const btn = document.createElement('button'); btn.textContent='🔁 Repost'; btn.className='secondary'; btn.addEventListener('click', async ()=>{
          try { await fetchJSON(`/ig/repost/${encodeURIComponent(item.id)}`, { method:'POST' }); showToast('success','Repost scheduled'); await loadStatus(); await loadLogs(); }
          catch(e){ showToast('error','Repost failed: ' + e.message); }
        });
        row.appendChild(img); row.appendChild(info); row.appendChild(btn);
        root.appendChild(row);
      });
    }
    if (els.btnHistPrev) els.btnHistPrev.addEventListener('click', ()=> loadHistory(histPageNum-1).catch(e=> showToast('error','Load failed')));
    if (els.btnHistNext) els.btnHistNext.addEventListener('click', ()=> loadHistory(histPageNum+1).catch(e=> showToast('error','Load failed')));

    // Tabs
    function showSchedule(){ document.getElementById('schedPanel').style.display='block'; if (els.kwPanel) els.kwPanel.style.display='none'; if (els.histPanel) els.histPanel.style.display='none'; if (els.healthPanel) els.healthPanel.style.display='none'; }
    function showKeywords(){ document.getElementById('schedPanel').style.display='none'; if (els.kwPanel) els.kwPanel.style.display='block'; if (els.histPanel) els.histPanel.style.display='none'; if (els.healthPanel) els.healthPanel.style.display='none'; }
    function showHistory(){ document.getElementById('schedPanel').style.display='none'; if (els.kwPanel) els.kwPanel.style.display='none'; if (els.histPanel) els.histPanel.style.display='block'; if (els.healthPanel) els.healthPanel.style.display='none'; loadHistory(1).catch(()=>{}); }
    function showHealth(){ document.getElementById('schedPanel').style.display='none'; if (els.kwPanel) els.kwPanel.style.display='none'; if (els.histPanel) els.histPanel.style.display='none'; if (els.healthPanel) els.healthPanel.style.display='block'; loadHealth().catch(()=>{}); }
    if (els.tabSchedule) els.tabSchedule.addEventListener('click', showSchedule);
    if (els.tabKeywords) els.tabKeywords.addEventListener('click', showKeywords);
    if (els.tabHistory) els.tabHistory.addEventListener('click', showHistory);
    if (els.tabHealth) els.tabHealth.addEventListener('click', showHealth);

    function showToast(type, text) {
      if (!els.toasts) return;
      const d = document.createElement('div'); d.className = 'toast ' + type; d.textContent = text; els.toasts.appendChild(d);
      setTimeout(() => d.remove(), 3500);
    }

    // Create Post Modal functionality
    let uploadedFile = null;
    
    // Open Create Post Modal
    const btnCreatePost = document.getElementById('btnCreatePost');
    if (btnCreatePost) {
      btnCreatePost.addEventListener('click', () => {
        openModal('createPostModal');
      });
    }
    
    // Magic Writer - Generate Caption
    const btnGenerateMagic = document.getElementById('btnGenerateMagic');
    if (btnGenerateMagic) {
      btnGenerateMagic.addEventListener('click', async () => {
        const description = document.getElementById('magicDescription')?.value || '';
        const tone = document.getElementById('magicTone')?.value || 'medium';
        const keywords = document.getElementById('magicKeywords')?.value || '';
        
        if (!description.trim()) {
          showToast('error', 'Please enter a description first');
          return;
        }
        
        btnGenerateMagic.disabled = true;
        btnGenerateMagic.textContent = '⏳ Generating...';
        
        try {
          const response = await fetchJSON('/ig/magic-writer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              description: description.trim(),
              tone,
              keywords: keywords.split(',').map(k => k.trim()).filter(Boolean)
            })
          });
          
          // Update caption textarea
          const postCaption = document.getElementById('postCaption');
          if (postCaption) {
            postCaption.value = response.caption;
            postCaption.dispatchEvent(new Event('input'));
          }
          
          // Show stats
          const magicStats = document.getElementById('magicStats');
          const magicCharCount = document.getElementById('magicCharCount');
          const magicHashCount = document.getElementById('magicHashCount');
          if (magicStats) {
            magicStats.style.display = 'block';
            if (magicCharCount) magicCharCount.textContent = response.length || '0';
            if (magicHashCount) magicHashCount.textContent = response.hashtags || '0';
          }
          
          showToast('success', 'Caption generated!');
        } catch (error) {
          showToast('error', 'Failed to generate caption: ' + error.message);
        } finally {
          btnGenerateMagic.disabled = false;
          btnGenerateMagic.textContent = '✨ Generate Caption';
        }
      });
    }
    
    // Caption action buttons
    const btnClearCaption = document.getElementById('btnClearCaption');
    if (btnClearCaption) {
      btnClearCaption.addEventListener('click', () => {
        const pc = document.getElementById('postCaption');
        if (pc) { pc.value=''; pc.dispatchEvent(new Event('input')); }
      });
    }
    const btnQuickRegen = document.getElementById('btnQuickRegen');
    if (btnQuickRegen) {
      btnQuickRegen.addEventListener('click', async () => {
        try {
          if (!uploadedFile) { showToast('error','Please select media first'); return; }
          const mediaType = uploadedFile.name.match(/\.(mp4|mov|avi|webm)$/i) ? 'video' : 'image';
          const out = await fetchJSON('/ig/caption', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: uploadedFile.name, mediaType, keywords: [] }) });
          const pc = document.getElementById('postCaption'); if (pc) { pc.value = out.caption || ''; pc.dispatchEvent(new Event('input')); }
          showToast('success','Caption regenerated');
        } catch (e){ showToast('error','Failed to regenerate: ' + e.message); }
      });
    }

    // Caption live preview and counter
    const postCaption = document.getElementById('postCaption');
    const captionCounter = document.getElementById('captionCounter');
    const phoneCaptionPreview = document.getElementById('phoneCaptionPreview');
    
    if (postCaption) {
      postCaption.addEventListener('input', () => {
        const length = postCaption.value.length;
        if (captionCounter) {
          captionCounter.textContent = `${length} / 2200`;
          captionCounter.style.color = length > 2200 ? '#ef4444' : '#94a3b8';
        }
        if (phoneCaptionPreview) {
          const preview = postCaption.value || 'Your caption will appear here...';
          phoneCaptionPreview.innerHTML = `<span style=\"font-weight: 500;\">yourbrand</span> ${preview.replace(/\\n/g, '<br>')}`;
        }
      });
    }
    
    // Emoji buttons
    document.querySelectorAll('.emoji-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (postCaption) {
          const emoji = btn.dataset.emoji;
          const start = postCaption.selectionStart;
          const end = postCaption.selectionEnd;
          const text = postCaption.value;
          postCaption.value = text.substring(0, start) + emoji + text.substring(end);
          postCaption.setSelectionRange(start + emoji.length, start + emoji.length);
          postCaption.focus();
          postCaption.dispatchEvent(new Event('input'));
        }
      });
    });
    
    // Use Draft in editor
    const btnUseDraftInEditor = document.getElementById('btnUseDraftInEditor');
    if (btnUseDraftInEditor) {
      btnUseDraftInEditor.addEventListener('click', (e) => {
        e.preventDefault();
        openDraftPicker();
      });
    }

    // Add hashtag button
    const btnAddHashtag = document.getElementById('btnAddHashtag');
    if (btnAddHashtag) {
      btnAddHashtag.addEventListener('click', () => {
        const hashtag = prompt('Enter hashtag (without #):');
        if (hashtag && postCaption) {
          const tag = ' #' + hashtag.replace(/\s+/g, '').replace(/^#/, '');
          postCaption.value += tag;
          postCaption.dispatchEvent(new Event('input'));
        }
      });
    }
    
    // File upload handling
    const postDropzone = document.getElementById('postDropzone');
    const postFileInput = document.getElementById('postFileInput');
    const dropzoneContent = document.getElementById('dropzoneContent');
    const uploadedMedia = document.getElementById('uploadedMedia');
    const previewImage = document.getElementById('previewImage');
    const phoneMediaPreview = document.getElementById('phoneMediaPreview');
    const btnRemoveMedia = document.getElementById('btnRemoveMedia');
    
    function generateVideoThumbnail(file, callback) {
      const video = document.createElement('video');
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      video.autoplay = false;
      video.muted = true;
      video.src = URL.createObjectURL(file);
      
      video.onloadeddata = function() {
        video.currentTime = 1; // Seek to 1 second to avoid black frames
      };
      
      video.onseeked = function() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const thumbnail = canvas.toDataURL('image/jpeg', 0.8);
        const duration = Math.round(video.duration);
        
        URL.revokeObjectURL(video.src);
        callback(thumbnail, duration);
      };
      
      video.onerror = function() {
        URL.revokeObjectURL(video.src);
        callback(null, 0);
      };
    }
    
    function handleFileSelect(file) {
      if (!file) return;
      
      // Validate file type
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif', 'video/mp4', 'video/quicktime', 'video/x-msvideo'];
      if (!validTypes.includes(file.type)) {
        showToast('error', 'Invalid file type. Please upload an image or video.');
        return;
      }
      
      // Store file
      uploadedFile = file;
      
      // Show preview
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          if (previewImage) {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';
          }
          if (phoneMediaPreview) {
            phoneMediaPreview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">`;
          }
          if (dropzoneContent) dropzoneContent.style.display = 'none';
          if (uploadedMedia) uploadedMedia.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else if (file.type.startsWith('video/')) {
        // Generate video thumbnail
        generateVideoThumbnail(file, (thumbnail, duration) => {
          if (thumbnail) {
            if (uploadedMedia) {
              uploadedMedia.innerHTML = `
                <div style="position: relative;">
                  <img src="${thumbnail}" style="max-width: 100%; max-height: 400px; border-radius: 6px;" />
                  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 24px; margin-left: 4px;">▶</span>
                  </div>
                  <div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                    ${duration}s
                  </div>
                </div>
                <div style="margin-top: 12px; text-align: center;">
                  <div style="color: #e6e6e6; font-weight: 500;">${file.name}</div>
                  <div style="color: #94a3b8; font-size: 13px; margin-top: 4px;">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                  <button id="btnRemoveMedia" style="margin-top: 8px; padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
                </div>
              `;
              document.getElementById('btnRemoveMedia')?.addEventListener('click', removeMedia);
            }
            if (phoneMediaPreview) {
              phoneMediaPreview.innerHTML = `
                <div style="position: relative; width: 100%; height: 100%;">
                  <img src="${thumbnail}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;" />
                  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 16px; margin-left: 2px;">▶</span>
                  </div>
                  <div style="position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">
                    ${duration}s
                  </div>
                </div>
              `;
            }
          } else {
            // Fallback if thumbnail generation fails
            if (uploadedMedia) {
              uploadedMedia.innerHTML = `
                <div style="background: #1a1a1a; padding: 40px; border-radius: 6px; text-align: center;">
                  <div style="font-size: 48px; margin-bottom: 12px;">🎬</div>
                  <div style="color: #e6e6e6; font-weight: 500;">${file.name}</div>
                  <div style="color: #94a3b8; font-size: 13px; margin-top: 8px;">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                </div>
                <div style="margin-top: 12px;">
                  <button id="btnRemoveMedia" style="padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
                </div>
              `;
              document.getElementById('btnRemoveMedia')?.addEventListener('click', removeMedia);
            }
            if (phoneMediaPreview) {
              phoneMediaPreview.innerHTML = `
                <div style="color: white; text-align: center;">
                  <div style="font-size: 48px; margin-bottom: 8px;">🎬</div>
                  <div style="font-size: 12px;">Video: ${file.name}</div>
                </div>
              `;
            }
          }
          
          if (dropzoneContent) dropzoneContent.style.display = 'none';
          if (uploadedMedia) uploadedMedia.style.display = 'block';
        });
      }
    }
    
    function removeMedia() {
      uploadedFile = null;
      if (dropzoneContent) dropzoneContent.style.display = 'block';
      if (uploadedMedia) uploadedMedia.style.display = 'none';
      if (phoneMediaPreview) {
        phoneMediaPreview.innerHTML = `
          <div style="color: #4a4a4a; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 8px;">📷</div>
            <div style="font-size: 12px;">No media uploaded</div>
          </div>
        `;
      }
    }
    
    if (postDropzone) {
      postDropzone.addEventListener('click', () => {
        if (postFileInput && !uploadedFile) postFileInput.click();
      });
      
      postDropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        postDropzone.style.borderColor = '#2563eb';
        postDropzone.style.background = 'rgba(37, 99, 235, 0.1)';
      });
      
      postDropzone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        postDropzone.style.borderColor = '#1e2a44';
        postDropzone.style.background = 'transparent';
      });
      
      postDropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        postDropzone.style.borderColor = '#1e2a44';
        postDropzone.style.background = 'transparent';
        
        const files = e.dataTransfer.files;
        if (files && files.length > 0) {
          handleFileSelect(files[0]);
        }
      });
    }
    
    if (postFileInput) {
      postFileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });
    }
    
    if (btnRemoveMedia) {
      btnRemoveMedia.addEventListener('click', removeMedia);
    }
    
    // Post type tabs
    document.querySelectorAll('.post-type-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs
        document.querySelectorAll('.post-type-tab').forEach(t => {
          t.classList.remove('active');
          t.style.background = 'transparent';
          t.style.color = '#94a3b8';
          t.style.border = '1px solid #1e2a44';
        });
        // Add active class and styling to clicked tab
        tab.classList.add('active');
        tab.style.background = '#2563eb';
        tab.style.color = 'white';
        tab.style.border = 'none';
        
        // Show notice for Stories and Reels
        const type = tab.dataset.type;
        if (type === 'story') {
          showToast('info', 'Stories expire after 24 hours and are shown vertically');
        } else if (type === 'reel') {
          showToast('info', 'Reels require video content (3-60 seconds)');
        }
      });
    });
    
    function getSelectedPlatforms(){
      const ig = document.getElementById('postToInstagram');
      const fb = document.getElementById('postToFacebook');
      const select = document.getElementById('facebookPageSelect');
      const instagram = !ig || !!ig.checked; // default true
      let facebook = undefined;
      if (fb && fb.checked) {
        const val = String(select?.value || '');
        const [pageId, pageToken] = val.includes(':') ? val.split(':') : [val, ''];
        const pageName = select && select.selectedIndex >= 0 ? select.options[select.selectedIndex].text : '';
        if (pageId) facebook = { enabled: true, pageId, pageName, pageAccessToken: pageToken || undefined };
      }
      return { instagram, facebook };
    }

    // Post Now button
    const btnPostNow = document.getElementById('btnPostNow');
    if (btnPostNow) {
      btnPostNow.addEventListener('click', async () => {
        const caption = sanitizeCaption(postCaption?.value || '');
        
        // Get selected post type
        const activeTab = document.querySelector('.post-type-tab.active') || document.querySelector('[data-type="post"]');
        const postType = activeTab?.dataset?.type?.toUpperCase() || 'POST';
        const isVideo = uploadedFile?.name?.match(/\.(mp4|mov|avi|webm)$/i);
        
        // Validate post type and media compatibility
        if (postType === 'REEL' && !isVideo) {
          showToast('error', 'Reels require video content');
          return;
        }
        
        if (postType === 'STORY') {
          showToast('info', 'Stories will expire after 24 hours');
        }
        
        if (!uploadedFile) {
          showToast('error', 'Please upload an image or video');
          return;
        }
        
        if (!caption.trim() && postType !== 'STORY') {
          showToast('error', 'Please enter a caption');
          return;
        }
        
        btnPostNow.disabled = true;
        btnPostNow.textContent = '⏳ Publishing...';
        
        const postStatus = document.getElementById('postStatus');
        const postStatusMessage = document.getElementById('postStatusMessage');
        if (postStatus) {
          postStatus.style.display = 'block';
          if (postStatusMessage) {
            postStatusMessage.textContent = 'Uploading media...';
          }
        }
        
        try {
          // First upload the file
          const formData = new FormData();
          formData.append('file', uploadedFile, uploadedFile.name);
          
          const uploadResponse = await fetchJSON('/ig/upload', {
            method: 'POST',
            body: formData
          });
          
          if (postStatusMessage) {
            postStatusMessage.textContent = 'Publishing to Instagram...';
          }
          
          // Then publish immediately with post type and platforms
          await fetchJSON('/ig/post-now', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              filename: uploadedFile.name,
              caption: caption,
              postType: postType,
              platforms: getSelectedPlatforms()
            })
          });
          
          showToast('success', 'Post published successfully!');
          
          if (postStatusMessage) {
            postStatusMessage.textContent = '✅ Published successfully!';
            postStatusMessage.style.color = '#10b981';
          }
          
          // Reset form after success
          setTimeout(() => {
            closeModal('createPostModal');
            // Reset form
            if (document.getElementById('magicDescription')) document.getElementById('magicDescription').value = '';
            if (postCaption) postCaption.value = '';
            removeMedia();
            if (postStatus) postStatus.style.display = 'none';
          }, 2000);
          
          // Reload status
          await loadStatus();
          await loadLogs();
          
        } catch (error) {
          showToast('error', 'Failed to publish: ' + error.message);
          if (postStatusMessage) {
            postStatusMessage.textContent = '❌ ' + error.message;
            postStatusMessage.style.color = '#ef4444';
          }
        } finally {
          btnPostNow.disabled = false;
          btnPostNow.textContent = '🚀 Post Now';
        }
      });
    }
    
    // Schedule for Later button
    const btnSchedulePost = document.getElementById('btnSchedulePost');
    if (btnSchedulePost) {
      btnSchedulePost.addEventListener('click', () => {
        openScheduleModal();
      });
    }
    
    // Video Player functionality
    function openVideoPlayer(filename) {
      const modal = document.getElementById('videoPlayerModal');
      const video = document.getElementById('videoPlayerElement');
      const title = document.getElementById('videoPlayerTitle');
      
      if (modal && video) {
        // Stop any existing video and clear source
        video.pause();
        video.src = '';
        video.currentTime = 0;
        
        // Set new video and show modal
        video.src = `/media/${encodeURIComponent(filename)}`;
        if (title) title.textContent = filename;
        openModal('videoPlayerModal');
        
        // Play the video once it's loaded
        video.onloadeddata = () => {
          video.play().catch(e => console.log('Video play failed:', e));
        };
      }
    }
    
    function closeVideoPlayer() {
      const modal = document.getElementById('videoPlayerModal');
      const video = document.getElementById('videoPlayerElement');
      
      if (modal && video) {
        // Stop video completely and clear source to stop audio
        video.pause();
        video.currentTime = 0;
        video.src = '';
        video.load(); // This ensures the video is completely reset
        closeModal('videoPlayerModal');
      }
    }
    
    window.closeVideoPlayer = closeVideoPlayer;
    window.openVideoPlayer = openVideoPlayer;
    
    // Schedule Modal functionality
    function openScheduleModal() {
      const caption = document.getElementById('postCaption')?.value || '';
      const isQuick = !!quickSchedule; // when scheduling from Saved Media or Draft selector
      
      // Only enforce uploadedFile/caption when not quick-scheduling
      if (!isQuick) {
        if (!uploadedFile) {
          showToast('error', 'Please upload an image or video first');
          return;
        }
        if (!caption.trim()) {
          showToast('error', 'Please enter a caption');
          return;
        }
      }
      
      const modal = document.getElementById('scheduleModal');
      const dateInput = document.getElementById('scheduleDate');
      const timeInput = document.getElementById('scheduleTime');
      const lastWrap = document.getElementById('scheduleLastPosted');
      const lastText = document.getElementById('scheduleLastPostedText');
      
      if (modal) {
        // Set default date and time
        const now = new Date();
        
        // Check if we have a preselected date from calendar
        if (window.preselectedDate) {
          dateInput.value = window.preselectedDate;
          window.preselectedDate = null; // Clear it after use
        } else {
          // Default to tomorrow
          now.setDate(now.getDate() + 1);
          dateInput.value = now.toISOString().split('T')[0];
        }
        
        // Default time to 10:00 AM
        timeInput.value = '10:00';
        
        // Show last posted indicator only for quick-schedule
        if (lastWrap && lastText) {
          if (isQuick) {
            const last = quickSchedule && quickSchedule.lastPostedAt ? new Date(quickSchedule.lastPostedAt) : null;
            lastWrap.style.display = 'block';
            lastText.textContent = last ? last.toLocaleString() : 'Never';
          } else {
            lastWrap.style.display = 'none';
          }
        }
        
        updateSchedulePreview();
        modal.classList.add('show');
      }
    }
    
    function updateSchedulePreview() {
      const dateInput = document.getElementById('scheduleDate');
      const timeInput = document.getElementById('scheduleTime');
      const previewText = document.getElementById('schedulePreviewText');
      
      if (dateInput?.value && timeInput?.value) {
        const scheduledDate = new Date(dateInput.value + 'T' + timeInput.value);
        previewText.textContent = scheduledDate.toLocaleString();
      } else {
        previewText.textContent = '--';
      }
    }
    
    // Update preview when date or time changes
    document.getElementById('scheduleDate')?.addEventListener('change', updateSchedulePreview);
    document.getElementById('scheduleTime')?.addEventListener('change', updateSchedulePreview);
    
    // Quick-schedule state
    let quickSchedule = null; // { filename, caption }

    // Facebook page selector logic
    const fbToggle = document.getElementById('postToFacebook');
    if (fbToggle) {
      fbToggle.addEventListener('change', async (e) => {
        const selWrap = document.getElementById('facebookPageSelector');
        const select = document.getElementById('facebookPageSelect');
        if (e && e.target && e.target.checked) {
          try {
            const r = await fetch('/fb/pages');
            const data = await r.json();
            const pages = (data && data.pages) || [];
            if (Array.isArray(pages) && pages.length) {
              select.innerHTML = '<option value="">Select Facebook Page</option>' +
                pages.map((p) => `<option value="${p.id}:${p.access_token}">${p.name}</option>`).join('');
              selWrap.style.display = 'block';
            } else {
              showToast('No Facebook pages found', 'error');
              if (e && e.target) e.target.checked = false;
              selWrap.style.display = 'none';
            }
          } catch (err) {
            showToast('Failed to load Facebook pages', 'error');
            if (e && e.target) e.target.checked = false;
            selWrap.style.display = 'none';
          }
        } else {
          selWrap.style.display = 'none';
        }
      });
    }

    // Confirm Schedule button
    document.getElementById('btnConfirmSchedule')?.addEventListener('click', async () => {
      const dateInput = document.getElementById('scheduleDate');
      const timeInput = document.getElementById('scheduleTime');
      const caption = document.getElementById('postCaption')?.value || '';
      const btnConfirm = document.getElementById('btnConfirmSchedule');
      
      if (!dateInput?.value || !timeInput?.value) {
        showToast('error', 'Please select both date and time');
        return;
      }
      
      const scheduledAt = new Date(dateInput.value + 'T' + timeInput.value).toISOString();
      
      btnConfirm.disabled = true;
      btnConfirm.textContent = '⏳ Scheduling...';
      
      try {
        if (quickSchedule && quickSchedule.filename) {
          await fetchJSON('/ig/schedule-post', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: quickSchedule.filename, scheduled_at: scheduledAt, caption: quickSchedule.caption || '', platforms: getSelectedPlatforms() })
          });
        } else {
          // First upload the file
          const formData = new FormData();
          formData.append('file', uploadedFile, uploadedFile.name);
          const uploadResponse = await fetchJSON('/ig/upload?library=true', { method: 'POST', body: formData });
          // Then schedule the post
          await fetchJSON('/ig/schedule-post', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: uploadedFile.name, scheduled_at: scheduledAt, caption: caption, platforms: getSelectedPlatforms() })
          });
        }
        
        showToast('success', `Post scheduled for ${new Date(scheduledAt).toLocaleString()}`);
        
        // Close modals and reset
        closeModal('scheduleModal');
        if (!quickSchedule) closeModal('createPostModal');
        
        // Reset form
        if (!quickSchedule) {
          if (document.getElementById('postCaption')) document.getElementById('postCaption').value = '';
          removeMedia();
        }
        quickSchedule = null;
        
        // Reload calendar and status
        await loadStatus();
        await loadCalendar();
        
      } catch (error) {
        showToast('error', 'Failed to schedule: ' + error.message);
      } finally {
        btnConfirm.disabled = false;
        btnConfirm.textContent = 'Schedule Post';
      }
    });
    
    // Image selector for assigning drafts to images
    async function openImageSelectorForDraft(draftId){
      const modal = document.getElementById('imageSelectorModal');
      const grid = document.getElementById('imageSelectorGrid');
      if (!modal || !grid) return;
      openModal('imageSelectorModal');
      try {
        const response = await fetchJSON('/ig/saved-media?page=1');
        grid.innerHTML='';
        (response.items||[]).forEach(item => {
          const card = document.createElement('div');
          card.style.cssText = 'position: relative; background:#121c30; border:1px solid #1e2a44; border-radius:6px; overflow:hidden;';
          const isVideo = item.mediaType==='video' || /\.(mp4|mov|avi|webm)$/i.test(item.filename);
          card.innerHTML = isVideo
            ? `<video src="/media/${encodeURIComponent(item.filename)}" style="width:100%; height:120px; object-fit:cover;" muted preload="metadata"></video>`
            : `<img src="/media/${encodeURIComponent(item.filename)}" style="width:100%; height:120px; object-fit:cover;" onerror="this.style.display='none'">`;
          const actionsWrap = document.createElement('div');
          actionsWrap.style.cssText = 'position:absolute; bottom:6px; right:6px; display:flex; gap:6px;';

          const assignBtn = document.createElement('button');
          assignBtn.textContent = 'Assign';
          assignBtn.className = 'secondary';
          assignBtn.addEventListener('click', async () => {
            try {
              await fetchJSON('/ig/queue-with-draft', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: item.filename, draftId, force: true }) });
              showToast('success', `Assigned to ${item.filename}`);
              closeModal('imageSelectorModal');
              await loadStatus();
            } catch (e){ showToast('error','Assign failed: '+e.message); }
          });

          const assignPreviewBtn = document.createElement('button');
          assignPreviewBtn.textContent = 'Assign & Preview';
          assignPreviewBtn.className = 'secondary';
          assignPreviewBtn.addEventListener('click', async () => {
            try {
              await fetchJSON('/ig/queue-with-draft', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: item.filename, draftId, force: true }) });
              const cap = await getDraftTextById(draftId);
              closeModal('imageSelectorModal');
              await loadStatus();
              openPostPreview(item.filename, cap || '');
              showToast('success', `Assigned and previewing ${item.filename}`);
            } catch (e){ showToast('error','Assign failed: '+e.message); }
          });

          const assignScheduleBtn = document.createElement('button');
          assignScheduleBtn.textContent = 'Assign & Schedule';
          assignScheduleBtn.className = 'secondary';
          assignScheduleBtn.addEventListener('click', async () => {
            try {
              await fetchJSON('/ig/queue-with-draft', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: item.filename, draftId, force: true }) });
              const cap = await getDraftTextById(draftId);
              quickSchedule = { filename: item.filename, caption: cap || '', lastPostedAt: item.published_at || null };
              closeModal('imageSelectorModal');
              openScheduleModal();
              showToast('success', `Assigned. Choose a time for ${item.filename}`);
            } catch (e){ showToast('error','Assign failed: '+e.message); }
          });
          
          actionsWrap.appendChild(assignBtn);
          actionsWrap.appendChild(assignPreviewBtn);
          actionsWrap.appendChild(assignScheduleBtn);
          card.appendChild(actionsWrap);
          grid.appendChild(card);
        });
      } catch (e) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#94a3b8;">Failed to load images</div>';
      }
    }

    // Utility: get draft text by id
    async function getDraftTextById(id){
      try {
        const local = (draftCache || []).find(d => d.id === id);
        if (local && local.text) return local.text;
        const r = await fetchJSON('/ig/caption-drafts?status=all&t=' + Date.now(), { cache: 'no-store' });
        const d = (r.drafts||[]).find(x => x.id === id);
        return d && d.text ? d.text : '';
      } catch { return ''; }
    }

    // Media Picker functionality
    let mediaPickerMode = 'library';
    let selectedMediaFile = null;
    
    async function openMediaPickerForPost() {
      mediaPickerMode = 'post';
      const modal = document.getElementById('mediaPickerModal');
      const grid = document.getElementById('mediaPickerGrid');
      const btnSelect = document.getElementById('btnSelectMedia');
      
      if (modal) {
        modal.classList.add('show');
        
        // Load media files
        try {
          const response = await fetchJSON('/ig/saved-media?page=1');
          
          if (grid) {
            grid.innerHTML = '';
            selectedMediaFile = null;
            
            if (btnSelect) {
              btnSelect.disabled = true;
              btnSelect.textContent = 'Select Media';
              // Update button click handler for post selection
              btnSelect.onclick = async function() {
                if (selectedMediaFile) {
                  // Guard: ensure this handler runs exclusively for post mode
                  if (mediaPickerMode !== 'post') return;
                  // Load the selected media into the post upload zone
                  try {
                    // Fetch the file as blob
                    const response = await fetch(`/media/${encodeURIComponent(selectedMediaFile.filename)}`);
                    const blob = await response.blob();
                    const file = new File([blob], selectedMediaFile.filename, { type: blob.type });
                    
                    // Set it as the uploaded file
                    uploadedFile = file;
                    
                    // Update the UI to show the selected media
                    const dropzoneContent = document.getElementById('dropzoneContent');
                    const uploadedMedia = document.getElementById('uploadedMedia');
                    const previewImage = document.getElementById('previewImage');
                    const phoneMediaPreview = document.getElementById('phoneMediaPreview');
                    
                    if (dropzoneContent) dropzoneContent.style.display = 'none';
                    if (uploadedMedia) uploadedMedia.style.display = 'block';
                    
                    if (previewImage) {
                      if (selectedMediaFile.mediaType === 'video' || selectedMediaFile.filename.match(/\.(mp4|mov|avi|webm)$/i)) {
                        previewImage.style.display = 'none';
                        // Add video preview if needed
                        let videoPreview = uploadedMedia.querySelector('video');
                        if (!videoPreview) {
                          videoPreview = document.createElement('video');
                          videoPreview.style.cssText = 'max-width: 100%; max-height: 400px; border-radius: 6px;';
                          videoPreview.controls = true;
                          videoPreview.muted = true;
                          uploadedMedia.insertBefore(videoPreview, uploadedMedia.firstChild);
                        }
                        videoPreview.src = `/media/${encodeURIComponent(selectedMediaFile.filename)}`;
                      } else {
                        previewImage.style.display = 'block';
                        previewImage.src = `/media/${encodeURIComponent(selectedMediaFile.filename)}`;
                        // Remove video preview if exists
                        const videoPreview = uploadedMedia.querySelector('video');
                        if (videoPreview) videoPreview.remove();
                      }
                    }
                    
                    // Update phone preview
                    if (phoneMediaPreview) {
                      if (selectedMediaFile.mediaType === 'video' || selectedMediaFile.filename.match(/\.(mp4|mov|avi|webm)$/i)) {
                        phoneMediaPreview.innerHTML = `
                          <video src="/media/${encodeURIComponent(selectedMediaFile.filename)}" 
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;" 
                                 muted autoplay loop></video>
                        `;
                      } else {
                        phoneMediaPreview.innerHTML = `
                          <img src="/media/${encodeURIComponent(selectedMediaFile.filename)}" 
                               style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
                        `;
                      }
                    }

                    // Populate caption if we have one already for this media
                    try {
                      let cap = await fetchCaptionForFile(selectedMediaFile.filename);
                      if (!cap && selectedMediaFile.caption) cap = selectedMediaFile.caption;
                      const postCaption = document.getElementById('postCaption');
                      if (postCaption && cap) { postCaption.value = cap; postCaption.dispatchEvent(new Event('input')); }
                    } catch {}
                    
                    closeModal('mediaPickerModal');
                    mediaPickerMode = 'library';
                    showToast('success', `Selected: ${selectedMediaFile.filename}`);
                    
                  } catch (error) {
                    showToast('error', 'Failed to load media: ' + error.message);
                  }
                }
              };
            }
            
            if (response.items && response.items.length > 0) {
              response.items.forEach(item => {
                const card = document.createElement('div');
                card.style.cssText = 'position: relative; background: #121c30; border: 2px solid #1e2a44; border-radius: 8px; overflow: hidden; cursor: pointer; aspect-ratio: 1;';
                card.dataset.filename = item.filename;
                card.dataset.mediaType = item.mediaType || 'image';
                
                const isVideo = item.mediaType === 'video' || item.filename.match(/\.(mp4|mov|avi|webm)$/i);
                
                if (isVideo) {
                  card.innerHTML = `
                    <video src="/media/${encodeURIComponent(item.filename)}" 
                           style="width: 100%; height: 100%; object-fit: cover;" 
                           muted preload="metadata"></video>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; pointer-events: none;">
                      <span style="color: white; font-size: 14px; margin-left: 2px;">▶</span>
                    </div>
                  `;
                  const video = card.querySelector('video');
                  if (video) {
                    video.onloadedmetadata = function() {
                      video.currentTime = 1;
                    };
                  }
                } else {
                  card.innerHTML = `<img src="/media/${encodeURIComponent(item.filename)}?t=${Date.now()}" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
                

                // Add delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.style.cssText = 'position: absolute; top: 8px; right: 8px; background: rgba(220, 38, 38, 0.9); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; display: none;';
                deleteBtn.innerHTML = '🗑';
                deleteBtn.addEventListener('click', async function(e){
                  e.stopPropagation();
                  if (confirm(`Delete ${item.filename}?`)) {
                    try {
                      await fetchJSON(`/ig/media/${encodeURIComponent(item.filename)}`, { method: 'DELETE' });
                      card.remove();
                      showToast('success', 'Media deleted');
                    } catch (error) {
                      showToast('error', 'Failed to delete: ' + error.message);
                    }
                  }
                });
                card.appendChild(deleteBtn);
                
                // Show delete button on hover
                card.addEventListener('mouseenter', function(){ deleteBtn.style.display = 'block'; });
                card.addEventListener('mouseleave', function(){ deleteBtn.style.display = 'none'; });
                card.addEventListener('click', function(){
                  grid.querySelectorAll('div').forEach(c => {
                    if (c.style.borderColor) c.style.borderColor = '#1e2a44';
                  });
                  card.style.borderColor = '#2563eb';
                  selectedMediaFile = item;
                  const info = document.getElementById('mediaPickerInfo');
                  if (btnSelect) {
                    btnSelect.disabled = false;
                    btnSelect.textContent = `Use ${item.filename}`;
                  }
                  if (info) info.textContent = `Selected: ${item.filename}`;
                });
                
                grid.appendChild(card);
              });
            } else {
              grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8;">No media files found. Upload some files first.</div>';
            }
          }
        } catch (error) {
          showToast('error', 'Failed to load media: ' + error.message);
          if (grid) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #ef4444;">Failed to load media files</div>';
          }
        }
      }
    }
    
    async function openMediaPicker() {
      const modal = document.getElementById('mediaPickerModal');
      const grid = document.getElementById('mediaPickerGrid');
      
  if (modal) {
        mediaPickerMode = 'library';
        modal.classList.add('show');
        
        // Load media files
        try {
          const response = await fetchJSON('/ig/saved-media?page=1');
          
          if (grid) {
            grid.innerHTML = '';
            
            if (response.items && response.items.length > 0) {
              response.items.forEach(item => {
                const card = document.createElement('div');
                card.style.cssText = 'position: relative; background: #121c30; border: 2px solid #1e2a44; border-radius: 8px; overflow: hidden; cursor: pointer; aspect-ratio: 1;';
                card.dataset.filename = item.filename;
                card.dataset.mediaType = item.mediaType || 'image';
                
                const isVideo = item.mediaType === 'video' || item.filename.match(/\.(mp4|mov|avi|webm)$/i);
                
                if (isVideo) {
                  card.innerHTML = `
                    <video src="/media/${encodeURIComponent(item.filename)}" 
                           style="width: 100%; height: 100%; object-fit: cover;" 
                           muted preload="metadata"></video>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; pointer-events: none;">
                      <span style="color: white; font-size: 14px; margin-left: 2px;">▶</span>
                    </div>
                  `;
                  const video = card.querySelector('video');
                  if (video) {
                    video.onloadedmetadata = function() {
                      video.currentTime = 1;
                    };
                  }
                } else {
                  card.innerHTML = `<img src="/media/${encodeURIComponent(item.filename)}?t=${Date.now()}" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
                
                card.addEventListener('click', function(){
                  grid.querySelectorAll('div').forEach(c => { c.style.borderColor = '#1e2a44'; });
                  card.style.borderColor = '#2563eb';
                  selectedMediaFile = item;
                  const btnSelect = document.getElementById('btnSelectMedia');
                  const info = document.getElementById('mediaPickerInfo');
                  if (btnSelect) btnSelect.disabled = false;
                  if (info) info.textContent = `Selected: ${item.filename}`;
                });
                
                grid.appendChild(card);
              });
            } else {
              grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8;">No media files found. Upload some files first.</div>';
            }
          }
        } catch (e) {
          console.error('Failed to load media:', e);
          showToast('error', 'Failed to load media library');
        }
      }
    }
    
    // Media Picker event handlers
    const btnChooseFromLibrary = document.getElementById('btnChooseFromLibrary');
    if (btnChooseFromLibrary) {
      btnChooseFromLibrary.addEventListener('click', (e) => {
        e.stopPropagation();
        openMediaPickerForPost();
      });
    }
    
    const btnSelectMedia = document.getElementById('btnSelectMedia');
    if (btnSelectMedia) {
      btnSelectMedia.addEventListener('click', async () => {
        // Only handle default library mode; in post mode a custom handler is attached
        if (mediaPickerMode !== 'library') return;
        if (!selectedMediaFile) return;
        
        try {
          // Fetch the file and load it into the upload zone
          const response = await fetch(`/media/${encodeURIComponent(selectedMediaFile.filename)}`);
          const blob = await response.blob();
          const file = new File([blob], selectedMediaFile.filename, { type: blob.type });
          
          // Use existing file handler
          handleFileSelect(file);
          
          // Show success message before clearing
          showToast('success', `Selected: ${selectedMediaFile.filename}`);
          
          // Close modal and clear selection
          closeModal('mediaPickerModal');
          selectedMediaFile = null;
        } catch (e) {
          showToast('error', 'Failed to load selected media');
        }
      });
    }
    
    // Search functionality for media picker
    const mediaPickerSearch = document.getElementById('mediaPickerSearch');
    if (mediaPickerSearch) {
      mediaPickerSearch.addEventListener('input', () => {
        const query = mediaPickerSearch.value.toLowerCase();
        const grid = document.getElementById('mediaPickerGrid');
        
        if (grid) {
          grid.querySelectorAll('div[data-filename]').forEach(card => {
            const filename = card.dataset.filename.toLowerCase();
            card.style.display = filename.includes(query) ? 'block' : 'none';
          });
        }
      });
    }
    
    // Activity Log (Recent modal)
    function openActivityLog() {
      const modal = document.getElementById('activityLogModal');
      const content = document.getElementById('activityLogContent');
      if (!modal || !content) return;
      const recent = (logsCache || []).slice(-10);
      const fmt = (s)=>{ try { return new Date(s).toLocaleTimeString(); } catch { return s; } };
      const iconFor = (l)=>{
        const cat = (l.category||'').toUpperCase();
        if (cat==='SUCCESS') return '✅';
        if (cat==='ERROR') return '❌';
        if (cat==='WARNING') return '⚠️';
        return 'ℹ️';
      };
      content.innerHTML = recent.map(l => `
        <div class="activity-item" style="display:flex; gap:8px; align-items:center; border-bottom:1px dashed #1e2a44; padding:6px 0;">
          <span class="activity-icon">${iconFor(l)}</span>
          <span class="activity-text" style="flex:1;">${l.message}</span>
          <span class="activity-time" style="color:#94a3b8; font-size:12px;">${fmt(l.ts)}</span>
        </div>
      `).join('');
      openModal('activityLogModal');
    }

    // Low caption warning display
    function showLowCaptionWarning() {
      // Avoid stacking multiple warnings
      if (document.querySelector('.low-caption-warning')) return;
      // Respect session dismissal until the app is reopened
      try { if (sessionStorage.getItem('lowCaptionDismissed') === '1') return; } catch {}

      const warning = document.createElement('div');
      warning.className = 'low-caption-warning';
      warning.innerHTML = `
        <span>⚠️ Low on captions!</span>
        <a href="#" class="open-drafts-link">Generate more drafts</a>
        <button class="warning-close">×</button>
      `;
      document.body.appendChild(warning);
      const closeBtn = warning.querySelector('.warning-close');
      if (closeBtn) closeBtn.addEventListener('click', () => {
        try { sessionStorage.setItem('lowCaptionDismissed', '1'); } catch {}
        warning.classList.add('fade-out');
        setTimeout(() => { try { warning.remove(); } catch {} }, 180);
      });
      // Auto-hide without setting session flag
      setTimeout(() => { try { warning.classList.add('fade-out'); setTimeout(() => warning.remove(), 180); } catch {} }, 10000);
      // Wire link to open drafts
      const link = warning.querySelector('.open-drafts-link');
      if (link) link.addEventListener('click', (e) => { e.preventDefault(); openDraftsModal(); });
    }

    function openDraftsModal(){
      (async () => { await loadDrafts('all'); renderDraftsGrid(); openModal('draftsManager'); })().catch(()=>{});
    }

    // Manual draft pairing for media and editor
    let draftSelectTargetFilename = null;
    let draftSelectMode = 'pair-media'; // 'pair-media' | 'fill-editor';

    async function selectDraftForMedia(filename) {
      draftSelectMode = 'pair-media';
      draftSelectTargetFilename = filename;
      const title = document.getElementById('draftSelectFilename');
      if (title) title.textContent = filename;
      await loadDrafts('draft');
      renderDraftSelection();
      openModal('draftSelectorModal');
    }

    async function openDraftPicker() {
      draftSelectMode = 'fill-editor';
      draftSelectTargetFilename = null;
      const title = document.getElementById('draftSelectFilename');
      if (title) title.textContent = 'Post Editor';
      await loadDrafts('draft');
      renderDraftSelection();
      openModal('draftSelectorModal');
    }

    function renderDraftSelection() {
      const grid = document.getElementById('draftSelectGrid'); if (!grid) return;
      const searchEl = document.getElementById('draftSearch');
      const q = (searchEl && searchEl.value || '').toLowerCase();
      grid.innerHTML = '';

      const list = (draftCache || []).filter(d => d.status === 'draft' && (!q || d.text.toLowerCase().includes(q)));
      if (list.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#94a3b8; padding: 20px;">No available drafts. Generate more first.</div>';
        return;
      }
      list.forEach(draft => {
        const card = document.createElement('div');
        card.style.cssText = 'background:#121c30; border:1px solid #1e2a44; border-radius:8px; padding:10px; display:flex; flex-direction:column; gap:8px;';
        const meta = document.createElement('div');
        meta.className = 'muted';
        meta.style.fontSize = '11px';
        meta.textContent = `${new Date(draft.createdAt).toLocaleString()} · ${draft.style}`;
        const ta = document.createElement('textarea');
        ta.value = draft.text;
        ta.readOnly = true;
        ta.style.cssText = 'width:100%; min-height:140px; padding:8px; background:#0f172a; color:#e6e6e6; border:1px solid #1e2a44; border-radius:6px;';
        const row = document.createElement('div');
        row.style.cssText = 'display:flex; gap:8px;';
        const useBtn = document.createElement('button');
        useBtn.textContent = '✅ Use This Caption';
        useBtn.style.cssText = 'flex:1; padding:8px; background:#22c55e; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;';
        useBtn.onclick = async function() {
          try {
            if (draftSelectMode === 'pair-media') {
              await fetchJSON('/ig/queue-with-draft', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: draftSelectTargetFilename, draftId: draft.id })
              });
              closeModal('draftSelectorModal');
              showToast('success', `Paired caption to ${draftSelectTargetFilename}`);
              await loadStatus();
              await loadDrafts();
            } else {
              const postCaption = document.getElementById('postCaption');
              if (postCaption) {
                postCaption.value = draft.text;
                postCaption.dispatchEvent(new Event('input'));
              }
              closeModal('draftSelectorModal');
              showToast('success', 'Draft caption loaded into editor');
            }
          } catch (e){ showToast('error', 'Failed to apply draft: ' + e.message); }
        };
        row.appendChild(useBtn);
        card.appendChild(meta);
        card.appendChild(ta);
        card.appendChild(row);
        grid.appendChild(card);
      });
    }

    document.getElementById('draftSearch')?.addEventListener('input', renderDraftSelection);

    window.selectDraftForMedia = selectDraftForMedia;
    window.openDraftPicker = openDraftPicker;

    // License check at startup
    ensureLicense().catch(()=>{});

    // Convert inline onclick buttons to addEventListener bindings
    document.getElementById('activityLogBtn')?.addEventListener('click', openActivityLog);
    document.querySelectorAll('#draftsModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('draftsModal')));
    document.getElementById('btnDraftsCancel')?.addEventListener('click', () => closeModal('draftsModal'));
    document.querySelectorAll('#draftsManager .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('draftsManager')));
    document.querySelectorAll('#scheduledModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('scheduledModal')));
    document.querySelectorAll('#logsModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('logsModal')));
    document.querySelectorAll('#autopilotModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('autopilotModal')));
    document.getElementById('btnAutopilotCancel')?.addEventListener('click', () => closeModal('autopilotModal'));
    document.querySelectorAll('#scheduleModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('scheduleModal')));
    document.getElementById('btnScheduleCancel')?.addEventListener('click', () => closeModal('scheduleModal'));
    document.getElementById('btnCloseVideoPlayer')?.addEventListener('click', closeVideoPlayer);
    document.querySelectorAll('#videoPlayerModal .modal-close')?.forEach(btn => btn.addEventListener('click', closeVideoPlayer));
    document.querySelectorAll('#imageSelectorModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('imageSelectorModal')));
    document.querySelectorAll('#mediaPickerModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('mediaPickerModal')));
    document.getElementById('btnMediaPickerCancel')?.addEventListener('click', () => closeModal('mediaPickerModal'));
    document.querySelectorAll('#draftSelectorModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('draftSelectorModal')));
    document.querySelectorAll('#postPreviewModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('postPreviewModal')));
    document.querySelectorAll('#postLibraryModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('postLibraryModal')));
    document.querySelectorAll('#activityLogModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('activityLogModal')));
    document.getElementById('btnActivityViewAll')?.addEventListener('click', () => { openModal('logsModal'); closeModal('activityLogModal'); });
    document.querySelectorAll('#bulkAssignModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('bulkAssignModal')));
    document.getElementById('btnReloadBulkMapping')?.addEventListener('click', () => reloadBulkAssignMapping());
    document.querySelectorAll('#savedMediaModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('savedMediaModal')));
    document.querySelectorAll('#createPostModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('createPostModal')));
    document.querySelectorAll('#schedSettingsModal .modal-close')?.forEach(btn => btn.addEventListener('click', () => closeModal('schedSettingsModal')));
    const btnOpenSchedSettings = document.getElementById('btnOpenSchedSettings');
    if (btnOpenSchedSettings) { btnOpenSchedSettings.addEventListener('click', async () => { try { await loadSchedule(); } catch{}; openModal('schedSettingsModal'); }); }
    // Library -> Post choose button binding handled above with openMediaPickerForPost

    // Post Preview
    async function openPostPreview(filename, caption){
      const modal = document.getElementById('postPreviewModal');
      const media = document.getElementById('postPreviewMedia');
      const cap = document.getElementById('postPreviewCaption');
      const postInfo = document.getElementById('postPreviewInfo');
      if (!modal || !media || !cap) return;
      
      // Get post details including scheduling info
      let postData = null;
      try {
        const s = await fetchJSON('/ig/status?t=' + Date.now(), { cache: 'no-store' });
        postData = (s.posts||[]).find(function(x){ return x && x.filename === filename; });
      } catch (e){ /* ignore */ }
      
      // Set caption
      cap.textContent = sanitizeCaption(caption || (postData && postData.caption) || '');
      
      // Set media
      if (!filename) {
        media.innerHTML = '<div style="color:#8e8e8e; text-align:center; padding: 40px;">No media selected</div>';
      } else {
        const isVideo = /\.(mp4|mov|avi|webm)$/i.test(filename || '');
        media.innerHTML = isVideo
          ? `<video src="/media/${encodeURIComponent(filename)}" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 8px;" controls autoplay muted loop></video>`
          : `<img src="/media/${encodeURIComponent(filename)}" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 8px;">`;
      }
      
      // Set post info (status, schedule time, etc.)
      if (postInfo && postData) {
        const status = postData.status || 'UNKNOWN';
        const statusColors = {
          'QUEUED': '#94a3b8',
          'SCHEDULED': '#3b82f6', 
          'PUBLISHING': '#f59e0b',
          'PUBLISHED': '#22c55e',
          'ERROR': '#ef4444'
        };
        const statusColor = statusColors[status] || '#94a3b8';
        
        let timeInfo = '';
        if (postData.published_at) {
          timeInfo = `Published: ${new Date(postData.published_at).toLocaleString()}`;
        } else if (postData.scheduled_at) {
          timeInfo = `Scheduled: ${new Date(postData.scheduled_at).toLocaleString()}`;
        }
        
        postInfo.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div style="font-weight: 600; font-size: 16px;">${filename}</div>
            <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">${status}</span>
          </div>
          ${timeInfo ? `<div style="color: #94a3b8; font-size: 13px; margin-bottom: 8px;">${timeInfo}</div>` : ''}
          ${postData.is_repost ? '<div style="color: #f59e0b; font-size: 12px; margin-bottom: 8px;">🔁 This is a repost</div>' : ''}
        `;
      } else if (postInfo) {
        postInfo.innerHTML = `<div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">${filename}</div>`;
      }
      
      openModal('postPreviewModal');
    }

    // Bulk Assign state
    let selectedMediaSet = new Set();

    // Helper to fetch caption for a filename from current state
    async function fetchCaptionForFile(filename){
      try {
        const s = await fetchJSON('/ig/status?t=' + Date.now(), { cache: 'no-store' });
        const p = (s.posts||[]).find(function(x){ return x && x.filename === filename; });
        return sanitizeCaption(p && p.caption ? p.caption : '');
      } catch (e){ return ''; }
    }

    // Saved Media Library functionality
    let savedMediaPage = 1;
    let savedMediaTotal = 0;
    let savedMediaPages = 1;
    let libraryUploadActive = false;
    
    // Delete media item function
    async function deleteMediaItem(filename) {
      if (!confirm(`Delete ${filename}? This cannot be undone.`)) return;
      
      try {
        const response = await fetch(`/ig/media/${encodeURIComponent(filename)}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showToast('success', 'Media deleted successfully');
          loadSavedMedia(savedMediaPage); // Refresh grid
        } else {
          const error = await response.json();
          showToast('error', error.error || 'Failed to delete media');
        }
      } catch (error) {
        showToast('error', 'Error deleting media: ' + error.message);
      }
    }
    
    async function loadSavedMedia(page = 1) {
      try {
        const response = await fetchJSON(`/ig/saved-media?page=${page}`);
        savedMediaPage = response.page || 1;
        savedMediaPages = response.pages || 1;
        savedMediaTotal = response.total || 0;
        
        const grid = document.getElementById('savedMediaGrid');
        const info = document.getElementById('savedMediaInfo');
        const pageInfo = document.getElementById('savedPageInfo');
        const prevBtn = document.getElementById('btnSavedPrev');
        const nextBtn = document.getElementById('btnSavedNext');
        
        if (info) {
          info.textContent = `${savedMediaTotal} saved media files`;
        }
        
        if (pageInfo) {
          pageInfo.textContent = `Page ${savedMediaPage} of ${savedMediaPages}`;
        }
        
        if (prevBtn) {
          prevBtn.disabled = savedMediaPage <= 1;
        }
        
        if (nextBtn) {
          nextBtn.disabled = savedMediaPage >= savedMediaPages;
        }
        
        if (grid) {
          grid.innerHTML = '';
          selectedMediaSet.clear();
          updateBulkAssignButton();
          
          if (response.items && response.items.length > 0) {
            const unpublished = (response.items || []).filter(it => !it.published_at);
            const published = (response.items || []).filter(it => !!it.published_at);

            function addGroupHeader(text){
              const h = document.createElement('div');
              h.textContent = text;
              h.style.cssText = 'grid-column: 1 / -1; color: #94a3b8; font-weight: 600; margin: 6px 2px;';
              grid.appendChild(h);
            }

            function renderCard(item){
              const card = document.createElement('div');
              card.style.cssText = 'background: #121c30; border: 1px solid #1e2a44; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; position:relative;';
              
              // Selection checkbox
              const sel = document.createElement('input');
              sel.type = 'checkbox';
              sel.style.cssText = 'position:absolute; top:8px; left:8px; z-index:2; width:16px; height:16px;';
              sel.checked = selectedMediaSet.has(item.filename);
              sel.addEventListener('change', () => { if (sel.checked) selectedMediaSet.add(item.filename); else selectedMediaSet.delete(item.filename); updateBulkAssignButton(); });
              card.appendChild(sel);
              
              // Check if this is a video file (from mediaType or filename)
              const isVideo = item.mediaType === 'video' || item.filename.match(/\.(mp4|mov|avi|webm)$/i);
              
              // Image/Video wrapper
              const imgWrapper = document.createElement('div');
              imgWrapper.className = 'media-item';
              imgWrapper.style.cssText = 'position: relative; aspect-ratio: 1; background: #0f172a; cursor: pointer;';
              imgWrapper.dataset.filename = item.filename;
              imgWrapper.dataset.mediaType = isVideo ? 'video' : 'image';
              
              if (isVideo) {
                // For videos, try to generate thumbnail or show icon
                const videoThumb = document.createElement('video');
                videoThumb.src = `/media/${encodeURIComponent(item.filename)}`;
                videoThumb.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                videoThumb.muted = true;
                videoThumb.preload = 'metadata';
                
                videoThumb.onloadedmetadata = function() {
                  videoThumb.currentTime = 1;
                };
                
                videoThumb.onseeked = function() {
                  // Video frame loaded, add play button
                  const playBtn = document.createElement('div');
                  playBtn.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;';
                  playBtn.innerHTML = '<span style="color: white; font-size: 18px; margin-left: 2px;">▶</span>';
                  playBtn.onclick = (e) => {
                    e.stopPropagation();
                    openVideoPlayer(item.filename);
                  };
                  imgWrapper.appendChild(playBtn);
                };
                
                videoThumb.onerror = function() {
                  // Remove the problematic video element and show fallback
                  videoThumb.remove();
                  imgWrapper.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #64748b; font-size: 48px;">🎬</div>';
                  const playBtn = document.createElement('div');
                  playBtn.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;';
                  playBtn.innerHTML = '<span style="color: white; font-size: 18px; margin-left: 2px;">▶</span>';
                  playBtn.onclick = (e) => {
                    e.stopPropagation();
                    openVideoPlayer(item.filename);
                  };
                  imgWrapper.appendChild(playBtn);
                };
                
                imgWrapper.appendChild(videoThumb);
              } else {
                const img = document.createElement('img');
                img.src = `/media/${encodeURIComponent(item.filename)}?t=${Date.now()}`;
                img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                img.onerror = function() {
                  // Don't spam console with 404 errors for missing videos shown as img tags
                  this.style.display = 'none';
                  imgWrapper.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #64748b; font-size: 48px;">🌆</div>';
                };
                imgWrapper.appendChild(img);
              }
              
              // Delete button
              const deleteBtn = document.createElement('button');
              deleteBtn.className = 'delete-btn';
              deleteBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; background: rgba(255, 0, 0, 0.8); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; opacity: 0; transition: opacity 0.2s; font-size: 16px; display: flex; align-items: center; justify-content: center; z-index: 10;';
              deleteBtn.innerHTML = '×';
              deleteBtn.title = 'Delete';
              deleteBtn.addEventListener('click', async function(e){
                e.stopPropagation();
                await deleteMediaItem(item.filename);
              });
              imgWrapper.appendChild(deleteBtn);
              
              // Show delete button on hover
              imgWrapper.addEventListener('mouseenter', () => {
                deleteBtn.style.opacity = '1';
              });
              imgWrapper.addEventListener('mouseleave', () => {
                deleteBtn.style.opacity = '0';
              });
              
              // Usage badge (move to left if exists to avoid overlapping with delete button)
              if (item.times_used > 1) {
                const badge = document.createElement('div');
                badge.style.cssText = 'position: absolute; top: 8px; left: 8px; background: rgba(37, 99, 235, 0.9); color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;';
                badge.textContent = `${item.times_used}x`;
                imgWrapper.appendChild(badge);
              }
              
              // Info
              const info = document.createElement('div');
              info.style.cssText = 'padding: 12px;';
              const dateText = item.published_at ? `Posted: ${new Date(item.published_at).toLocaleDateString()}` : 
                               item.modified_at ? `Modified: ${new Date(item.modified_at).toLocaleDateString()}` : 
                               'Uploaded';
              info.innerHTML = `
                <div style=\"font-size: 13px; font-weight: 500; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\">${item.filename}</div>
                <div style=\"font-size: 11px; color: #94a3b8; margin-bottom: 8px;\">${dateText}</div>
              `;
              
              // Preview + Post Now + Schedule actions
              const actionsRow = document.createElement('div');
              actionsRow.style.cssText = 'display:flex; gap:6px; padding:8px; flex-wrap: wrap;';

              const previewBtn = document.createElement('button');
              previewBtn.textContent = '👁 Preview';
              previewBtn.className = 'secondary'; previewBtn.style.cssText='padding:6px 8px; font-size:12px;';
              previewBtn.onclick = async () => {
                const cap = await fetchCaptionForFile(item.filename);
                openPostPreview(item.filename, cap || (item.caption || ''));
              };

              const scheduleBtn = document.createElement('button');
              scheduleBtn.textContent = '⏰ Schedule';
              scheduleBtn.className = 'secondary'; scheduleBtn.style.cssText='padding:6px 8px; font-size:12px;';
              scheduleBtn.onclick = async () => {
                const cap = await fetchCaptionForFile(item.filename);
                quickSchedule = { filename: item.filename, caption: cap || (item.caption || ''), lastPostedAt: item.published_at || null };
                openScheduleModal();
              };

              const postNowBtn = document.createElement('button');
              postNowBtn.textContent = '🚀 Post Now';
              postNowBtn.className = 'secondary'; postNowBtn.style.cssText='padding:6px 8px; font-size:12px;';
              postNowBtn.onclick = async () => {
                try {
                  const cap = sanitizeCaption(item.caption || '');
                  await fetchJSON('/ig/post-now', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: item.filename, caption: cap }) });
                  showToast('success', 'Posted: ' + item.filename);
                  await loadStatus();
                  await loadLogs();
                } catch(e){ showToast('error','Post now failed: '+e.message); }
              };

              // Disable Post Now for previously published items
              if (item.published_at) {
                postNowBtn.disabled = true;
                postNowBtn.style.opacity = '0.5';
                postNowBtn.style.cursor = 'not-allowed';
                postNowBtn.title = `Already posted on ${new Date(item.published_at).toLocaleString()}`;
              }

              actionsRow.appendChild(previewBtn);
              actionsRow.appendChild(scheduleBtn);
              actionsRow.appendChild(postNowBtn);

              // Reuse button
              const reuseBtn = document.createElement('button');
              reuseBtn.textContent = '🔁 Reuse';
              reuseBtn.style.cssText = 'width: 100%; padding: 6px 8px; background: #2563eb; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer; margin-bottom: 6px;';
              reuseBtn.addEventListener('click', async function(){
                try {
                  const response = await fetch(`/media/${encodeURIComponent(item.filename)}`);
                  const blob = await response.blob();
                  const file = new File([blob], item.filename, { type: blob.type });
                  const formData = new FormData();
                  formData.append('file', file);
                  await fetchJSON('/ig/upload', { method: 'POST', body: formData });
                  showToast('success', `Reused: ${item.filename}`);
                  closeModal('savedMediaModal');
                  await loadStatus();
                  await loadLogs();
                } catch (e) {
                  showToast('error', 'Failed to reuse media: ' + e.message);
                }
              });
              
              // Choose Caption button
              const chooseBtn = document.createElement('button');
              chooseBtn.textContent = '📝 Choose Caption';
              chooseBtn.style.cssText = 'width: 100%; padding: 6px 8px; background: #1e2a44; color: #e6e6e6; border: 1px solid #334155; border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer;';
              chooseBtn.addEventListener('click', function(){
                selectDraftForMedia(item.filename);
              });
              
              info.appendChild(reuseBtn);
              info.appendChild(chooseBtn);
              info.appendChild(actionsRow);
              
              card.appendChild(imgWrapper);
              card.appendChild(info);
              grid.appendChild(card);
            }

            if (unpublished.length) {
              addGroupHeader('Unpublished');
              unpublished.forEach(renderCard);
            }
            if (published.length) {
              addGroupHeader('Published');
              published.forEach(renderCard);
            }
          } else {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8;">No saved media found. Published posts will appear here.</div>';
          }
        }
      } catch (e) {
        console.error('Failed to load saved media:', e);
        showToast('error', 'Failed to load saved media');
      }
    }

    function updateBulkAssignButton(){
      const btn = document.getElementById('btnBulkAssignSelected');
      if (btn) btn.disabled = selectedMediaSet.size === 0;
    }

    document.getElementById('btnBulkAssignSelected')?.addEventListener('click', async () => {
      if (selectedMediaSet.size === 0) return;
      await prepareBulkAssign();
      openModal('bulkAssignModal');
    });

    async function prepareBulkAssign(){
      // Load available drafts
      await loadDrafts('draft');
      const images = Array.from(selectedMediaSet);
      const drafts = (draftCache || []).filter(d => d.status === 'draft').slice(0, images.length);
      const root = document.getElementById('bulkAssignPreview');
      const info = document.getElementById('bulkAssignInfo');
      if (root) root.innerHTML = '';
      if (info) info.textContent = `Assigning ${images.length} images using ${drafts.length} drafts (in order).`;
      for (let i = 0; i < images.length; i++) {
        const img = images[i];
        const draft = drafts[i];
        const cap = draft ? draft.text : '(no draft available)';
        const card = document.createElement('div');
        card.style.cssText = 'background:#121c30; border:1px solid #1e2a44; border-radius:8px; padding:8px; display:flex; flex-direction:column; gap:8px;';
        const escaped = (cap||'').replace(/</g,'&lt;');
        card.innerHTML = `
          <div style="display:flex; gap:8px; align-items:flex-start;" data-filename="${img}" data-draftid="${draft?draft.id:''}">
            <img src="/media/${encodeURIComponent(img)}" style="width:100px; height:100px; object-fit:cover; border-radius:6px; border:1px solid #334155;" onerror="this.style.display='none'">
            <div style="flex:1;">
              <div style="color:#e6e6e6; font-size:13px; font-weight:500; margin-bottom:6px;">${img}</div>
              <textarea class="bulk-cap" data-draftid="${draft?draft.id:''}" style="width:100%; min-height:84px; background:#0f172a; color:#e6e6e6; border:1px solid #1e2a44; border-radius:6px;">${escaped}</textarea>
            </div>
          </div>
        `;
        root?.appendChild(card);
      }

      // Bind Assign All
      const btnDo = document.getElementById('btnBulkAssignDo');
      if (btnDo) {
        btnDo.onclick = async () => {
          try {
            const draftsLocal = (draftCache || []).filter(d => d.status === 'draft');
            let idx = 0; let assigned = 0;
            const rootEl = document.getElementById('bulkAssignPreview');
            const caps = rootEl ? Array.from(rootEl.querySelectorAll('.bulk-cap')) : [];
            for (const img of images) {
              const d = draftsLocal[idx++];
              if (!d) break;
              // find edited caption for this draft
              const capEl = caps.find(function(el){ return el && el.getAttribute && el.getAttribute('data-draftid') === d.id; });
              const edited = capEl && 'value' in capEl ? capEl.value : d.text;
              if (edited && edited !== d.text) {
                try { await fetchJSON('/ig/caption-drafts/' + encodeURIComponent(d.id), { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: edited }) }); } catch {}
              }
              await fetchJSON('/ig/queue-with-draft', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: img, draftId: d.id }) });
              assigned++;
            }
            showToast('success', `Assigned ${assigned} posts`);
            closeModal('bulkAssignModal');
            selectedMediaSet.clear();
            updateBulkAssignButton();
            await loadStatus();
            await loadDrafts('all');
          } catch(e){ showToast('error','Bulk assign failed: '+e.message); }
        };
      }
    }

    function reloadBulkAssignMapping(){ prepareBulkAssign().catch(()=>{}); }
    
    // Library upload functionality
    async function uploadToLibrary(files) {
      const uploadProgress = document.getElementById('uploadProgress');
      const uploadProgressBar = document.getElementById('uploadProgressBar');
      
      if (uploadProgress) uploadProgress.style.display = 'block';
      
      let uploaded = 0;
      const total = files.length;
      
      for (const file of files) {
        try {
          // Validate file
          const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif', 'video/mp4', 'video/quicktime', 'video/x-msvideo'];
          if (!validTypes.includes(file.type)) {
            showToast('error', `Skipped ${file.name}: Invalid file type`);
            continue;
          }
          
          if (file.size > 100 * 1024 * 1024) {
            showToast('error', `Skipped ${file.name}: File too large (max 100MB)`);
            continue;
          }
          
          const formData = new FormData();
          formData.append('file', file);
          
          // Upload with library flag
          await fetchJSON('/ig/upload?library=true', {
            method: 'POST',
            body: formData
          });
          
          uploaded++;
          
          // Update progress
          if (uploadProgressBar) {
            uploadProgressBar.style.width = `${(uploaded / total) * 100}%`;
          }
          
          showToast('success', `Uploaded: ${file.name}`);
        } catch (e) {
          showToast('error', `Failed to upload ${file.name}: ${e.message}`);
        }
      }
      
      // Hide upload zone and refresh
      setTimeout(() => {
        const uploadZone = document.getElementById('libraryUploadZone');
        if (uploadZone) uploadZone.style.display = 'none';
        if (uploadProgress) uploadProgress.style.display = 'none';
        if (uploadProgressBar) uploadProgressBar.style.width = '0%';
        libraryUploadActive = false;
        loadSavedMedia(savedMediaPage);
      }, 1000);
    }
    
    // Upload button handler
    const btnUploadToLibrary = document.getElementById('btnUploadToLibrary');
    if (btnUploadToLibrary) {
      btnUploadToLibrary.addEventListener('click', () => {
        const uploadZone = document.getElementById('libraryUploadZone');
        if (uploadZone) {
          libraryUploadActive = !libraryUploadActive;
          uploadZone.style.display = libraryUploadActive ? 'block' : 'none';
          if (libraryUploadActive) {
            btnUploadToLibrary.textContent = '❌ Cancel Upload';
            btnUploadToLibrary.style.background = '#dc2626';
          } else {
            btnUploadToLibrary.textContent = '📤 Upload New Media';
            btnUploadToLibrary.style.background = '#2563eb';
          }
        }
      });
    }
    
    // Library upload zone handlers
    const libraryUploadZone = document.getElementById('libraryUploadZone');
    const libraryFileInput = document.getElementById('libraryFileInput');
    
    if (libraryUploadZone) {
      libraryUploadZone.addEventListener('click', () => {
        if (libraryFileInput) libraryFileInput.click();
      });
      
      libraryUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        libraryUploadZone.style.borderColor = '#60a5fa';
        libraryUploadZone.style.background = 'rgba(37, 99, 235, 0.1)';
      });
      
      libraryUploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        libraryUploadZone.style.borderColor = '#2563eb';
        libraryUploadZone.style.background = 'rgba(37, 99, 235, 0.05)';
      });
      
      libraryUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        libraryUploadZone.style.borderColor = '#2563eb';
        libraryUploadZone.style.background = 'rgba(37, 99, 235, 0.05)';
        
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
          uploadToLibrary(files);
        }
      });
    }
    
    if (libraryFileInput) {
      libraryFileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files || []);
        if (files.length > 0) {
          uploadToLibrary(files);
        }
      });
    }
    
    // Saved Media button handler
    const btnSavedMedia = document.getElementById('btnSavedMedia');
    if (btnSavedMedia) {
      btnSavedMedia.addEventListener('click', () => {
        openModal('savedMediaModal');
        loadSavedMedia(1);
      });
    }
    
    // Post Library functionality
    let postLibraryFilter = 'all';
    
    const btnPostLibrary = document.getElementById('btnPostLibrary');
    if (btnPostLibrary) {
      btnPostLibrary.addEventListener('click', () => {
        openModal('postLibraryModal');
        loadPostLibrary();
      });
    }
    
    // Post Library filter buttons
    document.querySelectorAll('.post-filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.post-filter-btn').forEach(b => {
          b.classList.remove('active');
          b.style.background = 'transparent';
          b.style.color = '#94a3b8';
          b.style.border = '1px solid #1e2a44';
        });
        btn.classList.add('active');
        btn.style.background = '#2563eb';
        btn.style.color = 'white';
        btn.style.border = 'none';
        
        postLibraryFilter = btn.dataset.filter;
        loadPostLibrary();
      });
    });
    
    // Refresh Post Library button
    document.getElementById('btnRefreshPostLibrary')?.addEventListener('click', () => {
      loadPostLibrary();
    });
    
    // Load Post Library
    async function loadPostLibrary() {
      try {
        const response = await fetchJSON('/ig/autopilot-posts');
        const posts = response.posts || [];
        
        // Filter posts
        let filteredPosts = posts;
        if (postLibraryFilter === 'scheduled') {
          filteredPosts = posts.filter(p => p.status === 'SCHEDULED');
        } else if (postLibraryFilter === 'published') {
          filteredPosts = posts.filter(p => p.status === 'PUBLISHED');
        }
        
        const grid = document.getElementById('postLibraryGrid');
        const emptyState = document.getElementById('postLibraryEmpty');
        const countEl = document.getElementById('postLibraryCount');
        
        const totalPosts = filteredPosts.length;
        const displayPosts = filteredPosts.slice(0, 50);
        if (countEl) {
          countEl.textContent = `Showing ${displayPosts.length} of ${totalPosts} autopilot posts`;
        }
        
        if (filteredPosts.length === 0) {
          if (grid) grid.style.display = 'none';
          if (emptyState) emptyState.style.display = 'block';
        } else {
          if (grid) grid.style.display = 'grid';
          if (emptyState) emptyState.style.display = 'none';
          
          if (grid) {
            grid.innerHTML = '';
            
            displayPosts.forEach(post => {
              const card = document.createElement('div');
              card.style.cssText = 'background: #121c30; border: 1px solid #1e2a44; border-radius: 8px; overflow: hidden;';
              
              // Thumbnail
              const imgWrapper = document.createElement('div');
              imgWrapper.style.cssText = 'position: relative; aspect-ratio: 1; background: #0f172a;';
              
              if (post.filename) {
                const isVideo = post.filename.match(/\.(mp4|mov|avi|webm)$/i);
                if (isVideo) {
                  imgWrapper.innerHTML = `
                    <video src="/media/${encodeURIComponent(post.filename)}" 
                           style="width: 100%; height: 100%; object-fit: cover;" 
                           muted preload="metadata"></video>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                      <span style="color: white; font-size: 18px; margin-left: 2px;">▶</span>
                    </div>
                  `;
                } else {
                  imgWrapper.innerHTML = `<img src="/media/${encodeURIComponent(post.filename)}" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
              }
              
              // Autopilot badge
              const badge = document.createElement('div');
              badge.style.cssText = 'position: absolute; top: 8px; left: 8px; padding: 4px 8px; background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; border-radius: 12px; font-size: 11px; font-weight: 500;';
              badge.textContent = '🚀 Autopilot';
              imgWrapper.appendChild(badge);
              
              // Status badge
              const statusBadge = document.createElement('div');
              const statusColor = post.status === 'PUBLISHED' ? '#22c55e' : post.status === 'SCHEDULED' ? '#3b82f6' : '#94a3b8';
              statusBadge.style.cssText = `position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: ${statusColor}; color: white; border-radius: 12px; font-size: 11px; font-weight: 500;`;
              statusBadge.textContent = post.status;
              imgWrapper.appendChild(statusBadge);
              
              // Info section
              const info = document.createElement('div');
              info.style.cssText = 'padding: 12px;';
              
              // Caption preview
              const caption = document.createElement('div');
              caption.style.cssText = 'font-size: 13px; color: #e6e6e6; margin-bottom: 8px; max-height: 40px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;';
              caption.textContent = post.caption || 'No caption';
              
              // Schedule info
              const schedule = document.createElement('div');
              schedule.style.cssText = 'font-size: 12px; color: #94a3b8; margin-bottom: 12px;';
              const dateStr = post.scheduled_at ? new Date(post.scheduled_at).toLocaleString() : 
                               post.published_at ? `Published: ${new Date(post.published_at).toLocaleString()}` : 
                               'Not scheduled';
              schedule.textContent = dateStr;
              
              // Action buttons
              const actions = document.createElement('div');
              actions.style.cssText = 'display: flex; gap: 8px;';
              
              if (post.status === 'SCHEDULED') {
                const editBtn = document.createElement('button');
                editBtn.textContent = '✏️ Edit';
                editBtn.style.cssText = 'flex: 1; padding: 6px; background: #1e2a44; color: #94a3b8; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;';
                editBtn.onclick = () => editAutopilotPost(post);
                actions.appendChild(editBtn);
              }
              
              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = '🗑 Delete';
              deleteBtn.style.cssText = 'flex: 1; padding: 6px; background: #dc2626; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;';
              deleteBtn.onclick = () => deleteAutopilotPost(post);
              actions.appendChild(deleteBtn);
              
              info.appendChild(caption);
              info.appendChild(schedule);
              info.appendChild(actions);
              
              card.appendChild(imgWrapper);
              card.appendChild(info);
              grid.appendChild(card);
            });
          }
        }
      } catch (error) {
        showToast('error', 'Failed to load post library: ' + error.message);
      }
    }
    
    // Edit autopilot post
    function editAutopilotPost(post) {
      // TODO: Implement edit functionality
      showToast('info', 'Edit functionality coming soon');
    }
    
    // Delete autopilot post
    async function deleteAutopilotPost(post) {
      if (!confirm(`Delete this autopilot post?`)) return;
      
      try {
        await fetchJSON(`/ig/posts/${encodeURIComponent(post.id)}`, { method: 'DELETE' });
        showToast('success', 'Post deleted');
        loadPostLibrary();
      } catch (error) {
        showToast('error', 'Failed to delete: ' + error.message);
      }
    }
    
    // Saved Media pagination
    const btnSavedPrev = document.getElementById('btnSavedPrev');
    if (btnSavedPrev) {
      btnSavedPrev.addEventListener('click', () => {
        if (savedMediaPage > 1) {
          loadSavedMedia(savedMediaPage - 1);
        }
      });
    }
    
    const btnSavedNext = document.getElementById('btnSavedNext');
    if (btnSavedNext) {
      btnSavedNext.addEventListener('click', () => {
        if (savedMediaPage < savedMediaPages) {
          loadSavedMedia(savedMediaPage + 1);
        }
      });
    }
    
    // Autopilot System
    let autopilotConfig = {
      enabled: false,
      postsPerDay: 3,
      times: ['10:00', '14:00', '18:00'],
      activeDays: [0, 1, 2, 3, 4, 5, 6],
      captionStyle: 'medium',
      captionCount: 100
    };
    
    let captionPool = [];
    let availableSlots = [];
    
    // Autopilot Settings Button
    document.getElementById('btnAutopilot')?.addEventListener('click', () => {
      openModal('autopilotModal');
      updateAutopilotUI();
    });
    
    // Toggle Autopilot
    document.getElementById('btnToggleAutopilot')?.addEventListener('click', async () => {
      autopilotConfig.enabled = !autopilotConfig.enabled;
      await saveAutopilotConfig();
      updateAutopilotUI();
      updateAutopilotStatus();
      
      if (autopilotConfig.enabled) {
        showToast('success', 'Autopilot enabled! New uploads will be auto-scheduled.');
        // Generate initial slots
        availableSlots = generateTimeSlots(30, autopilotConfig.times, autopilotConfig.activeDays);
      } else {
        showToast('info', 'Autopilot disabled. Manual mode active.');
      }
    });
    
    // Add Time button
    document.getElementById('btnAddAutopilotTime')?.addEventListener('click', () => {
      const timesContainer = document.getElementById('autopilotTimes');
      const newTime = document.createElement('input');
      newTime.type = 'time';
      newTime.className = 'autopilot-time';
      newTime.value = '12:00';
      newTime.style.cssText = 'padding: 8px; background: #0f172a; color: #e6e6e6; border: 1px solid #1e2a44; border-radius: 6px;';
      timesContainer?.appendChild(newTime);
    });
    
    // Generate Captions button
    document.getElementById('btnGenerateCaptions')?.addEventListener('click', async () => {
      const count = parseInt(document.getElementById('autopilotCaptionCount')?.value || '100');
      const style = document.getElementById('autopilotCaptionStyle')?.value || 'medium';
      
      const btn = document.getElementById('btnGenerateCaptions');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Generating...';
      }
      
      try {
        const response = await fetchJSON('/ig/generate-caption-pool', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            count: count,
            style: style,
            keywords: [] // Can be enhanced with keyword selection
          })
        });
        
        captionPool = response.captions || [];
        updateCaptionPoolStatus();
        showToast('success', `Generated ${response.generated} captions!`);
      } catch (error) {
        showToast('error', 'Failed to generate captions: ' + error.message);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Generate Captions';
        }
      }
    });
    
    // Save Autopilot Settings
    document.getElementById('btnSaveAutopilot')?.addEventListener('click', async () => {
      // Collect times
      const timeInputs = document.querySelectorAll('.autopilot-time');
      autopilotConfig.times = Array.from(timeInputs).map(input => input.value).filter(t => t);
      
      // Collect active days
      const dayCheckboxes = document.querySelectorAll('.autopilot-day');
      autopilotConfig.activeDays = Array.from(dayCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => parseInt(cb.dataset.day));
      
      // Get other settings
      autopilotConfig.postsPerDay = parseInt(document.getElementById('autopilotPostsPerDay')?.value || '3');
      autopilotConfig.captionStyle = document.getElementById('autopilotCaptionStyle')?.value || 'medium';
      autopilotConfig.captionCount = parseInt(document.getElementById('autopilotCaptionCount')?.value || '100');
      
      await saveAutopilotConfig();
      closeModal('autopilotModal');
      updateAutopilotStatus();
      
      // Regenerate slots if enabled
      if (autopilotConfig.enabled) {
        availableSlots = generateTimeSlots(30, autopilotConfig.times, autopilotConfig.activeDays);
      }
      
      showToast('success', 'Autopilot settings saved!');
    });
    
    // Generate time slots for the next N days
    function generateTimeSlots(days, timesPerDay, activeDays) {
      const slots = [];
      for (let d = 0; d < days; d++) {
        const date = new Date();
        date.setDate(date.getDate() + d);
        if (activeDays.includes(date.getDay())) {
          timesPerDay.forEach(time => {
            const [hours, minutes] = time.split(':').map(Number);
            const slotDate = new Date(date);
            slotDate.setHours(hours, minutes, 0, 0);
            slots.push(slotDate.toISOString());
          });
        }
      }
      return slots.sort((a, b) => new Date(a).getTime() - new Date(b).getTime());
    }
    
    // Update Autopilot UI in modal
    function updateAutopilotUI() {
      const statusText = document.getElementById('autopilotStatusText');
      const toggleBtn = document.getElementById('btnToggleAutopilot');
      
      if (autopilotConfig.enabled) {
        if (statusText) statusText.textContent = 'ON - Auto-scheduling active';
        if (toggleBtn) {
          toggleBtn.textContent = 'Turn OFF';
          toggleBtn.style.background = '#ef4444';
        }
      } else {
        if (statusText) statusText.textContent = 'OFF - Manual mode';
        if (toggleBtn) {
          toggleBtn.textContent = 'Turn ON';
          toggleBtn.style.background = '#22c55e';
        }
      }
      
      // Update form fields
      const postsPerDay = document.getElementById('autopilotPostsPerDay');
      if (postsPerDay) postsPerDay.value = autopilotConfig.postsPerDay;
      
      const captionStyle = document.getElementById('autopilotCaptionStyle');
      if (captionStyle) captionStyle.value = autopilotConfig.captionStyle;
      
      const captionCount = document.getElementById('autopilotCaptionCount');
      if (captionCount) captionCount.value = autopilotConfig.captionCount;
      
      updateCaptionPoolStatus();
    }
    
    // Update caption pool status
    function updateCaptionPoolStatus() {
      const statusEl = document.getElementById('captionPoolStatus');
      const availableCaptions = captionPool.filter(c => !c.used).length;
      if (statusEl) {
        statusEl.textContent = `${availableCaptions} / ${captionPool.length} captions available`;
      }
    }
    
    // Update dashboard autopilot status
    function updateAutopilotStatus() {
      const indicator = document.getElementById('autopilotIndicator');
      const status = document.getElementById('autopilotStatus');
      const info = document.getElementById('autopilotInfo');
      const slotsEl = document.getElementById('autopilotSlots');
      const captionsEl = document.getElementById('autopilotCaptions');
      const dropzone = document.getElementById('dropzone');
      
      if (autopilotConfig.enabled) {
        if (indicator) indicator.style.background = '#22c55e';
        if (status) status.textContent = 'Autopilot ON';
        if (info) info.textContent = `${autopilotConfig.postsPerDay} posts/day at ${autopilotConfig.times.join(', ')}`;
        
        // Update dropzone to show autopilot active
        if (dropzone) {
          dropzone.style.borderColor = '#22c55e';
          dropzone.style.position = 'relative';
          dropzone.innerHTML = `
            <div style="position: absolute; top: 8px; right: 8px; padding: 4px 12px; background: #22c55e; color: white; border-radius: 12px; font-size: 12px; font-weight: 500; z-index: 1;">
              🚀 Autopilot Active
            </div>
            <div style="padding: 20px;">
              <div>Drag & Drop images here (png, jpg, jpeg, webp, gif, mp4, mov, avi) or click to select</div>
              <div style="color: #22c55e; font-size: 12px; margin-top: 8px;">Files will be auto-scheduled to next available slot</div>
            </div>
          `;
        }
      } else {
        if (indicator) indicator.style.background = '#ef4444';
        if (status) status.textContent = 'Autopilot OFF';
        if (info) info.textContent = 'Manual mode';
        
        // Reset dropzone to normal
        if (dropzone) {
          dropzone.style.borderColor = '#2563eb';
          dropzone.style.position = 'relative';
          dropzone.innerHTML = 'Drag & Drop images here (png, jpg, jpeg, webp, gif, mp4, mov, avi) or click to select';
        }
      }
      
      const availableCaptions = captionPool.filter(c => !c.used).length;
      if (slotsEl) slotsEl.textContent = `${availableSlots.length} slots`;
      if (captionsEl) captionsEl.textContent = `${availableCaptions} captions`;
    }
    
    // Save autopilot config to backend
    async function saveAutopilotConfig() {
      try {
        await fetchJSON('/ig/autopilot-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(autopilotConfig)
        });
      } catch (error) {
        console.error('Failed to save autopilot config:', error);
      }
    }
    
    // Load autopilot config from backend
    async function loadAutopilotConfig() {
      try {
        const response = await fetchJSON('/ig/autopilot-config');
        if (response.config) {
          autopilotConfig = response.config;
        }
        if (response.captionPool) {
          captionPool = response.captionPool;
        }
        if (response.availableSlots) {
          availableSlots = response.availableSlots;
        }
        updateAutopilotStatus();
      } catch (error) {
        console.error('Failed to load autopilot config:', error);
      }
    }
    
    // Initial load
    loadStatus().catch(console.error);
    loadLogs().catch(console.error);
    loadSchedule().catch(console.error);
    loadKeywords().catch(console.error);
    loadCalendar().catch(console.error);
    loadAutopilotConfig().catch(console.error);
    // Optionally pre-load a page of history in background
    loadHistory(1).catch(()=>{});

    // Safety: also trigger on DOMContentLoaded for robustness
    window.addEventListener('DOMContentLoaded', function(){
      try { loadCalendar(); } catch (e) { /* ignore */ }
    });

    // Delegated click handlers as fallback for dynamic DOM
    document.addEventListener('click', function(e){
      var t = e.target || null;
      if (!t) return;
      // Fallback for Generate Drafts button
      // (header button id is #btnGenerateDrafts)
      if ((t.closest && t.closest('#btnGenerateDrafts'))) {
        try { openDraftsModal(); } catch (e) {}
      }
    });
  </script>
</body>
</html>
